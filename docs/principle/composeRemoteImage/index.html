<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">å¦‚ä½•ä¸ºCompose Imageæä¾›ç½‘ç»œå›¾ç‰‡åŠ è½½æ”¯æŒ | ä½ å¥½ Compose</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://jetpackcompose.cn/docs/principle/composeRemoteImage"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="å¦‚ä½•ä¸ºCompose Imageæä¾›ç½‘ç»œå›¾ç‰‡åŠ è½½æ”¯æŒ | ä½ å¥½ Compose"><meta data-react-helmet="true" name="description" content="å‰è¨€"><meta data-react-helmet="true" property="og:description" content="å‰è¨€"><link data-react-helmet="true" rel="icon" href="/img/logo.svg"><link data-react-helmet="true" rel="canonical" href="https://jetpackcompose.cn/docs/principle/composeRemoteImage"><link data-react-helmet="true" rel="alternate" href="https://jetpackcompose.cn/docs/principle/composeRemoteImage" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://jetpackcompose.cn/docs/principle/composeRemoteImage" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.cba56bc1.css">
<link rel="preload" href="/assets/js/runtime~main.ae8d57c9.js" as="script">
<link rel="preload" href="/assets/js/main.50fd7d2b.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Jetpack Compose åšç‰©é¦†</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/docs/open-source-project/compose-douban">å¼€æºé¡¹ç›®</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/compose-museum/jetpack-compose-book" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ğŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ğŸŒ</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">å†™åœ¨å¼€å¤´</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/å…¥é—¨">å…¥é—¨</a><button aria-label="Toggle the collapsible sidebar category &#x27;å…¥é—¨&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation">å®‰è£…æˆ–æ›´æ–° Android Studio</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial">åˆè¯† Jetpack Compose</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/elements/alertdialog">åŸºç¡€ç»„ä»¶</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/layout/box">å¸ƒå±€ç»„ä»¶</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/è®¾è®¡">è®¾è®¡</a><button aria-label="Toggle the collapsible sidebar category &#x27;è®¾è®¡&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/åŠ¨ç”»animation">åŠ¨ç”»ï¼ˆAnimationï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;åŠ¨ç”»ï¼ˆAnimationï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/ä¸»é¢˜theming">ä¸»é¢˜ï¼ˆThemingï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;ä¸»é¢˜ï¼ˆThemingï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/æ‰‹åŠ¿gesture">æ‰‹åŠ¿ï¼ˆGestureï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;æ‰‹åŠ¿ï¼ˆGestureï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/åˆ—è¡¨lists">åˆ—è¡¨ï¼ˆListsï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;åˆ—è¡¨ï¼ˆListsï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/å›¾å½¢graphics">å›¾å½¢ï¼ˆGraphicsï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;å›¾å½¢ï¼ˆGraphicsï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/resources">èµ„æº</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/docs/category/æŠ€æœ¯åŸç†">æŠ€æœ¯åŸç†</a><button aria-label="Toggle the collapsible sidebar category &#x27;æŠ€æœ¯åŸç†&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/recompositionScope">äº†è§£ Compose çš„é‡ç»„ä½œç”¨åŸŸ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/snapshot">é€è¿‡ Snapshot çœ‹é‡ç»„</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/recomposeWorkingPrinciple">é‡ç»„çš„å·¥ä½œæµç¨‹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/gapBuffer">Compose è¿è¡ŒåŸç†ä¸ GapBuffer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/modifierStructure">å›¾è§£ Modifier</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/composeAnnotation">Compose æ³¨è§£åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/principle/composeRemoteImage">å¦‚ä½•ä¸ºCompose Imageæä¾›ç½‘ç»œå›¾ç‰‡åŠ è½½æ”¯æŒ</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>å¦‚ä½•ä¸ºCompose Imageæä¾›ç½‘ç»œå›¾ç‰‡åŠ è½½æ”¯æŒ</h1></header><h2 class="anchor anchorWithStickyNavbar_mojV" id="å‰è¨€">å‰è¨€<a class="hash-link" href="#å‰è¨€" title="Direct link to heading">â€‹</a></h2><p>å¦‚ä½•ä¸ºCompose Imageæä¾›ç½‘ç»œå›¾ç‰‡åŠ è½½æ”¯æŒï¼Ÿç›®å‰ï¼ˆCompose 1.0.5ï¼‰æœ€å¥½çš„é€‰æ‹©æ˜¯ä½¿ç”¨å›¾ç‰‡æ¡†æ¶Coilï¼ŒCoilå¯¹Jetpack Composeç›¸å…³çš„æ”¯æŒæ–‡æ¡£<a href="https://coil-kt.github.io/coil/compose/" target="_blank" rel="noopener noreferrer">åœ¨è¿™</a>ã€‚</p><p>Composeå†…çš„Imageç»„ä»¶ç±»ä¼¼äºImageViewï¼Œä»…æ”¯æŒä»æœ¬åœ°åŠ è½½å›¾ç‰‡èµ„æºï¼Œè¦æƒ³ä»ç½‘ç»œä¸­è·å–å›¾ç‰‡å¹¶åŠ è½½ï¼Œæˆ‘ä»¬é¦–å…ˆå°±å¾—è¦ä½¿ç”¨èƒ½å¤Ÿå¤„ç†ç½‘ç»œè¯·æ±‚çš„æ¡†æ¶ï¼Œå°†è¿œç¨‹å›¾ç‰‡èµ„æºè½½å…¥åˆ°æœ¬åœ°æ‰è¡Œã€‚ç›®å‰ä¸»æµçš„å›¾ç‰‡åŠ è½½æ¡†æ¶Picassoã€Glideã€Coilç­‰ï¼Œå®ƒä»¬æ›´å¤šé¢å¯¹çš„ä»æ˜¯ä¼ ç»Ÿçš„Viewç³»ç»Ÿä¸‹ï¼Œå°†å›¾ç‰‡åŠ è½½åˆ°ImageViewä¸­å¹¶æ˜¾ç¤ºè¿™æ ·çš„åº”ç”¨åœºæ™¯ï¼Œè€Œä¸æ˜¯ä¸ºComposeé‡èº«æ‰“é€ çš„ï¼ŒåŸºäºæ­¤ï¼ŒAccompaniståº“æ›¾æä¾›äº†ä¸€äº›å›¾ç‰‡åŠ è½½æ¡†æ¶çš„æ‰©å±•åº“ï¼Œä¸ºComposeçš„Imageæ˜¾ç¤ºç½‘ç»œå›¾ç‰‡è¿›è¡Œç®€ä¾¿æ”¯æŒã€‚æ—¶è¿‡å¢ƒè¿ï¼Œåæ¥Coilä¸ºImageåŠ è½½å›¾ç‰‡æä¾›äº†ç›¸å…³æ”¯æŒï¼Œæ•…Accompanistä»¥å‰å…³äºå›¾ç‰‡åŠ è½½æ¡†æ¶æ‰©å±•çš„ä¾èµ–éƒ½è¢«åºŸå¼ƒå¹¶ä¸æ¨èä½¿ç”¨äº†ã€‚ï¼ˆPicassoå¯èƒ½åœ¨é•¿æœŸå†…éƒ½ä¸ä¼šæ”¯æŒCompose Imageï¼Œ<a href="https://github.com/square/picasso/issues/2203" target="_blank" rel="noopener noreferrer">è¯¦æƒ…</a>ï¼‰</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ†æAccompanistæ›¾ç»æ˜¯å¦‚ä½•å¯¹å›¾ç‰‡æ¡†æ¶åšæ‰©å±•é€‚é…ï¼Œä½¿ä¹‹èƒ½å¤Ÿä¸Composeé…åˆå·¥ä½œçš„ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="picassoin-version-062">Picasso(in version 0.6.2)<a class="hash-link" href="#picassoin-version-062" title="Direct link to heading">â€‹</a></h2><p>Accompaniståœ¨0.3.0ç‰ˆæœ¬å°±æä¾›äº†Picassoçš„æ”¯æŒï¼Œä¸è¿‡ï¼Œåœ¨ç‰ˆæœ¬0.7.0è¯¥é›†æˆè¢«ç§»é™¤ï¼ˆç›¸å…³çš„pullå‚è§<a href="https://github.com/google/accompanist/pull/253" target="_blank" rel="noopener noreferrer">https://github.com/google/accompanist/pull/253</a>ï¼‰</p><p>åœ¨0.6.2ç‰ˆæœ¬ä¸­ï¼Œæƒ³è¦åŠ è½½ç½‘ç»œå›¾ç‰‡ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">PicassoImage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data = &quot;http://...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier = Modifier.size(50.dp),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) { imageLoadState -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    when(imageLoadState) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CoilImage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data = &quot;https://i.imgur.com/StXm8nf.jpg&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contentDescription = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onRequestCompleted = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        println(&quot;LoadingCoilImage onRequestCompleted $it&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contentScale = ContentScale.Crop,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier = Modifier.fillMaxWidth(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>åœ¨version 0.6.2ä¸­ï¼ŒåŠ è½½è¿œç¨‹å›¾ç‰‡çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸“ç”¨çš„<code>Image</code>ç»„ä»¶ï¼Œä½¿ç”¨Picassoæ¡†æ¶çš„è°ƒç”¨<code>PicassoImage</code>ï¼Œä½¿ç”¨Coilçš„åˆ™è°ƒç”¨<code>CoilImage</code>ï¼Œç­‰ç­‰ã€‚å®ƒä»¬éƒ½ä¾èµ–äºä¸€ä¸ªimageloader-coreçš„æ ¸å¿ƒåº“æ¥è¿›è¡Œå›¾ç‰‡åŠ è½½ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³è±¡è¿™ä¸ªåŠ è½½å›¾ç‰‡çš„æ–¹æ³•ï¼Œä¸ºäº†ç³…åˆå„ç±»æ¡†æ¶ï¼Œè‚¯å®šè¦ç”¨ä¸å°‘æ³›å‹ï¼Œäº‹å®ä¸Šå®ƒé•¿ä¸‹é¢è¿™æ ·ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun &lt;R : Any, TR : Any&gt; ImageLoad(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request: R,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    executeRequest: suspend (TR) -&gt; ImageLoadState,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier: Modifier = Modifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestKey: Any = request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transformRequestForSize: (R, IntSize) -&gt; TR?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldRefetchOnSizeChange: (currentResult: ImageLoadState, size: IntSize) -&gt; Boolean = DefaultRefetchOnSizeChangeLambda,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onRequestCompleted: (ImageLoadState) -&gt; Unit = EmptyRequestCompleteLambda,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content: @Composable BoxScope.(imageLoadState: ImageLoadState) -&gt; Unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æ³›å‹Rä»£è¡¨è¯·æ±‚çš„å€¼ï¼Œè¿™ä¸ªå€¼ä¹‹æ‰€ä»¥æ˜¯æ³›å‹ï¼Œæ˜¯å› ä¸ºå®é™…ä¸Šå„ç§æ¡†æ¶éƒ½æ”¯æŒå¤šç±»å‹çš„å›¾ç‰‡åŠ è½½è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚å¯èƒ½æ˜¯åŸºäºä¸€ä¸ªURLçš„Stringï¼Œä¹Ÿå¯èƒ½å•çº¯æ˜¯ä¸€ä¸ªresourceçš„idï¼Œæˆ–è€…å°±æ˜¯ä¸€ä¸ª<code>Bitmap</code>ï¼Œç­‰ç­‰ã€‚æ³›å‹TRä»£è¡¨äº†ä¸åŒå›¾ç‰‡æ¡†æ¶å†…æ”¶é›†æœ¬æ¬¡å›¾ç‰‡è¯·æ±‚ä¿¡æ¯çš„å®ä½“ç±»ï¼ˆæˆ–è€…æ˜¯Builderï¼‰ï¼Œåœ¨Picassoä¸­è¿™ä¸ªç±»å«<code>RequestCreator</code>ï¼Œåœ¨Glideä¸­è¿™ä¸ªç±»å«<code>RequestBuilder</code>ã€‚</p><p>æˆ‘ä»¬ç»§ç»­è§‚å¯Ÿå®ƒçš„å®ç°ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun &lt;R : Any, TR : Any&gt; ImageLoad(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request: R,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    executeRequest: suspend (TR) -&gt; ImageLoadState,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier: Modifier = Modifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestKey: Any = request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transformRequestForSize: (R, IntSize) -&gt; TR?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldRefetchOnSizeChange: (currentResult: ImageLoadState, size: IntSize) -&gt; Boolean = DefaultRefetchOnSizeChangeLambda,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onRequestCompleted: (ImageLoadState) -&gt; Unit = EmptyRequestCompleteLambda,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content: @Composable BoxScope.(imageLoadState: ImageLoadState) -&gt; Unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä¸‰ä¸ªrememberUpdatedStateï¼Œç›®çš„æ˜¯ä¸ºäº†é¿å…æ›´æ”¹åé‡ç»„</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val updatedOnRequestCompleted by rememberUpdatedState(onRequestCompleted)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val updatedTransformRequestForSize by rememberUpdatedState(transformRequestForSize)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val updatedExecuteRequest by rememberUpdatedState(executeRequest)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™ä¸ªstateæ‹¿æ¥ç¼“å­˜æ§ä»¶å¤§å°ï¼Œå› ä¸ºæ§ä»¶å¤§å°è¦ç­‰åˆ°Composeå†…å®¹ä¼ å…¥constraintsæ‰èƒ½ç¡®å®š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var requestSize by remember(requestKey) { mutableStateOf&lt;IntSize?&gt;(null) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é‡ç‚¹ï¼Œè¿™é‡Œä½¿ç”¨produceStateå°†executeRequestè¿”å›çš„éComposeçŠ¶æ€è½¬æ¢ä¸ºä¸€ä¸ªState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä¹‹æ‰€ä»¥è¿åŠ è½½å›¾ç‰‡çš„è¿‡ç¨‹éƒ½æŠ½è±¡æˆä¸€ä¸ªå«executeRequestçš„lambdaï¼Œè¿˜æ˜¯å› ä¸ºè¦ç³…åˆå¤šä¸ªæ¡†æ¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val loadState by produceState&lt;ImageLoadState&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        initialValue = ImageLoadState.Loading,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key1 = requestKey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key2 = requestSize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // valueä¸€å¼€å§‹è‚¯å®šè¢«èµ‹å€¼ä¸ºImageLoadState.Loadingï¼Œå› ä¸ºrequestSizeä¸ºç©ºã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å½“requestSizeè¢«èµ‹å€¼åï¼Œé¦–å…ˆå°†å¼€å§‹æ‰§è¡ŒtransformRequestForSizeè¿™ä¸ªlambda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¼ å…¥åŸæ¥çš„requestå’Œæ–°è·å¾—çš„sizeï¼Œè¦æ±‚è¿”å›ä¸€ä¸ªç±»ä¼¼RequestBuilderçš„ç»“æœ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value = requestSize?.let { updatedTransformRequestForSize(request, it) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ?.let { transformedRequest -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   // è¿™é‡Œä¼ å…¥åˆšæ‰çš„RequestBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å‘èµ·å›¾ç‰‡åŠ è½½è¯·æ±‚ï¼Œè¿™é‡Œå¯èƒ½ä¼šæŒ‚èµ·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    updatedExecuteRequest(transformedRequest)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (e: CancellationException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // We specifically don&#x27;t do anything for the request coroutine being</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // cancelled: https://github.com/google/accompanist/issues/217</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæˆ‘ä»¬å“åº”äº†åç¨‹çš„CancellationExceptionï¼Œè®©ImageLoadStateå˜æˆäº†Error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æœ‰å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œå› ä¸ºå¦‚æœå–æ¶ˆçš„åç¨‹åœ¨æ–°åç¨‹å®Œæˆåæ‰§è¡Œï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä¼šå¯¼è‡´æ–°çš„å›¾ç‰‡çŠ¶æ€ï¼ˆSuccessï¼‰è¢«ä¸Šæ¬¡å–æ¶ˆçš„ç»“æœï¼ˆErrorï¼‰è¦†ç›–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (e: Error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Re-throw all Errors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (e: IllegalStateException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Re-throw all IllegalStateExceptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (t: Throwable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Anything else, we wrap in a Error state instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // é™¤äº†CancellationExceptionã€Errorã€IllegalStateExceptionä¹‹å¤–ï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å…¶ä½™çš„é”™è¯¯å°†ä¼šä»¤çŠ¶æ€è½¬å˜ä¸ºError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ImageLoadState.Error(painter = null, throwable = t)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // alsoå†…ï¼ŒåŠ è½½å®Œæˆï¼Œå›è°ƒonRequestCompleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }.also(updatedOnRequestCompleted)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } ?: ImageLoadState.Loading</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BoxWithConstraints(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modifier = modifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        propagateMinConstraints = true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val size = IntSize(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            width = if (constraints.hasBoundedWidth) constraints.maxWidth else -1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            height = if (constraints.hasBoundedHeight) constraints.maxHeight else -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (requestSize == null ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (requestSize != size &amp;&amp; shouldRefetchOnSizeChange(loadState, size))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requestSize = size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content(loadState)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>ImageLoad</code>çš„æ€è·¯æ¸…æ™°æ˜äº†ï¼šè°ƒç”¨æ–¹å‘Šè¯‰å®ƒå¦‚ä½•buildä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶åœ¨ä½¿ç”¨å›¾ç‰‡æ¡†æ¶çš„è¿‡ç¨‹ä¸­äº§ç”Ÿ<code>ImageLoadState</code>çŠ¶æ€ï¼Œå®ƒä¼šæŠŠ<code>ImageLoadState</code>è½¬æ¢ä¸ºå¯ä»¥è§‚å¯Ÿçš„<code>State&lt;ImageLoadState&gt;</code>ã€‚</p><p>ç›´æ¥ä½¿ç”¨é€šç”¨å®ç°çš„ç¼ºç‚¹åœ¨äºä¼šäº§ç”Ÿå¾ˆå¤šæ¨¡æ¿ä»£ç ï¼Œå¯ä»¥åŸºäºé€šç”¨å®ç°è¿›è¡Œæ›´ç®€æ´çš„å°è£…ï¼Œæˆ‘ä»¬ä»¥ç‰¹å®šçš„<code>PicassoImage</code>çš„å®ç°ä¸ºä¾‹è¿›è¡Œåˆ†æï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// è¿™ä¸ªAPIå°è£…æ›´å½»åº•ï¼Œä¸éœ€è¦å†™when(state)ï¼Œç›´æ¥åœ¨å‡½æ•°ä¸­ä¼ å…¥errorã€loadingçš„å†…å®¹å³å¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun PicassoImage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data: Any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contentDescription: String?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier: Modifier = Modifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alignment: Alignment = Alignment.Center,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contentScale: ContentScale = ContentScale.Fit,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    colorFilter: ColorFilter? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fadeIn: Boolean = false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    picasso: Picasso = LocalPicasso.current,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestBuilder: (RequestCreator.(size: IntSize) -&gt; RequestCreator)? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldRefetchOnSizeChange: (currentResult: ImageLoadState, size: IntSize) -&gt; Boolean = DefaultRefetchOnSizeChangeLambda,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onRequestCompleted: (ImageLoadState) -&gt; Unit = EmptyRequestCompleteLambda,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error: @Composable (BoxScope.(ImageLoadState.Error) -&gt; Unit)? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loading: @Composable (BoxScope.() -&gt; Unit)? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PicassoImage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data = data,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modifier = modifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestBuilder = requestBuilder,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        picasso = picasso,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shouldRefetchOnSizeChange = shouldRefetchOnSizeChange,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        onRequestCompleted = onRequestCompleted,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) { imageState -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        when (imageState) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            is ImageLoadState.Success -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // MaterialLoadingImageæ˜¯0.6.2ç‰ˆæœ¬ä¸­å­˜åœ¨çš„ä¸€ä¸ªå®ç°fadeInæ•ˆæœçš„æ§ä»¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // åŸç†æ˜¯ä½¿ç”¨ComposeåŠ¨ç”»ä¸­çš„Transitionæ‰˜ç®¡ä¸‰ä¸ªåŠ¨ç”»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // alpha(é€æ˜åº¦),brightness(äº®åº¦),saturation(é¥±å’Œåº¦), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // åŒæ—¶ä¿®æ”¹ä¼ å…¥Imageå†…çš„colorFliterçš„è¿™ä¸‰ä¸ªå€¼ï¼Œä»è€Œå®ç°æ¸å…¥æ•ˆæœ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                MaterialLoadingImage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = imageState,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    contentDescription = contentDescription,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    fadeInEnabled = fadeIn,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    alignment = alignment,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    contentScale = contentScale,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    colorFilter = colorFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            is ImageLoadState.Error -&gt; if (error != null) error(imageState)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ImageLoadState.Loading -&gt; if (loading != null) loading()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ImageLoadState.Empty -&gt; Unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun PicassoImage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data: Any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier: Modifier = Modifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    picasso: Picasso = LocalPicasso.current,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestBuilder: (RequestCreator.(size: IntSize) -&gt; RequestCreator)? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldRefetchOnSizeChange: (currentResult: ImageLoadState, size: IntSize) -&gt; Boolean = DefaultRefetchOnSizeChangeLambda,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onRequestCompleted: (ImageLoadState) -&gt; Unit = EmptyRequestCompleteLambda,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content: @Composable BoxScope.(imageLoadState: ImageLoadState) -&gt; Unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ImageLoad(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        request = data.toRequestCreator(picasso),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestKey = data, // Picasso RequestCreator doesn&#x27;t support equality so we use the data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        executeRequest = { r -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @OptIn(ExperimentalCoroutinesApi::class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            suspendCancellableCoroutine { cont -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // åˆå§‹åŒ–äº†ä¸€ä¸ªTargetï¼Œè¿™ä¸ªTargetç”¨æ¥è·å–å›¾ç‰‡åŠ è½½ç»“æœ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                val target = object : com.squareup.picasso.Target {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    override fun onBitmapLoaded(bitmap: Bitmap, from: Picasso.LoadedFrom) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        val state = ImageLoadState.Success(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            painter = BitmapPainter(bitmap.asImageBitmap()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            source = from.toDataSource()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // åç¨‹æ¢å¤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cont.resume(state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // Not much we can do here. Ignore this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    override fun onBitmapFailed(exception: Exception, errorDrawable: Drawable?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        val state = ImageLoadState.Error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            throwable = exception,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            painter = errorDrawable?.toPainter(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // åç¨‹æ¢å¤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cont.resume(state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // Not much we can do here. Ignore this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    override fun onPrepareLoad(placeholder: Drawable?) = Unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cont.invokeOnCancellation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å–æ¶ˆå›¾ç‰‡åŠ è½½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    picasso.cancelRequest(target)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Now kick off the image load into our target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                r.into(target)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transformRequestForSize = { r, size -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val sizedRequest = when {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å¦‚æœå°ºå¯¸åŒ…å«æœªæŒ‡å®šå°ºå¯¸çš„å°ºå¯¸ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨Coilè¯·æ±‚ä¸­æŒ‡å®šå°ºå¯¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                size.width &lt; 0 || size.height &lt; 0 -&gt; r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                size != IntSize.Zero -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    r.resize(size.width, size.height)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .centerInside()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .onlyScaleDown()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Otherwise we have a zero size, so no point executing a request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æœªè·å¾—sizeï¼Œå› æ­¤æš‚æ—¶æ— æ³•ç”Ÿæˆè¯·æ±‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®å‚æ•°æ¥buildè¯·æ±‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (sizedRequest != null &amp;&amp; requestBuilder != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // If we have a transformed request and builder, let it run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                requestBuilder(sizedRequest, size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Otherwise we just return the sizedRequest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sizedRequest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shouldRefetchOnSizeChange = shouldRefetchOnSizeChange,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        onRequestCompleted = onRequestCompleted,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modifier = modifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content = content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ç°åœ¨è®©æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨0.6.2ç‰ˆæœ¬ï¼Œå®ç°ç½‘ç»œå›¾ç‰‡åŠ è½½çš„é›†æˆåº“æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>å›¾ç‰‡åŠ è½½ï¼šä½¿ç”¨<code>Target</code>å›è°ƒè·å–åŠ è½½çš„ç»“æœï¼ˆå„ä¸ªæ¡†æ¶éƒ½æœ‰ç±»ä¼¼çš„æŠ½è±¡çš„<code>Target</code>è€Œä¸æ˜¯é™åˆ¶ç›®æ ‡å¿…é¡»æ˜¯<code>ImageView</code>ï¼‰ã€‚ç»“æœè¿”å›çš„è¿‡ç¨‹æ˜¯é˜»å¡å¼ï¼Œåç¨‹å°†åœ¨<code>produceState</code>å†…æ‰§è¡Œåˆ°<code> updatedExecuteRequest(transformedRequest)</code>åæŒ‚èµ·ï¼Œç›´åˆ°è¿™ä¸ªlambdaè¿”å›ç»“æœï¼ŒStateçš„å€¼å°†ä¼šåœ¨ç»“æœè¿”å›åäº§ç”Ÿå˜åŒ–ã€‚å½“ç„¶ï¼Œå¦‚æœåç¨‹è¢«å–æ¶ˆï¼ŒPicassoä¹Ÿä¼šå–æ¶ˆåŠ è½½åˆ°<code>Target</code>é‚£ä¸ªå›¾ç‰‡è¯·æ±‚ã€‚</li><li>å›¾ç‰‡å¤§å°çº¦æŸï¼šä¾èµ–äº<code>BoxWithConstraints</code>è·å¾—çš„çº¦æŸå¤§å°ã€‚</li><li>æ¸å…¥åŠ¨ç”»å®ç°ï¼šä½¿ç”¨åŠ¨ç”»API <code>Transition </code>å¯¹<code>ColorFliter</code>çš„alpha,brightness,saturationè¿›è¡ŒåŠ¨æ€ä¿®æ”¹ï¼Œä»è€Œå®ç°æ¸å…¥åŠ¨ç”»ã€‚</li><li>loadingå ä½å›¾ã€erroræ˜¾ç¤ºç­‰ï¼šä¾èµ–äºç”¨æˆ·ä¼ å…¥çš„<code>@Composable</code>å†…å®¹.æ ¹æ®<code>produceState</code>ç”Ÿæˆçš„çŠ¶æ€ï¼Œ<code>PicassoImage</code>å†…æ˜¾ç¤ºçš„<code>@Composable</code>å†…å®¹ä¼šåŠ¨æ€å˜åŒ–ã€‚</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="glidein-version-0130">Glide(in version 0.13.0)<a class="hash-link" href="#glidein-version-0130" title="Direct link to heading">â€‹</a></h2><p>0.3.0ç‰ˆæœ¬è¯ç”Ÿäº2020å¹´10æœˆä»½ï¼Œè€Œå½“æ—¶é—´æ¥åˆ°äº†2021å¹´4æœˆï¼ŒAccompanistå‘å¸ƒ0.8.0ç‰ˆæœ¬ï¼ŒCoil å’Œ Glide é›†æˆåº“è¿›è¡Œäº†å¤§è§„æ¨¡çš„é‡æ„ã€‚ä¸Šé¢æåˆ°çš„ç±»ä¼¼äº<code>CoilImage()</code>å’Œ<code>GlideImage()</code>APIéƒ½å·²ç»è¢«å¼ƒç”¨äº†ã€‚</p><p>ä»¥ä¸‹å¯¹Glideé›†æˆåº“çš„åˆ†æåŸºäºç‰ˆæœ¬0.13.0çš„ä»£ç ã€‚</p><p>å¦‚æœåœ¨0.13.0ç‰ˆæœ¬æƒ³è¦åŠ è½½è¿œç¨‹å›¾ç‰‡ï¼Œæˆ–è®¸ä½ ä¼šå†™å‡ºä»¥ä¸‹çš„ä»£ç ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Image(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    painter = rememberGlidePainter(request = &quot;http://...&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contentDescription = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æ–°çš„APIä¸å†éœ€è¦ä¸“é—¨çš„<code>Image</code>ç»„ä»¶ï¼Œè€Œæ˜¯ä½¿ç”¨<code>Painter</code>è¿™ç§æ¦‚å¿µæ¥è¡¨ç°åŠ è½½çš„ç»“æœã€‚æ–°çš„APIå¯¹æ€§èƒ½çš„æå‡ä¼¼ä¹æœ‰æ‰€æå‡ï¼šComposeå†…å®¹é‡ç»„åï¼Œéœ€è¦é‡ç»˜çš„ä¸å†æ˜¯ä¸åŒçš„Loadingç»„ä»¶æˆ–Successç»„ä»¶ï¼Œç°åœ¨æ ¸å¿ƒç»„ä»¶ä¸€å®šæ˜¯ä¸€ä¸ª<code>Image</code>ï¼ŒéšåŠ è½½çŠ¶æ€å˜åŒ–çš„åªä¸è¿‡æ˜¯Imageå†…ç»˜åˆ¶çš„å†…å®¹è€Œå·²ï¼Œé‡ç»˜èŒƒå›´æœ‰æ‰€ç¼©å°ã€‚è¿™å¾ˆç¬¦åˆæˆ‘ä»¬å¯¹<code>ImageView</code>çš„æƒ³è±¡ï¼šåœ¨åŠ è½½çš„æ—¶å€™æ˜¾ç¤ºä¸€å¼ placeholderå ä½å›¾ï¼ŒæˆåŠŸæ˜¾ç¤ºæœ€ç»ˆç»“æœï¼Œå¦åˆ™æ˜¾ç¤ºerrorå›¾ç‰‡ï¼Œè€Œplaceholderå’Œerroréƒ½å¯ä»¥å‘èµ·å›¾ç‰‡åŠ è½½è¯·æ±‚çš„æ—¶å€™è®¾ç½®ã€‚</p><p>Painteræ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„æ¦‚å¿µï¼Ÿæˆ‘ä»¬å¯ä»¥å…ˆçœ‹ä¸€ä¸‹ç±»æ³¨é‡Šæ˜¯æ€ä¹ˆä»‹ç»å®ƒçš„ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* å¯¹å¯ä»¥ç”»å‡ºæ¥çš„ä¸œè¥¿çš„æŠ½è±¡ã€‚é™¤äº†èƒ½å¤Ÿç»˜åˆ¶åˆ°æŒ‡å®šçš„æœ‰ç•ŒåŒºåŸŸå¤–ï¼ŒPainterè¿˜æä¾›äº†ä¸€äº›é«˜çº§æœºåˆ¶ï¼Œæ¶ˆè´¹è€…å¯ä»¥ä½¿ç”¨</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* è¿™äº›æœºåˆ¶æ¥é…ç½®å†…å®¹çš„ç»˜åˆ¶æ–¹å¼ã€‚å…¶ä¸­åŒ…æ‹¬alphaã€ColorFilterå’ŒRTL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* å®ç°åº”è¯¥æä¾›ä¸€ä¸ªæœ‰æ„ä¹‰çš„equalsæ–¹æ³•æ¥æ¯”è¾ƒä¸åŒPainterå­ç±»çš„å€¼ï¼Œè€Œä¸ä»…ä»…ä¾èµ–äºå¼•ç”¨ç›¸ç­‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">abstract class Painter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract fun DrawScope.onDraw()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æè¿°çœ‹èµ·æ¥æœ‰ç‚¹åƒ<code>Drawable</code>ï¼Œä½†å®é™…ä¸Š<code>Drawable</code>æ¯”<code>Painter</code>æ›´åŠ å¤æ‚ä¸€äº›ï¼Œé™¤äº†ä¸Šè¿°çš„alphaã€ColorFilterã€LayoutDirectionä¹‹å¤–ï¼Œ<code>Drawable</code>è¿˜å…·æœ‰åŠ¨ç”»Callbackã€Levelã€Hotspotç­‰å±æ€§ã€‚<code>DrawScope.onDraw()</code>æ–¹æ³•ç±»ä¼¼äº<code>Drawable</code>çš„<code>draw(Canvas canvas)</code>ã€‚</p><p>ç»§ç»­è§‚å¯Ÿ<code>rememberGlidePainter</code>çš„å…·ä½“å®ç°ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun rememberGlidePainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request: Any?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestManager: RequestManager = GlidePainterDefaults.defaultRequestManager(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldRefetchOnSizeChange: ShouldRefetchOnSizeChange = ShouldRefetchOnSizeChange { _, _ -&gt; false },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ³¨æ„è¿™é‡Œçš„requestBuilderï¼ŒåŠ è½½çš„ç»“æœç±»å‹å·²ç»è¢«å›ºå®šä¸ºdrawable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestBuilder: (RequestBuilder&lt;Drawable&gt;.(size: IntSize) -&gt; RequestBuilder&lt;Drawable&gt;)? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ–°çš„APIä¹Ÿèƒ½å¼€å¯fadeInæ•ˆæœ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fadeIn: Boolean = false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fadeInDurationMs: Int = LoadPainterDefaults.FadeInTransitionDuration,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ˜¯ä¸æ˜¯å¾ˆç–‘æƒ‘ä¸ºä»€ä¹ˆè¿™é‡Œæœ‰ä¸ªå ä½å›¾idçš„å‚æ•°ï¼ŸGlideæœ¬èº«å°±æ”¯æŒå ä½å›¾è®¾ç½®ï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åœ¨Build Requestçš„æ—¶å€™è®¾ç½®ä¸å°±è¡Œäº†å—ï¼Ÿå…¶å®è¿™ä¸ªå‚æ•°æ˜¯ç»™Composeé¢„è§ˆæ¨¡å¼ç”¨çš„</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @DrawableRes previewPlaceholder: Int = 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): LoadPainter&lt;Any&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // GlideLoaderæ˜¯åŠ è½½é€»è¾‘å®ç°ç±»ï¼Œç¨åå±•ç¤º</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val glideLoader = remember {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GlideLoader(requestManager, requestBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }.apply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œçš„é€»è¾‘å¹¶ä¸æ˜¯å¤šä½™çš„ï¼Œè¦çŸ¥é“å¦‚æœkeyæ²¡æœ‰å˜åŒ–ï¼Œrememberå‡½æ•°ä¼šç›´æ¥è¿”å›ä¸Šæ¬¡è®¡ç®—çš„ç»“æœï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œæƒ³è¡¨è¾¾çš„æ˜¯ï¼Œå¯¹ä¸Šæ¬¡çš„ç»“æœè°ƒç”¨applyï¼Œæ›´æ–°requestManagerå’ŒrequestBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.requestManager = requestManager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.requestBuilder = requestBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // rememberLoadPainterä½äºä¹‹å‰æ‰€è¯´çš„imageloading-coreçš„æ ¸å¿ƒåº“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åœ¨0.13.0ç‰ˆæœ¬Coilå’ŒGlideéƒ½ç”¨åˆ°è¿™ä¸ªåº“æ¥è·å–LoadPainter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return rememberLoadPainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loader = glideLoader,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        request = checkData(request),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shouldRefetchOnSizeChange = shouldRefetchOnSizeChange,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fadeIn = fadeIn,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fadeInDurationMs = fadeInDurationMs,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        previewPlaceholder = previewPlaceholder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// checkDataæ£€æŸ¥äº†requestçš„ç±»å‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun checkData(data: Any?): Any? {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    when (data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        is Drawable -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw IllegalArgumentException(....)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        is ImageBitmap -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw IllegalArgumentException(....)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        is ImageVector -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw IllegalArgumentException(....)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        is Painter -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw IllegalArgumentException(....)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>imageloading-coreè¿™æ¬¡å¦‚ä½•æŠ½è±¡å›¾ç‰‡åŠ è½½è¡Œä¸ºï¼Ÿæˆ‘ä»¬å…ˆè§‚å¯Ÿä¸€ä¸‹<code>rememberLoadPainter</code>çš„å‚æ•°åˆ—è¡¨ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun &lt;R&gt; rememberLoadPainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loader: Loader&lt;R&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request: R?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldRefetchOnSizeChange: ShouldRefetchOnSizeChange,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fadeIn: Boolean = false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fadeInDurationMs: Int = LoadPainterDefaults.FadeInTransitionDuration,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @DrawableRes previewPlaceholder: Int = 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): LoadPainter&lt;R&gt; {...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Stable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun interface Loader&lt;R&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun load(request: R, size: IntSize): Flow&lt;ImageLoadState&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ä¸0.6.2ç‰ˆæœ¬ä¸åŒï¼ŒåŠ è½½é€»è¾‘å®ç°ç±»éœ€è¦è¿”å›ä¸€ä¸ªçŠ¶æ€æµ<code>Flow&lt;ImageLoadState&gt;</code>ï¼Œè€Œä¸å†æ˜¯å•ä¸€çš„<code>ImageLoadState</code>ï¼Œè™½ç„¶è¯·æ±‚ç±»å‹ä»ç„¶æ˜¯æ³›å‹çš„ï¼Œä½†æ˜¯å·²ç»ä¸éœ€è¦è¡¨è¾¾ç±»ä¼¼äº<code>RequestBuilder</code>è¿™æ ·çš„æ³›å‹ç±»å‹ï¼Œå¦‚ä½•æ„å»ºã€å‘èµ·è¯·æ±‚ç”±<code>Loader</code>è‡ªå·±å†³å®šã€‚</p><p><code>ImageLoadState</code>çš„å®ç°å¦‚ä¸‹</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sealed class ImageLoadState {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    object Empty : ImageLoadState()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data class Loading(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val placeholder: Painter?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val request: Any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) : ImageLoadState()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data class Success(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val result: Painter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val source: DataSource,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val request: Any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) : ImageLoadState()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data class Error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val request: Any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val result: Painter? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val throwable: Throwable? = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) : ImageLoadState()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ä¸éš¾å‘ç°æ‰€æœ‰çš„å›¾ç‰‡åŠ è½½ç»“æœéƒ½è¦æ±‚å°è£…æˆ<code>Painter</code>è¿›è¡Œè¿”å›ï¼Œä½†å°´å°¬çš„æ˜¯ï¼Œ<code>Drawable</code>ä¸<code>Painter</code>å¹¶ä¸æ˜¯å¤©ç”Ÿäº’é€šçš„ç±»å‹ï¼ˆCompose 1.0.5åªæœ‰ä¸‰ç§<code>Painter</code>ï¼Œ<code>BitmapPainter</code>ã€<code>VectorPainter</code>ã€<code>ColorPainter</code>ï¼‰ï¼Œå¥½åœ¨Accompanistæä¾›äº†ä¸€ä¸ª<code>DrawablePainter</code>ã€‚ä¸è¿‡è¯åˆè¯´å›æ¥ï¼Œä¸ºä»€ä¹ˆéå¾—è¦æ±‚ç”Ÿäº§è€…Loaderè¿”å›<code>Painter</code>ä¸å¯å‘¢ï¼Ÿé‚£æ˜¯å› ä¸ºåŠ è½½è¯·æ±‚æ˜¯å¤šç±»å‹çš„ï¼Œæ¶ˆè´¹è€…LoadPainterå…¶å®æ— æ³•ç¡®å®šç”Ÿäº§è€…è¿”å›çš„ç»“æœçš„ç±»å‹ï¼Œè‡ªç„¶ä¹Ÿä¸ç¡®å®šå¦‚ä½•ç»˜åˆ¶å®ƒï¼Œå› æ­¤LoadPainteré‡‡ç”¨äº†ç±»ä¼¼äºè£…é¥°è€…æ¨¡å¼çš„è®¾è®¡ï¼Œå›¾ç‰‡ç»“æœç»˜åˆ¶äº¤ç”±Stateå†…çš„Painterå®Œæˆã€‚</p><p><code>GlideLoader</code>çš„å®ç°å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">internal class GlideLoader(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestManager: RequestManager,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestBuilder: (RequestBuilder&lt;Drawable&gt;.(size: IntSize) -&gt; RequestBuilder&lt;Drawable&gt;)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) : Loader&lt;Any&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var requestManager by mutableStateOf(requestManager)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var requestBuilder by mutableStateOf(requestBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ä¸è¦åˆ é™¤callbackFlowä¸Šçš„æ˜¾å¼ç±»å‹&lt;ImageLoadState&gt;ã€‚IRç¼–è¯‘å™¨ä¸å–œæ¬¢éšå¼ç±»å‹ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Suppress(&quot;RemoveExplicitTypeArguments&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @OptIn(ExperimentalCoroutinesApi::class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun load(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        request: Any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size: IntSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ): Flow&lt;ImageLoadState&gt; = callbackFlow&lt;ImageLoadState&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var failException: Throwable? = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡ŒåŒæ—¶ä½¿ç”¨Targetä¸Listenerä¸¤ç§æœºåˆ¶æ¥ç›‘å¬åŠ è½½çŠ¶æ€ï¼Œå¹¶å‘flowå‘é€å¯¹åº”çŠ¶æ€</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Targetå¹¶ä¸ä¼šå»å¤„ç†Successçš„çŠ¶æ€ï¼ŒListenerå·²ç»æŠ¢å…ˆå¤„ç†å¹¶æ‹¦æˆªäº†Targetçš„Successè°ƒç”¨</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val target = object : EmptyCustomTarget(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (size.width &gt; 0) size.width else Target.SIZE_ORIGINAL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (size.height &gt; 0) size.height else Target.SIZE_ORIGINAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override fun onLoadStarted(placeholder: Drawable?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                trySendBlocking(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ImageLoadState.Loading(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        placeholder = placeholder?.let(::DrawablePainter),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        request = request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override fun onLoadFailed(errorDrawable: Drawable?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                trySendBlocking(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ImageLoadState.Error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        result = errorDrawable?.let(::DrawablePainter),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        request = request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throwable = failException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ?: IllegalArgumentException(&quot;Error while loading $request&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Close the channel[Flow]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override fun onLoadCleared(resource: Drawable?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Glideæƒ³è¦é‡Šæ”¾èµ„æºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ¸…é™¤ç»“æœï¼Œå¦åˆ™æˆ‘ä»¬å¯èƒ½ä¼šç»˜åˆ¶å·²ç»è¢«å›æ”¶çš„è§†å›¾</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                trySendBlocking(ImageLoadState.Empty)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Close the channel[Flow]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val listener = object : RequestListener&lt;Drawable&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override fun onResourceReady(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                drawable: Drawable,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                model: Any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                target: Target&lt;Drawable&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataSource: com.bumptech.glide.load.DataSource,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                isFirstResource: Boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ): Boolean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è¿™é‡Œå‘é€çš„Painterç±»å‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                trySendBlocking(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ImageLoadState.Success(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        result = DrawablePainter(drawable),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        source = dataSource.toDataSource(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        request = request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Close the channel[Flow]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Return true so that the target doesn&#x27;t receive the drawable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è¿™é‡Œè¿”å›trueï¼ŒTargetå°±æ”¶ä¸åˆ°ç»“æœäº†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override fun onLoadFailed(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e: GlideException?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                model: Any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                target: Target&lt;Drawable&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                isFirstResource: Boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ): Boolean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Glideåªä¸ºListeneræ´¾å‘é”™è¯¯çš„Exceptionï¼Œå› æ­¤è¿™é‡Œéœ€è¦ç¼“å­˜ä¸€ä¸‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                failException = e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è¿”å›falseï¼Œå…è®¸Targetè¢«å›è°ƒonLoadFailed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Start the image request into the target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestManager.load(request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .apply { requestBuilder?.invoke(this, size) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .addListener(listener)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .into(target)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Await the channel being closed and request finishing...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        awaitClose {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è¿™é‡Œæ²¡æœ‰è°ƒç”¨Glide.clear()ï¼Œå› ä¸ºclearä¹‹åPainterè¿›è¡Œç»˜åˆ¶çš„ä½å›¾å¯èƒ½ä¼šè¢«å›æ”¶ï¼Œè¿™ä¼šæŠ¥é”™</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // See https://github.com/google/accompanist/issues/419</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æ€»ä½“æ¥è¯´çŠ¶æ€è½¬æ¢é€»è¾‘å’Œä»¥å‰ç±»ä¼¼ï¼Œåªä¸è¿‡ä½¿ç”¨<code>callbackFlow</code>ç”Ÿæˆæ•°æ®æµåï¼ŒçŠ¶æ€å‘é€æ˜¾å¾—æ›´åŠ ä¼˜é›…äº†ã€‚</p><p>æ¥ä¸‹æ¥å…³æ³¨<code>rememberLoadPainter</code>çš„å…·ä½“å®ç°ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¸€ä¸ªé€šç”¨çš„ image loading painterï¼Œå®ƒä¸ºè¦å®ç°çš„å›¾åƒåŠ è½½åº“æä¾›Loaderæ¥å£ã€‚åº”ç”¨ç¨‹åºé€šå¸¸ä¸åº”è¯¥ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè€Œæ›´æ¨èä½¿ç”¨åœ¨æ­¤åŸºç¡€ä¸Šæ„å»ºçš„æ‰©å±•åº“ï¼Œä¾‹å¦‚Coilå’ŒGlideåº“ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun &lt;R&gt; rememberLoadPainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loader: Loader&lt;R&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request: R?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldRefetchOnSizeChange: ShouldRefetchOnSizeChange,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fadeIn: Boolean = false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fadeInDurationMs: Int = LoadPainterDefaults.FadeInTransitionDuration,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @DrawableRes previewPlaceholder: Int = 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): LoadPainter&lt;R&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val coroutineScope = rememberCoroutineScope()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Our LoadPainter. This invokes the loader as appropriate to display the result.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val painter = remember(loader, coroutineScope) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LoadPainter(loader, coroutineScope)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    painter.request = request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    painter.shouldRefetchOnSizeChange = shouldRefetchOnSizeChange</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç¼“å­˜çˆ¶å¸ƒå±€çš„å¤§å°ï¼Œåœ¨è®¡ç®—å›¾ç‰‡è¯·æ±‚çš„å¤§å°æ—¶ä¼šå‚è€ƒæ­¤å€¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    painter.rootViewSize = LocalView.current.let { IntSize(it.width, it.height) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // fadeInåŠ¨ç”»çš„ColorFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å®ç°åŸç†å’Œ0.6.2ç‰ˆæœ¬ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¿®æ”¹äº†ColorFliterçš„alpha(é€æ˜åº¦),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // brightness(äº®åº¦),saturation(é¥±å’Œåº¦)ï¼Œä¸è¿‡è¿™æ¬¡çš„ColorFliterç”±LoadPainterç›´æ¥è¿›è¡Œå¤„ç†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animateFadeInColorFilter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        painter = painter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enabled = { result -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä» disk/network æ‰å»å±•ç¤ºfadeInåŠ¨ç”»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è¿™ä½¿æˆ‘ä»¬å¯ä»¥è¿‘ä¼¼åœ°åªåœ¨â€œé¦–æ¬¡åŠ è½½â€æ—¶è¿è¡ŒåŠ¨ç”»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fadeIn &amp;&amp; result is ImageLoadState.Success &amp;&amp; result.source != DataSource.MEMORY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        durationMs = fadeInDurationMs,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Our result painter, created from the ImageState with some composition lifecycle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // callbacks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æˆ‘ä»¬çš„result painterï¼Œé€šè¿‡ä¸€äº›compositionç”Ÿå‘½å‘¨æœŸçš„å›è°ƒä»ImageStateåˆ›å»º</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updatePainter(painter, previewPlaceholder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return painter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>LoaderPainter</code>çš„å®ç°å¦‚ä¸‹ã€‚è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„<code>RememberObserver</code>è¿™ä¸ªæ¥å£ï¼Œ<code>RememberObserver</code>æ˜¯ä¸€ä¸ªèƒ½å¤Ÿå®ç°å¯¹rememberè¡Œä¸ºçš„è§‚å¯Ÿçš„æ¥å£ï¼Œå¦‚æœcompositionè®°ä½æˆ–è€…é—å¿˜çš„æ˜¯ä¸€ä¸ª<code>RememberObserver</code>å¯¹è±¡ï¼Œ<code>RememberObserver</code>èƒ½å¤Ÿæ”¶åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯¹<code>LoaderPainter</code>å¾ˆæœ‰ç”¨ã€‚å› ä¸ºLoaderPainteræ¯•ç«Ÿå¹¶ä¸æ˜¯ä¸€ä¸ªComposeç»„ä»¶ï¼Œä½†æ˜¯å®ƒå¿…é¡»äº†è§£å®ƒæ‰€åœ¨çš„çˆ¶ç»„ä»¶åœ¨ä»€ä¹ˆæ—¶å€™ç¦»å¼€äº†å±å¹•è¢«é”€æ¯äº†ï¼ˆä¾‹å¦‚é«˜é€Ÿæ»‘åŠ¨åˆ—è¡¨æ—¶ï¼‰ï¼Œè¿™æ ·å®ƒèƒ½å¤ŸåŠæ—¶å–æ¶ˆå¯¹çŠ¶æ€æµ<code>Flow&lt;ImageLoadState&gt;</code>çš„æ”¶é›†ï¼Œè¿™æ˜¯é¿å…å‘ç”Ÿå›¾ç‰‡é—ªçƒã€é”™ä½ç­‰é—®é¢˜çš„å…³é”®ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class LoadPainter&lt;R&gt; internal constructor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val loader: Loader&lt;R&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val coroutineScope: CoroutineScope,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) : Painter(), RememberObserver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val paint by lazy(LazyThreadSafetyMode.NONE) { Paint() }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    internal var painter by mutableStateOf&lt;Painter&gt;(EmptyPainter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™ä¸ªColorFilterå’Œæ¸å…¥åŠ¨ç”»æœ‰å…³</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    internal var transitionColorFilter by mutableStateOf&lt;ColorFilter?&gt;(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // CoroutineScope for the current request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var requestCoroutineScope: CoroutineScope? = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The current request object.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var request by mutableStateOf&lt;R?&gt;(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The root view size.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    internal var rootViewSize by mutableStateOf(IntSize(0, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Lambda which will be invoked when the size changes, allowing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * optional re-fetching of the image.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var shouldRefetchOnSizeChange by mutableStateOf(ShouldRefetchOnSizeChange { _, _ -&gt; false })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The current [ImageLoadState].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è¢«è§‚å¯Ÿçš„ImageLoadState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var loadState: ImageLoadState by mutableStateOf(ImageLoadState.Empty)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var alpha: Float by mutableStateOf(1f)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var colorFilter: ColorFilter? by mutableStateOf(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ‰§è¡Œå›¾åƒåŠ è½½è¯·æ±‚æ—¶è¦ä½¿ç”¨çš„å¤§å°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var requestSize by mutableStateOf&lt;IntSize?&gt;(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Painterå†…çš„å±æ€§ï¼ŒæŒ‡å®šè¾¹ç•Œå¤§å°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override val intrinsicSize: Size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        get() = painter.intrinsicSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun applyAlpha(alpha: Float): Boolean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.alpha = alpha</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun applyColorFilter(colorFilter: ColorFilter?): Boolean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.colorFilter = colorFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun DrawScope.onDraw() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®Canvasçš„å¤§å°ç¡®å®šrequestSizeï¼Œæ˜¯ä¸æ˜¯æ³¨æ„åˆ°requestSizeçš„ç¡®å®šå…¶å®æ˜¯å­˜åœ¨å»¶æ—¶çš„ï¼Ÿ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateRequestSize(canvasSize = size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¸‹é¢æ˜¯ä¸€äº›ç»˜åˆ¶é€»è¾‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val transitionColorFilter = transitionColorFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (colorFilter != null &amp;&amp; transitionColorFilter != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // If we have a transition color filter, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // and a specified color filter we need to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // draw the content in a layer for both to apply.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // See https://github.com/google/accompanist/issues/262</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           drawIntoCanvas { canvas -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                paint.colorFilter = transitionColorFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                canvas.saveLayer(bounds = size.toRect(), paint = paint)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                with(painter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    draw(size, alpha, colorFilter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                canvas.restore()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Otherwise we just draw the content directly, using the filter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with(painter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw(size, alpha, colorFilter ?: transitionColorFilter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // RememberObserverçš„æ–¹æ³•</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // rememberè¿è¡Œäº†è®¡ç®—çš„lambdaä½†æ˜¯compositionæ²¡è®°ä½è¿™ä¸ªå¯¹è±¡æ—¶å›è°ƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onAbandoned() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // We&#x27;ve been abandoned from composition, so cancel our request scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestCoroutineScope?.cancel()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestCoroutineScope = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // RememberObserverçš„æ–¹æ³•</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // compositionå¿˜è®°äº†è¿™ä¸ªå¯¹è±¡æ—¶å›è°ƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onForgotten() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // We&#x27;ve been forgotten from composition, so cancel our request scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // onAbandonedå’ŒonForgottenæ—¶éƒ½ä¼šcancelè¿è¡Œä¸­çš„åç¨‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestCoroutineScope?.cancel()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestCoroutineScope = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // RememberObserverçš„æ–¹æ³•</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“compositionæˆåŠŸè®°ä½æ­¤å¯¹è±¡æ—¶è°ƒç”¨ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onRemembered() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Cancel any on-going scope (this shouldn&#x27;t really happen anyway)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å…ˆå–æ¶ˆä»¥å‰æ­£runningçš„åç¨‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestCoroutineScope?.cancel()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¸ºå½“å‰è¯·æ±‚åˆ›å»ºæ–°çš„scopeï¼Œè¿™å…è®¸æˆ‘ä»¬å–æ¶ˆä½œç”¨åŸŸï¼Œè€Œä¸å½±å“çˆ¶ä½œç”¨åŸŸçš„ä½œä¸šã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val scope = coroutineScope.coroutineContext.let { context -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CoroutineScope(context + Job(context[Job]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }.also { requestCoroutineScope = it }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æˆ‘ä»¬å·²ç»è¢«è®°ä½äº†ï¼Œæ‰€ä»¥å¯ä»¥å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥è§‚å¯Ÿå½“å‰çš„è¯·æ±‚å¯¹è±¡å’Œè¯·æ±‚å¤§å°ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ¯å½“è¿™äº›å€¼ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘ç”Ÿå˜åŒ–æ—¶ï¼ŒcollectLatestå—å°†è¿è¡Œå¹¶æ‰§è¡Œå›¾åƒåŠ è½½ï¼ˆä»»ä½•æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚éƒ½å°†è¢«å–æ¶ˆï¼‰ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scope.launch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // combineæ–¹æ³•å¦‚å…¶åï¼Œèƒ½æŠŠä¸¤ä¸ªæµåˆå¹¶æˆä¸€ä¸ªæµ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¸è¿‡ä¸ºä»€ä¹ˆè¿™é‡Œè¦ä½¿ç”¨snapshotFlowæŠŠStateè½¬åŒ–æˆæµå‘¢ï¼Ÿ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å› ä¸ºä½¿ç”¨æµæ¥ç›‘å¬Stateå˜åŒ–çš„æœ€å¤§å¥½å¤„å°±æ˜¯collectLatestèƒ½å¤Ÿ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å–æ¶ˆæ‰ä¸Šä¸€æ¬¡çš„executeè°ƒç”¨å¹¶å¯åŠ¨æ–°ä¸€è½®çš„åŠ è½½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            combine(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                snapshotFlow { request },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                snapshotFlow { requestSize },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                transform = { request, size -&gt; request to size }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ).collectLatest { (request, size) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                execute(request, size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è‡ªåŠ¨ä¿é™©ã€‚å¦‚æœæ²¡æœ‰ä»onDraw()è·å¾—åˆé€‚çš„å¤§å°ï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æˆ‘ä»¬ä¼šå°†è¯·æ±‚å¤§å°æ›´æ–°ä¸º-1ï¼Œ-1ï¼Œè¿™å°†åŠ è½½åŸå§‹å¤§å°çš„å›¾åƒã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scope.launch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (requestSize == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 32ms should be enough time for measure/layout/draw to happen.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å¾®å¦™çš„32æ¯«ç§’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                delay(32) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (requestSize == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   // If we still don&#x27;t have a request size, resolve the size without</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   // the canvas size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ²¡è·å–åˆ°Canvaså¤§å°ï¼Œä½¿ç”¨åŸå§‹å°ºå¯¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    updateRequestSize(canvasSize = Size.Zero)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ‰§è¡Œå›¾ç‰‡åŠ è½½è¯·æ±‚å¹¶æ ¹æ®ç»“æœæ›´æ–°loadStateçš„æ–¹æ³•</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ä¸‹é¢æè¿°çš„æ˜¯ä¸€äº›çŠ¶æ€è½¬æ¢é€»è¾‘ï¼Œæ¯”å¦‚å¦‚æœè¯·æ±‚ä¸ºnullï¼ŒçŠ¶æ€å°±è½¬å˜ä¸ºEmpty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private suspend fun execute(request: R?, size: IntSize?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (request == null || size == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // If we don&#x27;t have a request, set our state to Empty and return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loadState = ImageLoadState.Empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loader.load(request, size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .catch { throwable -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                when (throwable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    is Error -&gt; throw throwable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    is IllegalStateException -&gt; throw throwable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    is IllegalArgumentException -&gt; throw throwable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        emit(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ImageLoadState.Error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                result = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                throwable = throwable,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                request = request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .collect { loadState = it }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¸Šé¢collectæ”¶é›†äº†åŠ è½½çš„çŠ¶æ€ï¼Œæ³¨æ„ï¼Œä»£è¡¨å›¾ç‰‡ç»“æœçš„Painteræ²¡è¢«è®¾ç½®åˆ°LoadPainterçš„å­—æ®µå†…</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private fun updateRequestSize(canvasSize: Size) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestSize = IntSize(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            width = when {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // If we have a canvas width, use it...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                canvasSize.width &gt;= 0.5f -&gt; canvasSize.width.roundToInt()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è¿˜è®°å¾—è¿™ä¸ªrootViewSizeå—ï¼Ÿå®ƒåœ¨rememberLoadPainterå‡½æ•°å†…è¢«è®¾ç½®</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rootViewSize.width &gt; 0 -&gt; rootViewSize.width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else -&gt; -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            height = when {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // If we have a canvas height, use it...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                canvasSize.height &gt;= 0.5f -&gt; canvasSize.height.roundToInt()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Otherwise we fall-back to the root view size as an upper bound</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rootViewSize.height &gt; 0 -&gt; rootViewSize.height</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else -&gt; -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>è™½ç„¶è¯´<code>LoadPainter</code>ç¡®å®æ˜¯å®ç°äº†<code>RememberObserver</code>ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªå›è°ƒæ˜¯æ€ä¹ˆè¢«æ³¨å†Œçš„å‘¢ï¼Ÿç­”æ¡ˆè—åœ¨ä¹ ä»¥ä¸ºå¸¸çš„<code>remember</code>å‡½æ•°ä¸­ï¼Œä¼ å…¥<code>remember</code>çš„keyï¼Œæˆ–è€…æ˜¯calculationå¾—å‡ºçš„å€¼ï¼Œå®ƒä»¬å¦‚æœæ˜¯ä¸ª<code>RememberObserver</code>ï¼Œåˆ™ä¼šè¢«æ’å…¥åˆ°<code>RememberManager</code>çš„é˜Ÿåˆ—ä¸­ï¼Œæ¯å½“â€œè®°å¿†â€å’Œâ€œé—å¿˜â€äº‹ä»¶å‘ç”Ÿæ—¶éƒ½ä¼šå¾—åˆ°é€šçŸ¥ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inline fun &lt;T&gt; remember(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key1: Any?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    calculation: @DisallowComposableCalls () -&gt; T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): T {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return currentComposer.cache(currentComposer.changed(key1), calculation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// æ³¨æ„æ£€æŸ¥keyæ˜¯å¦æœ‰å˜åŒ–çš„changedå‡½æ•°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ComposeCompilerApi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">override fun changed(value: Any?): Boolean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return if (nextSlot() != value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateValue(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PublishedApi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OptIn(InternalComposeApi::class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal fun updateValue(value: Any?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä¸¤ä¸ªifåˆ†æ”¯æˆ‘ä»¬éƒ½å¯ä»¥çœ‹åˆ° rememberManager.remembering()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // rememberManager.forgetting()è¿™äº›è°ƒç”¨</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (inserting) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        writer.update(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (value is RememberObserver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨æ„ï¼Œåˆ¤æ–­valueæ˜¯ä¸æ˜¯RememberObserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            record { _, _, rememberManager -&gt; rememberManager.remembering(value) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val groupSlotIndex = reader.groupSlotIndex - 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recordSlotTableOperation(forParent = true) { _, slots, rememberManager -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (value is RememberObserver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                abandonSet.add(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rememberManager.remembering(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            when (val previous = slots.set(groupSlotIndex, value)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                is RememberObserver -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rememberManager.forgetting(previous)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                is RecomposeScopeImpl -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    val composition = previous.composition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (composition != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        previous.composition = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        composition.pendingInvalidScopes = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// RememberManageræ˜¯ä¸ªæ¥å£</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal interface RememberManager {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The [RememberObserver] is being remembered by a slot in the slot table.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun remembering(instance: RememberObserver)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The [RememberObserver] is being forgotten by a slot in the slot table.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun forgetting(instance: RememberObserver)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// RememberManagerçš„å®ç°ç±»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private class RememberEventDispatcher(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val abandoning: MutableSet&lt;RememberObserver&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) : RememberManager {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val remembering = mutableListOf&lt;RememberObserver&gt;()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val forgetting = mutableListOf&lt;RememberObserver&gt;()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val sideEffects = mutableListOf&lt;() -&gt; Unit&gt;()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun remembering(instance: RememberObserver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        forgetting.lastIndexOf(instance).let { index -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (index &gt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                forgetting.removeAt(index)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                abandoning.remove(instance)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                remembering.add(instance)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun forgetting(instance: RememberObserver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remembering.lastIndexOf(instance).let { index -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (index &gt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                remembering.removeAt(index)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                abandoning.remove(instance)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                forgetting.add(instance)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun dispatchRememberObservers() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ´¾å‘forgettingå’Œrememberingäº‹ä»¶çš„é€»è¾‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (forgetting.isNotEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (i in forgetting.size - 1 downTo 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                val instance = forgetting[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (instance !in abandoning) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    instance.onForgotten()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (remembering.isNotEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            remembering.fastForEach { instance -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                abandoning.remove(instance)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                instance.onRemembered()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æˆ‘ä»¬å·²ç»æ˜ç™½<code>LoadPainter</code>åˆ°åº•æ˜¯æ€ä¹ˆç®¡ç†Loaderè¿”å›çš„æµç»“æœäº†ï¼Œæœ€åä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹åœ¨å‡½æ•°<code>updatePainter</code>é‡Œï¼Œè¿™ä¸ªè°ƒç”¨ä½äº<code>rememberLoadPainter</code>æœ€åï¼Œå‡½æ•°å®ç°ä¼šæ ¹æ®å›¾ç‰‡åŠ è½½Stateçš„å˜åŒ–æ¥ä¸ºLoadPainterè®¾ç½®Painterã€‚ä¸è¿‡è¿™ä¸æ˜¯å…œäº†ä¸ªåœˆå­å—ï¼Ÿä¼¼ä¹ä¹Ÿå¯ä»¥åœ¨collectæ›´æ–°Stateçš„åŒæ—¶æŠŠPainteræ›´æ–°ä¸€ä¸‹ï¼Ÿ</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* å…è®¸æˆ‘ä»¬ä»¥çŠ¶æ€è§‚å¯Ÿå½“å‰ç»“æœã€‚è¿™ä¸ªå‡½æ•°å…è®¸æˆ‘ä»¬æœ€å°åŒ–é‡ç»„èŒƒå›´ï¼Œè¿™æ ·å½“loadStateæ”¹å˜æ—¶ï¼Œåªæœ‰è¿™ä¸ªå‡½æ•°éœ€è¦é‡æ–°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* å¯åŠ¨ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun &lt;R&gt; updatePainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loadPainter: LoadPainter&lt;R&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @DrawableRes previewPlaceholder: Int = 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loadPainter.painter = if (LocalInspectionMode.current &amp;&amp; previewPlaceholder != 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæˆ‘ä»¬å¤„äºæ£€æŸ¥æ¨¡å¼ï¼ˆé¢„è§ˆï¼‰ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªé¢„è§ˆå ä½ç¬¦ï¼Œåªéœ€ä½¿ç”¨å›¾åƒç»˜åˆ¶å®ƒå¹¶è¿”å›</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿˜è®°å¾—rememberGlidePainterçš„å‚æ•°å—ï¼Ÿè¿™é‡Œå°±æ˜¯ä¼ å…¥çš„å‚æ•°previewPlaceholderçš„ç”¨é€”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™ä¸ªå‡½æ•°ä»¤LoadPainterå®Œå…¨å¿½ç•¥äº†Stateçš„å˜åŒ–ï¼Œåªå±•ç¤ºé™æ€å›¾ç‰‡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        painterResource(previewPlaceholder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // rememberåœ¨è¿™é‡Œçœ‹ä¸Šå»åƒæ˜¯æ¯«æ— å¿…è¦çš„è°ƒç”¨ï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä½†è¿™å…è®¸ä»»ä½•Painterå®ä¾‹æ¥æ”¶è®°å¿†äº‹ä»¶ï¼ˆå¦‚æœå®ƒå®ç°äº†RememberObserverï¼‰ã€‚ä¸è¦ç§»é™¤ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remember(loadPainter.loadState) { loadPainter.loadState.painter } ?: EmptyPainter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ç°åœ¨æ¥æ€»ç»“ä¸€ä¸‹0.13.0ç‰ˆæœ¬çš„Glideè¿œç¨‹å›¾ç‰‡æ‰©å±•çš„å®ç°æ€è·¯ï¼š</p><ol><li><p>å›¾ç‰‡åŠ è½½ï¼šä¾ç„¶æ˜¯ç”¨Targetå›è°ƒè·å–åŠ è½½çš„ç»“æœã€‚ä½†æ˜¯åŠ è½½çŠ¶æ€çš„è¿”å›ç°åœ¨ä½¿ç”¨æµï¼ˆFlowï¼‰æ¥å°è£…ï¼Œä¸ç®¡æ˜¯å‘èµ·åŠ è½½ï¼Œå¼‚å¸¸å¤„ç†ï¼ŒåŠ è½½å–æ¶ˆéƒ½æ›´åŠ ä¼˜é›…ç›´è§‚äº†ã€‚Loaderæ˜¯å½»å½»åº•åº•çš„ç”Ÿäº§è€…ï¼Œ<code>LoadPainter</code>åˆ™æ˜¯æ¶ˆè´¹è€…ã€‚</p><p><code>LoadPainter</code>å¹¶ä¸å…·æœ‰@Composableä¸Šä¸‹æ–‡ï¼Œä½œä¸ºæ›¿ä»£ï¼Œå®ƒå®ç°äº†<code>RememberObserver</code>æ¥ç›‘å¬æ§ä»¶æ˜¯å¦å·²ç»ç¦»å±é”€æ¯ã€‚</p></li><li><p>å›¾ç‰‡å¤§å°çº¦æŸï¼šä¾èµ–äºLoadPainterè·å–çš„Canvasçš„å¤§å°ã€‚</p></li><li><p>æ¸å…¥åŠ¨ç”»å®ç°ï¼šè·Ÿ0.6.2ç‰ˆæœ¬çš„æ€è·¯ç›¸ä¼¼ï¼Œä¸è¿‡æ¶ˆè´¹ColorFilterçš„ç±»å˜æˆäº†LoadPainterã€‚</p></li><li><p>loadingå ä½å›¾ã€errorå›¾ç­‰ï¼šè¿™äº›åŠŸèƒ½ç›´æ¥ä¾èµ–äºå…·ä½“çš„å›¾ç‰‡åŠ è½½æ¡†æ¶çš„å®ç°ï¼Œæœ‰åˆ™æœ‰ï¼Œæ— åˆ™æ— ã€‚0.13.0ç‰ˆæœ¬ç¨å¾®èˆå»äº†ä¸€äº›çµæ´»æ€§ï¼Œä¸èƒ½å¤ŸåƒPicassoImageä¸€æ ·ç›´æ¥ä¼ å…¥errorã€loadingçš„Composeå†…å®¹ï¼ˆæ§ä»¶ï¼‰ï¼Œä¸è¿‡ä»ç„¶ç•™æœ‰ç›‘å¬å›¾ç‰‡åŠ è½½çŠ¶æ€çš„æ–¹å¼ï¼Œæ³¨æ„ï¼ŒLoadPainterçš„<code>loadState</code>å­—æ®µæ˜¯å…¬å¼€çš„ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The current [ImageLoadState].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var loadState: ImageLoadState by mutableStateOf(ImageLoadState.Empty)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private set</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="coil">Coil<a class="hash-link" href="#coil" title="Direct link to heading">â€‹</a></h2><p>Accompanistå†…çš„Coilé›†æˆåº“æœ€ç»ˆé›†æˆåˆ°äº†Coilå†…éƒ¨ï¼Œæˆä¸ºå…¶æ‰©å±•ï¼ŒGlideçš„é›†æˆæ”¯æŒåˆ™åœ¨2021å¹´8æœˆçš„0.16.0ç‰ˆæœ¬è¢«åˆ é™¤ã€‚</p><p>ç°åœ¨æˆ‘ä»¬ç®€è¦åˆ†æCoilçš„å›¾ç‰‡åŠ è½½é€»è¾‘ï¼ˆç‰ˆæœ¬2.0.0-alpha06ï¼‰ã€‚Coilæ‰©å±•åº“æä¾›äº†ä¸¤ç§æ–¹å¼æ¥åŠ è½½ç½‘ç»œå›¾ç‰‡ï¼Œä¸¤ç§æ–¹å¼æ­£å·§å°±æ˜¯ä¸Šé¢æåˆ°çš„åœ¨0.6.2ç‰ˆæœ¬ä¸åœ¨0.13.0ç‰ˆæœ¬çš„ä¸¤ç§å®ç°å½¢å¼ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// å®ç°å½¢å¼1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun AsyncImage(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model: Any?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contentDescription: String?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imageLoader: ImageLoader,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier: Modifier = Modifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loading: @Composable (AsyncImageScope.(State.Loading) -&gt; Unit)? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    success: @Composable (AsyncImageScope.(State.Success) -&gt; Unit)? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error: @Composable (AsyncImageScope.(State.Error) -&gt; Unit)? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alignment: Alignment = Alignment.Center,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contentScale: ContentScale = ContentScale.Fit,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alpha: Float = DefaultAlpha,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    colorFilter: ColorFilter? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filterQuality: FilterQuality = DefaultFilterQuality,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// å®ç°å½¢å¼2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun rememberAsyncImagePainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model: Any?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imageLoader: ImageLoader,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filterQuality: FilterQuality = DefaultFilterQuality,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): AsyncImagePainter {...}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æˆ‘ä»¬é‡ç‚¹åˆ†æç¬¬äºŒç§å½¢å¼ï¼Œå³rememberAsyncImagePainterå‡½æ•°ï¼Œå…¶å®è¯¥å‡½æ•°çš„å®ç°é€»è¾‘ä¸Glideæ‰©å±•åº“æ¯”è¾ƒç±»ä¼¼ï¼Œåªåœ¨æŸäº›ç»†èŠ‚æœ‰æ‰€åŒºåˆ«ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// è¿™é‡Œä¸å†è¯¦ç»†åˆ†ææºç ï¼ŒæŒ‘é‡è¦çš„è®²</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun rememberAsyncImagePainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model: Any?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imageLoader: ImageLoader,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filterQuality: FilterQuality = DefaultFilterQuality,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): AsyncImagePainter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val request = requestOf(model)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requireSupportedData(request.data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ³¨æ„è¿™é‡Œï¼Œè¿™é‡Œè¦æ±‚requestçš„targetä¸ºnull</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    require(request.target == null) { &quot;request.target must be null.&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Dispatchers.Main.immediateæ˜¯ä¸€ä¸ªæœ‰è¶£çš„åç¨‹è°ƒåº¦å™¨ï¼Œå…·ä½“æ•ˆæœè§ç±»æ³¨é‡Š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val scope = rememberCoroutineScope { Dispatchers.Main.immediate }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // AsyncImagePainter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val painter = remember(scope) { AsyncImagePainter(scope, request, imageLoader) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    painter.request = request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    painter.imageLoader = imageLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    painter.filterQuality = filterQuality</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ˜¯å¦å¤„äºé¢„è§ˆæ¨¡å¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    painter.isPreview = LocalInspectionMode.current</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™é‡Œæ‰‹åŠ¨è°ƒç”¨äº†ä¸€æ¬¡onRememberedï¼ŒonRememberedé‡Œæœ‰å‘ImageLoaderæäº¤requestçš„é€»è¾‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    painter.onRemembered() // Invoke this manually so `painter.state` is up to date immediately.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™é‡Œçš„updatePainteræ›´åŠ å¤æ‚ï¼Œé‡Œé¢æœ‰å¤„ç†fadeInåŠ¨ç”»çš„é€»è¾‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updatePainter(painter, request, imageLoader)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return painter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Dispatchers.Main.immediateæ¯”å•çº¯çš„Dispatchers.Mainæ›´åŠ æ™ºèƒ½ï¼Œå®ƒä¼šå‡å°‘ä¸å¿…è¦çš„è°ƒåº¦ï¼Œå½“å®ƒå·²ç»åœ¨æ­£ç¡®çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå®ƒä¼šç«‹åˆ»æ‰§è¡Œç›¸åº”é€»è¾‘è€Œæ— éœ€é¢å¤–çš„é‡æ–°è°ƒåº¦ã€‚æ•ˆæœç±»ä¼¼äºä¸‹é¢è¿™æ ·ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">suspend fun updateUiElement(val text: String) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * å‡è®¾updateUiElementæ—¢ä¼šè¢«Mainçº¿ç¨‹è°ƒç”¨ä¹Ÿä¼šè¢«å…¶ä»–çº¿ç¨‹è°ƒç”¨ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * é‚£ä¹ˆï¼Œå½“updateUiElementæ˜¯åœ¨Mainçº¿ç¨‹è¢«è°ƒç”¨çš„ï¼Œæ›´æ–°uiElement.text è¿™æ®µä»£ç ä¼šç›´æ¥è¿è¡Œï¼Œè€Œæ¢æˆDispatchers.Mainçš„è¯ï¼Œå®ƒä¼šå†è¿›è¡Œä¸€æ¬¡åˆ°Mainçš„è°ƒåº¦ï¼ˆæ˜æ˜¾è¿™æ˜¯èµ˜ä½™çš„è°ƒåº¦ï¼‰ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  withContext(Dispatchers.Main.immediate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uiElement.text = text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Do context-independent logic such as logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å…³æ³¨AsyncImagePainterçš„å…·ä½“å®ç°ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * å¼‚æ­¥æ‰§è¡ŒImageRequestå¹¶å‘ˆç°ç»“æœçš„Painterã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class AsyncImagePainter internal constructor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val parentScope: CoroutineScope,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request: ImageRequest,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imageLoader: ImageLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) : Painter(), RememberObserver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var rememberScope: CoroutineScope? = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å›¾ç‰‡è¯·æ±‚çš„åç¨‹çš„Job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var requestJob: Job? = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var drawSize = MutableStateFlow(Size.Zero)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var alpha: Float by mutableStateOf(1f)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var colorFilter: ColorFilter? by mutableStateOf(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    internal var painter: Painter? by mutableStateOf(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    internal var filterQuality = DefaultFilterQuality</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    internal var isPreview = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /** The current [AsyncImagePainter.State]. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var state: State by mutableStateOf(State.Empty)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var request: ImageRequest by mutableStateOf(request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        internal set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var imageLoader: ImageLoader by mutableStateOf(imageLoader)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        internal set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override val intrinsicSize: Size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        get() = painter?.intrinsicSize ?: Size.Unspecified</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun DrawScope.onDraw() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç»˜åˆ¶é€»è¾‘éå¸¸æ¸…çˆ½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        drawSize.value = size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Draw the current painter.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        painter?.apply { draw(size, alpha, colorFilter) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onRemembered() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæˆ‘ä»¬å¤„äºæ£€æŸ¥æ¨¡å¼ï¼ˆé¢„è§ˆï¼‰ï¼Œè¯·è·³è¿‡æ‰§è¡Œå›¾åƒè¯·æ±‚ï¼Œå¹¶å°†çŠ¶æ€è®¾ç½®ä¸ºåŠ è½½ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¯¹äºé¢„è§ˆæ¨¡å¼çš„æ”¯æŒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isPreview) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val request = request.newBuilder().defaults(imageLoader.defaults).build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            state = State.Loading(request.placeholder?.toPainter())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¸Glideæ‰©å±•ç±»ä¼¼ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå­ä½œç”¨åŸŸ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (rememberScope != null) return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val scope = parentScope + SupervisorJob(parentScope.coroutineContext.job)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rememberScope = scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è§‚å¯Ÿå½“å‰è¯·æ±‚+è¯·æ±‚å¤§å°ï¼Œå¹¶æ ¹æ®éœ€è¦å¯åŠ¨æ–°è¯·æ±‚ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Coilå¤©ç„¶æ”¯æŒKotlinåç¨‹ï¼Œæ— éœ€ä¸ºç”Ÿäº§è€…é¢å¤–ç¼–å†™ä»£ç </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scope.launch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            snapshotFlow { request }.collect { request -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                requestJob?.cancel()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                requestJob = launch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // executeæ˜¯æŒ‚èµ·å‡½æ•°ï¼Œè¿”å›ImageResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    state = imageLoader.execute(updateRequest(request)).toState()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onForgotten() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rememberScope?.cancel()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rememberScope = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestJob?.cancel()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestJob = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onAbandoned() = onForgotten()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /** Update the [request] to work with [AsyncImagePainter]. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private fun updateRequest(request: ImageRequest): ImageRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return request.newBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .target(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                onStart = { placeholder -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     // è¿™é‡Œè·å–åˆ°placeholderçš„Painterå¹¶æ›´æ–°Stateä¸ºLoading</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    state = State.Loading(placeholder?.toPainter())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .apply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (request.defined.sizeResolver == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Coilå†…å…³äºè®¾ç½®å›¾ç‰‡å¤§å°çš„ä»£ç </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // sizeæ¥å—ä¸€ä¸ªSizeResolverï¼Œä¸€ä¸ªå«suspendå‡½æ•°çš„æ¥å£</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // è·å–å°ºå¯¸çš„å‡½æ•°æ˜¯æŒ‚èµ·å‡½æ•°ï¼Œéå¸¸åˆç†ï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™éœ€è¦ç­‰å¾…æ§ä»¶æµ‹é‡å®Œæ¯•æ‰çŸ¥é“å¤§å°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    size(DrawSizeResolver())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (request.defined.precision != Precision.EXACT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    precision(Precision.INEXACT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private fun ImageResult.toState() = when (this) {....}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private fun Drawable.toPainter() = when (this) {...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /** Suspends until the draw size for this [AsyncImagePainter] is unspecified or positive. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private inner class DrawSizeResolver : SizeResolver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        override suspend fun size() = drawSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .mapNotNull { size -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                when {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // mapNotNullä¼šå°†drawSizeè½¬åŒ–ä¸ºFlowï¼ŒåŒæ—¶è¿‡æ»¤nullå€¼ï¼Œç„¶åæŒ‚èµ·å‡½æ•°first()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†ä¼šè¿”å›Flowä¸­ä¼ é€çš„ç¬¬ä¸€ä¸ªå€¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    size.isUnspecified -&gt; CoilSize.ORIGINAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    size.isPositive -&gt; CoilSize(size.width.roundToInt(), size.height.roundToInt())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .first()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The current state of the [AsyncImagePainter].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * çŠ¶æ€å®šä¹‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sealed class State {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        abstract val painter: Painter?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        object Empty : State() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override val painter: Painter? get() = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data class Loading(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override val painter: Painter?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) : State()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data class Success(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override val painter: Painter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val result: SuccessResult,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) : State()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data class Error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override val painter: Painter?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val result: ErrorResult,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) : State()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ä¸Glideæ‰©å±•åº“çš„æ€è·¯ç±»ä¼¼ï¼ŒupdatePainterå‡½æ•°ä¼šç›‘å¬AsyncImagePainterçš„åŠ è½½çŠ¶æ€å˜åŒ–ï¼ŒåŒæ—¶æ›´æ–°AsyncImagePainterå†…çš„Painterå­—æ®µã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun updatePainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imagePainter: AsyncImagePainter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request: ImageRequest,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imageLoader: ImageLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // This may look like a useless remember, but this allows any painter instances</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // to receive remember events (if it implements RememberObserver). Do not remove.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä¸Glideæ‰©å±•åº“ä¸€æ ·ï¼Œå…è®¸ç»“æœPainterå®ä¾‹æ¥æ”¶rememberäº‹ä»¶ï¼ˆå¦‚æœå®ƒå®ç°äº†RememberObserverï¼‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val state = imagePainter.state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val painter = remember(state) { state.painter }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœæ²¡æœ‰CrossfadeTransitionï¼ˆå®ç°æ¸å…¥å˜æ¢ï¼‰çš„è¯ï¼Œç›´æ¥è®¾ç½®imagePainter.painterå¹¶è¿”å›</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val transition = request.defined.transitionFactory ?: imageLoader.defaults.transitionFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (transition !is CrossfadeTransition.Factory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePainter.painter = painter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ValueHolderæ˜¯ä¸€ä¸ªåŒ…å«static fieldçš„æ•°æ®ç±»ï¼Œç›®çš„æ˜¯å‚¨å­˜state.painterçš„å€¼ï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é¿å…åœ¨state.painterå€¼æ›´æ–°åå‡½æ•°rememberCrossfadePainteré‡ç»„ï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä¸rememberUpdatedStateæœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œä¼°è®¡æ˜¯å› ä¸ºrememberUpdatedStateæ²¡æœ‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä¼ å…¥keyçš„APIï¼ˆè¿™é‡Œè¦ç›‘å¬requestå˜åŒ–ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæä¾›äº†ç®€æ˜“çš„é¿å…é‡ç»„çš„å®ç°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val loading = remember(request) { ValueHolder&lt;Painter?&gt;(null) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (state is State.Loading) loading.value = state.painter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¿…é¡»ä½äºSuccessçŠ¶æ€ä¸”å›¾ç‰‡æ˜¯ä»ç½‘ç»œæˆ–ç£ç›˜åŠ è½½çš„ï¼Œæ‰å…è®¸å¯åŠ¨Crossfadeï¼Œå¦åˆ™è¿”å›å³å¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (state !is State.Success || state.result.dataSource == DataSource.MEMORY_CACHE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePainter.painter = painter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Set the crossfade painter.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥çš„CrossfadePainter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imagePainter.painter = rememberCrossfadePainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key = state,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        start = loading.value,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end = painter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scale = request.scale,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        durationMillis = transition.durationMillis,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fadeStart = !state.result.isPlaceholderCached,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        preferExactIntrinsicSize = transition.preferExactIntrinsicSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/** A simple mutable value holder that avoids recomposition. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ä½¿ç”¨é™æ€å­—æ®µï¼ˆstaticï¼‰é¿å…é‡ç»„</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private class ValueHolder&lt;T&gt;(@JvmField var value: T)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>CrossfadePainterçš„å®ç°å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@Stable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private class CrossfadePainter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var start: Painter?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val end: Painter?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val scale: Scale,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val durationMillis: Int,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val fadeStart: Boolean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val preferExactIntrinsicSize: Boolean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) : Painter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var invalidateTick by mutableStateOf(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var startTimeMillis = -1L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var isDone = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var maxAlpha: Float by mutableStateOf(1f)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var colorFilter: ColorFilter? by mutableStateOf(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override val intrinsicSize get() = computeIntrinsicSize()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun DrawScope.onDraw() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœAlphaå˜åŒ–å®Œæ¯•ï¼Œç›´æ¥ä½¿ç”¨endç»˜åˆ¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isDone) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            drawPainter(end, maxAlpha)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Initialize startTimeMillis the first time we&#x27;re drawn.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val uptimeMillis = SystemClock.uptimeMillis()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (startTimeMillis == -1L) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            startTimeMillis = uptimeMillis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Alphaçš„ç™¾åˆ†æ¯” = (å½“å‰æ—¶é—´ - å¼€å§‹æ—¶é—´) / æŒç»­æ—¶é—´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val percent = (uptimeMillis - startTimeMillis) / durationMillis.toFloat()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val endAlpha = percent.coerceIn(0f, 1f) * maxAlpha</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val startAlpha = if (fadeStart) maxAlpha - endAlpha else maxAlpha</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isDone = percent &gt;= 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Loadingå ä½å›¾æ¸å‡ºï¼ŒSuccesså›¾ç‰‡ç»“æœæ¸å…¥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        drawPainter(start, startAlpha)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        drawPainter(end, endAlpha)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isDone) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            start = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Increment this value to force the painter to be redrawn.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            invalidateTick++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ç°åœ¨æ¥æ€»ç»“ä¸€ä¸‹Coilè¿œç¨‹å›¾ç‰‡æ‰©å±•çš„å®ç°æ€è·¯ï¼š</p><ol><li><p>å›¾ç‰‡åŠ è½½ï¼šCoilå¯¹åç¨‹æä¾›ç›´æ¥çš„æ”¯æŒï¼Œ<code>size</code>å‡½æ•°ã€<code>execute</code>åŠ è½½å‡½æ•°æœ¬èº«å°±æ˜¯æŒ‚èµ·å‡½æ•°ï¼Œå› æ­¤æ— éœ€é¢å¤–çš„è½¬æ¢é€»è¾‘ã€‚è€Œ<code>AsyncImagePainter</code>åˆ™ä½¿ç”¨Jobæ¥æ§åˆ¶å›¾ç‰‡åŠ è½½åç¨‹ã€‚</p><p><code>AsyncImagePainter</code>å¹¶ä¸å…·æœ‰@Composableä¸Šä¸‹æ–‡ï¼Œä½œä¸ºæ›¿ä»£ï¼Œå®ƒå®ç°äº†<code>RememberObserver</code>æ¥ç›‘å¬æ§ä»¶æ˜¯å¦å·²ç»ç¦»å±é”€æ¯ã€‚</p></li><li><p>å›¾ç‰‡å¤§å°çº¦æŸï¼šä¾èµ–äº<code>DrawContext</code>çš„Sizeã€‚</p></li><li><p>æ¸å…¥åŠ¨ç”»å®ç°ï¼šä¾èµ–äº<code>DrawScope.onDraw()</code>å†…çš„é‡ç»˜è¡Œä¸ºï¼Œé€šè¿‡å¯¹é€æ˜åº¦Alphaçš„ç™¾åˆ†æ¯”è®¡ç®—æ¥å®ç°ï¼Œä»¤LoadingçŠ¶æ€çš„å ä½å›¾æ¸å‡ºï¼ŒSuccessçŠ¶æ€çš„æœ€ç»ˆç»“æœæ¸å…¥ã€‚</p></li><li><p>loadingå ä½å›¾ã€errorå›¾ç­‰ï¼šç”±Coilæä¾›å…·ä½“çš„å®ç°ã€‚</p></li></ol><p>æ ¹æ®ä¸Šè¿°åˆ†ææˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç›¸æ¯”äºGlideæˆ–æ˜¯Picassoï¼ŒåŸºäºKotlinåç¨‹å®ç°çš„å›¾ç‰‡åŠ è½½åº“Coilï¼Œçš„ç¡®èƒ½å¤Ÿå¾ˆè½»æ¾ä¸Jetpack Composeé…åˆå·¥ä½œã€‚</p><p>è‡³æ­¤å¯¹æ‰©å±•åº“çš„åˆ†æå·²ç»å®Œæ¯•ã€‚æ¨ªå‘å¯¹æ¯”æ¥è¯´ï¼Œæ— è®ºæ˜¯å¯¹Picassoè¿˜æ˜¯Glideè¿›è¡Œæ‰©å±•ï¼Œæˆ‘ä»¬éƒ½å¾—é¢å¤–åšä¸€äº›å¤„ç†ï¼Œæ‰èƒ½å¤Ÿä»¤æœ¬èº«ä¸æ”¯æŒåç¨‹çš„å®ƒä»¬åœ¨Composeä¸‹æ­£å¸¸å·¥ä½œã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œå•çº¯ä½¿ç”¨è‡ªå®šä¹‰çš„TargetæŠŠç»“æœè¿”å›åˆ°æŸä¸ªStateï¼Œè¿™ç§ç®€å•çš„åšæ³•åœ¨åˆ—è¡¨ä¸­å¯èƒ½ä¼šé‡åˆ°ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºGlideä¹Ÿå¥½ï¼ŒPicassoä¹Ÿå¥½ï¼Œå®ƒä»¬å†…éƒ¨å®ç°ä¸­å–æ¶ˆå›¾ç‰‡åŠ è½½ä»¥é¿å…å›¾ç‰‡é”™ä½ã€é—ªçƒçš„é‡è¦å‚ç…§ç‰©å°±æ˜¯ImageViewï¼Œéšç€åˆ—è¡¨æ»‘åŠ¨ä¸æ–­åˆ›å»ºçš„è‡ªå®šä¹‰çš„Targetæ— æ³•è¢«å®ƒä»¬è¯†åˆ«å¹¶è¿›è¡Œç›¸åº”å¤„ç†ã€‚ç›¸æ¯”ä¹‹ä¸‹åŸºäºåç¨‹çš„Coilçš„åŠ è½½èƒ½å¤Ÿå˜å¾—ç®€å•å¾—å¤šï¼Œæˆ‘ä»¬åªéœ€è¦åˆ©ç”¨Jobæœ¬èº«å°±å¯ä»¥æ§åˆ¶åŠ è½½çš„åç¨‹ã€‚</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/compose-museum/jetpack-compose-book/tree/master/docs/principle/composeRemoteImage.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/principle/composeAnnotation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Compose æ³¨è§£åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#å‰è¨€" class="table-of-contents__link toc-highlight">å‰è¨€</a></li><li><a href="#picassoin-version-062" class="table-of-contents__link toc-highlight">Picasso(in version 0.6.2)</a></li><li><a href="#glidein-version-0130" class="table-of-contents__link toc-highlight">Glide(in version 0.13.0)</a></li><li><a href="#coil" class="table-of-contents__link toc-highlight">Coil</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ç¤¾åŒº</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/compose-museum" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Jetpack Compose åšç‰©é¦†, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ae8d57c9.js"></script>
<script src="/assets/js/main.50fd7d2b.js"></script>
</body>
</html>