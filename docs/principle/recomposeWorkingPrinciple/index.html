<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">é‡ç»„çš„å·¥ä½œæµç¨‹ | ä½ å¥½ Compose</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://jetpackcompose.cn/docs/principle/recomposeWorkingPrinciple"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="é‡ç»„çš„å·¥ä½œæµç¨‹ | ä½ å¥½ Compose"><meta data-react-helmet="true" name="description" content="æˆ‘ä»¬éƒ½çŸ¥é“ Jetpack Compose æ˜¯ä¸€å¥—å£°æ˜å¼ UI ç³»ç»Ÿï¼Œå½“ UI ç»„ä»¶æ‰€ä¾èµ–çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ä¼šè‡ªåŠ¨å‘ç”Ÿé‡ç»˜åˆ·æ–°ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«å®˜æ–¹ç§°ä½œé‡ç»„ï¼Œå‰é¢å·²ç»æ€»ç»“è¿‡ Compose çš„é‡ç»„èŒƒå›´ï¼Œä»¥åŠ é‡ç»„è¿‡ç¨‹ä½¿ç”¨çš„Snapshotã€‚æœ¬æ–‡å°†å¸¦é¢†å¤§å®¶æ¥çœ‹çœ‹ Compose æºç ä¸­ä»çŠ¶æ€æ›´æ–°åˆ° recompose è¿‡ç¨‹åœ¨æºç ä¸­æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Œå¹¶ä¸”è®²è§£å¿«ç…§ç³»ç»Ÿåœ¨ recompose è¿‡ç¨‹ä¸­å¦‚ä½•è¢«ä½¿ç”¨åˆ°çš„ã€‚"><meta data-react-helmet="true" property="og:description" content="æˆ‘ä»¬éƒ½çŸ¥é“ Jetpack Compose æ˜¯ä¸€å¥—å£°æ˜å¼ UI ç³»ç»Ÿï¼Œå½“ UI ç»„ä»¶æ‰€ä¾èµ–çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ä¼šè‡ªåŠ¨å‘ç”Ÿé‡ç»˜åˆ·æ–°ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«å®˜æ–¹ç§°ä½œé‡ç»„ï¼Œå‰é¢å·²ç»æ€»ç»“è¿‡ Compose çš„é‡ç»„èŒƒå›´ï¼Œä»¥åŠ é‡ç»„è¿‡ç¨‹ä½¿ç”¨çš„Snapshotã€‚æœ¬æ–‡å°†å¸¦é¢†å¤§å®¶æ¥çœ‹çœ‹ Compose æºç ä¸­ä»çŠ¶æ€æ›´æ–°åˆ° recompose è¿‡ç¨‹åœ¨æºç ä¸­æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Œå¹¶ä¸”è®²è§£å¿«ç…§ç³»ç»Ÿåœ¨ recompose è¿‡ç¨‹ä¸­å¦‚ä½•è¢«ä½¿ç”¨åˆ°çš„ã€‚"><link data-react-helmet="true" rel="icon" href="/img/logo.svg"><link data-react-helmet="true" rel="canonical" href="https://jetpackcompose.cn/docs/principle/recomposeWorkingPrinciple"><link data-react-helmet="true" rel="alternate" href="https://jetpackcompose.cn/docs/principle/recomposeWorkingPrinciple" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://jetpackcompose.cn/docs/principle/recomposeWorkingPrinciple" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.cba56bc1.css">
<link rel="preload" href="/assets/js/runtime~main.8d46e49c.js" as="script">
<link rel="preload" href="/assets/js/main.4fa214f8.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Jetpack Compose åšç‰©é¦†</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/docs/open-source-project/compose-douban">å¼€æºé¡¹ç›®</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/milklabdev/jetpack-compose-book" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ğŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ğŸŒ</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">å†™åœ¨å¼€å¤´</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/å…¥é—¨">å…¥é—¨</a><button aria-label="Toggle the collapsible sidebar category &#x27;å…¥é—¨&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation">å®‰è£…æˆ–æ›´æ–° Android Studio</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial">åˆè¯† Jetpack Compose</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/elements/alertdialog">åŸºç¡€ç»„ä»¶</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/layout/box">å¸ƒå±€ç»„ä»¶</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/è®¾è®¡">è®¾è®¡</a><button aria-label="Toggle the collapsible sidebar category &#x27;è®¾è®¡&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/åŠ¨ç”»animation">åŠ¨ç”»ï¼ˆAnimationï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;åŠ¨ç”»ï¼ˆAnimationï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/ä¸»é¢˜theming">ä¸»é¢˜ï¼ˆThemingï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;ä¸»é¢˜ï¼ˆThemingï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/æ‰‹åŠ¿gesture">æ‰‹åŠ¿ï¼ˆGestureï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;æ‰‹åŠ¿ï¼ˆGestureï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/åˆ—è¡¨lists">åˆ—è¡¨ï¼ˆListsï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;åˆ—è¡¨ï¼ˆListsï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/å›¾å½¢graphics">å›¾å½¢ï¼ˆGraphicsï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;å›¾å½¢ï¼ˆGraphicsï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/resources">èµ„æº</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/docs/category/æŠ€æœ¯åŸç†">æŠ€æœ¯åŸç†</a><button aria-label="Toggle the collapsible sidebar category &#x27;æŠ€æœ¯åŸç†&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/recompositionScope">äº†è§£ Compose çš„é‡ç»„ä½œç”¨åŸŸ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/snapshot">é€è¿‡ Snapshot çœ‹é‡ç»„</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/principle/recomposeWorkingPrinciple">é‡ç»„çš„å·¥ä½œæµç¨‹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/gapBuffer">Compose è¿è¡ŒåŸç†ä¸ GapBuffer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/modifierStructure">å›¾è§£ Modifier</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/composeAnnotation">Compose æ³¨è§£åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/composeRemoteImage">å¦‚ä½•ä¸ºCompose Imageæä¾›ç½‘ç»œå›¾ç‰‡åŠ è½½æ”¯æŒ</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>é‡ç»„çš„å·¥ä½œæµç¨‹</h1></header><p>æˆ‘ä»¬éƒ½çŸ¥é“ Jetpack Compose æ˜¯ä¸€å¥—å£°æ˜å¼ UI ç³»ç»Ÿï¼Œå½“ UI ç»„ä»¶æ‰€ä¾èµ–çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ä¼šè‡ªåŠ¨å‘ç”Ÿé‡ç»˜åˆ·æ–°ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«å®˜æ–¹ç§°ä½œ<strong>é‡ç»„</strong>ï¼Œå‰é¢å·²ç»æ€»ç»“è¿‡ <a href="/docs/principle/recompositionScope/">Compose çš„é‡ç»„èŒƒå›´</a>ï¼Œä»¥åŠ <a href="/docs/principle/snapshot/">é‡ç»„è¿‡ç¨‹ä½¿ç”¨çš„Snapshot</a>ã€‚æœ¬æ–‡å°†å¸¦é¢†å¤§å®¶æ¥çœ‹çœ‹ Compose æºç ä¸­ä»çŠ¶æ€æ›´æ–°åˆ° recompose è¿‡ç¨‹åœ¨æºç ä¸­æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Œå¹¶ä¸”è®²è§£å¿«ç…§ç³»ç»Ÿåœ¨ recompose è¿‡ç¨‹ä¸­å¦‚ä½•è¢«ä½¿ç”¨åˆ°çš„ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="æ„ä¹‰">æ„ä¹‰<a class="hash-link" href="#æ„ä¹‰" title="Direct link to heading">â€‹</a></h2><p>æœ¬æ–‡é€šè¿‡é˜…è¯»æºç æ¥è§£è¯» recompose æµç¨‹ï¼Œé˜…è¯»æºç å…¶å®æ˜¯ä¸€ä¸ªéå¸¸æ¯ç‡¥çš„è¿‡ç¨‹ï¼Œæºç ä¸­å­˜åœ¨ç€å¤§é‡é€»è¾‘åˆ†æ”¯å¯¼è‡´è®¸å¤šäººçœ‹ç€çœ‹ç€å°±è¢«ç»•æ™•äº†ã€‚æœ¬æ–‡å‰”é™¤äº†æ‰€æœ‰ä¸ä¸»çº¿æµç¨‹æ— å…³çš„é€»è¾‘åˆ†æ”¯ï¼Œå¹¶ç»“åˆé…å›¾è¿›è¡Œé€»è¾‘è¡¨è¾¾ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©å¤§å®¶ç†è§£ recompose å·¥ä½œåŸç†ã€‚é€šè¿‡è¿™ç¯‡æ–‡ç« å¸Œæœ›å¤§å®¶èƒ½å¤Ÿå¯¹ recomposeå·¥ä½œåŸç†äº§ç”Ÿä¸€ç§æ„Ÿæ€§è®¤çŸ¥ï¼Œå¹¶åœ¨æœ¬æ–‡çš„åŸºç¡€ä¸Šèƒ½å¤Ÿç»§ç»­æ·±å…¥æ¢ç´¢recomposeæµç¨‹ä¸­çš„å„ç§æŠ€æœ¯ç»†èŠ‚ã€‚</p><p> âš ï¸ Tipsï¼šç”±äº recompose æµç¨‹ååˆ†å¤æ‚ï¼Œæœ¬æ–‡ç›®å‰ä»…å¯¹ recompose ä¸»çº¿æµç¨‹è¿›è¡Œäº†æè¿°ï¼Œå…¶ä¸­åŒ…å«çš„è®¸å¤šæŠ€æœ¯ç»†èŠ‚æ²¡æœ‰æ·±æŒ–ã€‚ç”±äºæœ¬äººé‡‡ç”¨åŠ¨é™ç»“åˆæ–¹å¼è¿›è¡Œæºç åˆ†æï¼Œéš¾å…å‡ºç°æœ‰äº›caseæµç¨‹æ²¡æœ‰è¦†ç›–åˆ°çš„æƒ…å†µï¼Œå¦‚æœæ–‡ç« å­˜åœ¨é”™è¯¯æ¬¢è¿æå‡ºã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="recompose-æµç¨‹åˆ†æ">recompose æµç¨‹åˆ†æ<a class="hash-link" href="#recompose-æµç¨‹åˆ†æ" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="ä»-mutablestate-æ›´æ–°å¼€å§‹">ä» MutableState æ›´æ–°å¼€å§‹<a class="hash-link" href="#ä»-mutablestate-æ›´æ–°å¼€å§‹" title="Direct link to heading">â€‹</a></h3><p>å½“ä½ ä¸º MutableState èµ‹å€¼æ—¶å°†ä¼šé»˜è®¤è°ƒç”¨ MutableState çš„æ‰©å±•æ–¹æ³• <code>MutableState.setValue</code> </p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.SnapshotState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inline operator fun &lt;T&gt; MutableState&lt;T&gt;.setValue(thisObj: Any?, property: KProperty&lt;*&gt;, value: T) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.value = value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>é€šè¿‡æŸ¥çœ‹ <code>mutableStateOf</code> æºç æˆ‘ä»¬å¯ä»¥å‘ç° MutableState å®é™…ä¸Šæ˜¯ä¸€ä¸ª <code>SnapshotMutableStateImpl</code> ç±»å‹å®ä¾‹</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.SnapshotState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun &lt;T&gt; mutableStateOf(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value: T,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    policy: SnapshotMutationPolicy&lt;T&gt; = structuralEqualityPolicy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): MutableState&lt;T&gt; = createSnapshotMutableState(value, policy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.ActualAndroid.android</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal actual fun &lt;T&gt; createSnapshotMutableState(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value: T,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    policy: SnapshotMutationPolicy&lt;T&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): SnapshotMutableState&lt;T&gt; = ParcelableSnapshotMutableState(value, policy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.ParcelableSnapshotMutableState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal class ParcelableSnapshotMutableState&lt;T&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value: T,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    policy: SnapshotMutationPolicy&lt;T&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) : SnapshotMutableStateImpl&lt;T&gt;(value, policy), Parcelable </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å½“ <code>value</code> å±æ€§å‘ç”Ÿæ”¹å˜æ—¶ä¼šè°ƒç”¨è¿™ä¸ªå±æ€§çš„ setter ï¼Œå½“ç„¶å¦‚æœè¯»å–çŠ¶æ€æ—¶ä¹Ÿä¼šèµ° getterã€‚</p><p>æ­¤æ—¶çš„nextæ˜¯ä¸ª <code>StateStateRecord</code> å®ä¾‹ï¼Œå…¶çœŸæ­£è®°å½•ç€å½“å‰stateçŠ¶æ€ä¿¡æ¯(é€šè¿‡å½“å‰valueçš„getterä¸setterå°±å¯ä»¥çœ‹å‡º)ã€‚æ­¤æ—¶é¦–å…ˆä¼šå¯¹å½“å‰å€¼å’Œè¦æ›´æ–°çš„å€¼æ ¹æ®è§„åˆ™è¿›è¡Œdiffåˆ¤æ–­ã€‚å½“ç¡®å®šå‘ç”Ÿæ”¹å˜æ—¶ä¼šè°ƒç”¨åˆ° StateStateRecord çš„ overwritable æ–¹æ³•ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.SnapshotState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal open class SnapshotMutableStateImpl&lt;T&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value: T,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override val policy: SnapshotMutationPolicy&lt;T&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) : StateObject, SnapshotMutableState&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Suppress(&quot;UNCHECKED_CAST&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override var value: T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        get() = next.readable(this).value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        set(value) = next.withCurrent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!policy.equivalent(it.value, value)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æ­¤æ—¶çš„thisè¿˜æ˜¯å½“å‰SnapshotMutableStateImpl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                next.overwritable(this, it) { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  this.value = value // æ­¤æ—¶çš„thisæŒ‡å‘çš„nextï¼Œè¿™éƒ¨æ“ä½œä¹Ÿå°±æ˜¯æ›´æ–°nextå…¶ä¸­çš„value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æ¥ä¸‹æ¥ä¼šé€šè¿‡ <code>Snapshot.current</code> è·å–å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„ Snapshotï¼Œå¦‚æœä½ å¯¹ mutableState æ›´æ–°æ“ä½œåœ¨å¼‚æ­¥æ‰§è¡Œä»£ç å—ä¸­ï¼Œç”±äºæˆ‘ä»¬çŸ¥é“ Snapshot æ˜¯ä¸€ä¸ª ThreadLocal æ­¤æ—¶ä¼šè¿”å›å½“å‰æ‰§è¡Œçº¿ç¨‹çš„ Snapshotï¼Œå½“è‹¥å½“å‰æ‰§è¡Œçº¿ç¨‹çš„ Snapshot ä¸ºç©ºæ—¶é»˜è®¤è¿”å› <code>GlobalSnapshot</code>ï¼Œå¦‚æœä½ å¯¹ mutableState æ›´æ–°æ“ä½œç›´æ¥åœ¨ Composable ä¸­ï¼Œå½“å‰ Composable æ‰§è¡Œçº¿ç¨‹çš„ Snapshot å°±æ˜¯ <code>MutableSnapshot</code>ã€‚è¿™å°†ä¼šå½±å“åˆ°åç»­ recompose çš„æ‰§è¡Œæµç¨‹ã€‚</p><p> âš ï¸ Tipsï¼šGlobalSnapshot å®é™…ä¸Šæ˜¯ MutableSnapShot çš„å­ç±»</p><img src="/assets/images/demo1-e395e884114b85356f600b519382676d.png"><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.snapshots.Snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal inline fun &lt;T : StateRecord, R&gt; T.overwritable(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state: StateObject,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    candidate: T,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    block: T.() -&gt; R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): R {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var snapshot: Snapshot = snapshotInitializer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return sync {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        snapshot = Snapshot.current</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.overwritableRecord(state, snapshot, candidate).block() // æ›´æ–° next</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }.also {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        notifyWrite(snapshot, state) // å†™å…¥é€šçŸ¥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æˆ‘ä»¬è¿›å…¥ <code>overwritableRecord </code> çœ‹çœ‹å…¶ä¸­åšäº†ä»€ä¹ˆï¼Œæ³¨æ„æ­¤æ—¶ state å…¶å®æ˜¯ mutableStateã€‚åœ¨è¿™å…¶ä¸­é€šè¿‡ <code>recordModified</code> æ–¹æ³•è®°å½•äº†ä¿®æ”¹ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ­¤æ—¶å°†å½“å‰ä¿®æ”¹çš„ state æ·»åŠ åˆ°å½“å‰ Snapshot çš„ modified ä¸­äº†ï¼Œè¿™ä¸ªåç»­ä¼šç”¨åˆ°çš„ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.snapshots.Snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal fun &lt;T : StateRecord&gt; T.overwritableRecord(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state: StateObject,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snapshot: Snapshot,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    candidate: T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): T {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (snapshot.readOnly) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        snapshot.recordModified(state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val id = snapshot.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (candidate.snapshotId == id) return candidate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val newData = newOverwritableRecord(state, snapshot)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newData.snapshotId = id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snapshot.recordModified(state) // è®°å½•ä¿®æ”¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return newData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.snapshots.Snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">override fun recordModified(state: StateObject) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (modified ?: HashSet&lt;StateObject&gt;().also { modified = it }).add(state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å¯èƒ½ä½ å¯¹ mutableState æ›´æ–°æ“ä½œæ˜¯å¦åœ¨ ComposeScope ä¸­è€Œæ„Ÿåˆ°å›°æƒ‘ï¼Œä¸¾ä¸ªä¾‹å­å…¶å®å°±æ˜ç™½äº†ã€‚recompose èƒ½å¤Ÿæ‰§è¡Œåˆ°å°±åœ¨ ComposeScope ä¸­ï¼Œä¸èƒ½æ‰§è¡Œåˆ°å°±ä¸åœ¨ ComposeScope ä¸­ã€‚</p><p>è¿™ä¸ªåœ¨åé¢ <a href="#takemutablesnapshot"><strong><em>takeMutableSnapshotè¯»è§‚å¯Ÿè€…ä¸å†™è§‚å¯Ÿè€…</em></strong> </a> éƒ¨åˆ†æ˜¯ä¼šè¿›è¡Œè§£é‡Šã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">var display by mutableStateOf(&quot;Init&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Preview</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun Demo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Text (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        text = display,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fontSize = 50.sp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modifier = Modifier.clickable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            display = &quot;change&quot; // recomposeä¸èƒ½æ‰§è¡Œåˆ°ï¼Œæ­¤æ—¶æ˜¯ GlobalSnapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display = &quot;change&quot; // recomposeèƒ½å¤Ÿæ‰§è¡Œåˆ°ï¼Œæ­¤æ—¶æ˜¯ MutableSnapShot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æ¥ä¸‹æ¥å°±æ˜¯é€šè¿‡ <code>notifyWrite</code> æ‰§è¡Œäº‹ä»¶é€šçŸ¥æ­¤æ—¶å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†å†™è§‚å¯Ÿè€… <code>writeObserver</code> ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.snapshots.Snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PublishedApi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal fun notifyWrite(snapshot: Snapshot, state: StateObject) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snapshot.writeObserver?.invoke(state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æ­¤æ—¶ä¼šæ ¹æ®å½“å‰ Snapshot ä¸åŒè€Œè°ƒç”¨åˆ°ä¸åŒçš„å†™è§‚å¯Ÿè€… <code>writeObserver</code> ã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="globalsnapshot-å†™å…¥é€šçŸ¥">GlobalSnapshot å†™å…¥é€šçŸ¥<a class="hash-link" href="#globalsnapshot-å†™å…¥é€šçŸ¥" title="Direct link to heading">â€‹</a></h3><p>å…¨å±€çš„å†™å…¥è§‚å¯Ÿè€…æ˜¯åœ¨ <code>setContent</code> æ—¶å°±è¿›è¡Œäº†æ³¨å†Œï¼Œ æ­¤æ—¶ä¼šå›è°ƒ registerGlobalWriteObserver çš„å°¾lambdaï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œå°±ä¸€ä¸ªchannel (æ²¡é”™å°±æ˜¯Kotlinåç¨‹é‚£ä¸ªçƒ­æ•°æ®é€šé“Channel)ï¼Œæˆ‘é—¨å¯ä»¥çœ‹åˆ°å¾ˆå®¹æ˜“çœ‹åˆ°åœ¨ä¸Šæ–¹ä»¥AndroidUiDispatcher.Main ä½œä¸ºè°ƒåº¦å™¨çš„ CoroutineScope ä¸­è¿›è¡Œäº†æŒ‚èµ·ç­‰å¾…æ¶ˆè´¹ï¼Œæ‰€ä»¥æ‰§è¡Œæµç¨‹è‡ªç„¶ä¼šè¿›åˆ°äº† <code>sendApplyNotifications()</code> ã€‚ ï¼ˆAndroidUiDispatcher.Main ä¸ Choreographer æ¯æ¯ç›¸å…³ï¼Œç¯‡å¹…æœ‰é™å°±ä¸å±•å¼€è®¨è®ºäº†ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±å»è·Ÿæºç ï¼‰</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">internal object GlobalSnapshotManager {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val started = AtomicBoolean(false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun ensureStarted() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (started.compareAndSet(false, true)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val channel = Channel&lt;Unit&gt;(Channel.CONFLATED)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CoroutineScope(AndroidUiDispatcher.Main).launch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.consumeEach {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Snapshot.sendApplyNotifications()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Snapshot.registerGlobalWriteObserver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.offer(Unit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="sendapplynotifications">sendApplyNotifications<a class="hash-link" href="#sendapplynotifications" title="Direct link to heading">â€‹</a></h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥ <code>sendApplyNotifications()</code> å…¶ä¸­çœ‹çœ‹åšäº†ä»€ä¹ˆï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨æˆ‘ä»¬å‰é¢æåˆ°çš„é‚£ä¸ª <code>modified</code> ï¼Œå½“å‘ç”Ÿä¿®æ”¹æ—¶ changes å¿…ç„¶ä¸º trueï¼Œæ‰€ä»¥æ¥ç€ä¼šè°ƒç”¨åˆ° <code>advanceGlobalSnapshot</code></p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.snapshots.Snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun sendApplyNotifications() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val changes = sync {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            currentGlobalSnapshot.get().modified?.isNotEmpty() == true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (changes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            advanceGlobalSnapshot()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹è·Ÿä¸‹å»èµ°åˆ°äº† <code>advanceGlobalSnapshot</code> ï¼Œæ­¤æ—¶å°†æ‰€æœ‰ <code>modified</code> å–å‡ºå¹¶ä¾¿åˆ©è°ƒç”¨ <code>applyObservers</code> ä¸­åŒ…å«çš„æ‰€æœ‰è§‚å¯Ÿè€…ã€‚ </p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.snapshots.Snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun advanceGlobalSnapshot() = advanceGlobalSnapshot { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun &lt;T&gt; advanceGlobalSnapshot(block: (invalid: SnapshotIdSet) -&gt; T): T {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val previousGlobalSnapshot = currentGlobalSnapshot.get()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val result = sync {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        takeNewGlobalSnapshot(previousGlobalSnapshot, block)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val modified = previousGlobalSnapshot.modified</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (modified != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val observers: List&lt;(Set&lt;Any&gt;, Snapshot) -&gt; Unit&gt; = sync { applyObservers.toMutableList() }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        observers.fastForEach { observer -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            observer(modified, previousGlobalSnapshot)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="applyobserversä¹‹recompositionrunne">applyObserversä¹‹recompositionRunne<a class="hash-link" href="#applyobserversä¹‹recompositionrunne" title="Direct link to heading">â€‹</a></h4><img src="/assets/images/demo2-1f4b6bb80982173559050b56e5455e1c.png"><p>æ®æˆ‘è°ƒæŸ¥æ­¤æ—¶ <code>applyObservers</code> ä¸­åŒ…å«çš„è§‚å¯Ÿè€…ä»…æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ <code>SnapshotStateObserver.applyObserver</code> ç”¨æ¥æ›´æ–°å¿«ç…§çŠ¶æ€ä¿¡æ¯ï¼Œå¦ä¸€ä¸ªå°±æ˜¯ <code>recompositionRunner</code> ç”¨æ¥å¤„ç† recomposeæµç¨‹ çš„ã€‚ç”±äºæˆ‘ä»¬æ˜¯åœ¨ç ”ç©¶recompose æµç¨‹çš„æ‰€ä»¥å°±ä¸åˆ†å¼€å»è®¨è®ºäº†ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å¤„ç† recompose çš„ observer éƒ½åšäº†ä»€ä¹ˆï¼Œé¦–å…ˆä»–å°†æ‰€æœ‰æ”¹å˜çš„ <code>mutableState</code> æ·»åŠ åˆ°äº† <code>snapshotInvalidations</code>ï¼Œè¿™ä¸ªåç»­ä¼šç”¨åˆ°ã€‚åé¢å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªresumeï¼Œè¯´æ˜lambdaçš„æœ€åè°ƒç”¨çš„ <code>deriveStateLocked</code> è¿”å›äº†ä¸€ä¸ªåç¨‹ Continuation å®ä¾‹ã€‚ä½¿å¾—æŒ‚èµ·ç‚¹ä½ç½®æ¢å¤æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬è¿›å…¥<code>deriveStateLocked </code> çœ‹çœ‹è¿™ä¸ªåç¨‹ Continuation å®ä¾‹åˆ°åº•æ˜¯è°ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OptIn(ExperimentalComposeApi::class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private suspend fun recompositionRunner(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    block: suspend CoroutineScope.(parentFrameClock: MonotonicFrameClock) -&gt; Unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    withContext(broadcastFrameClock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è´Ÿè´£å¤„ç† recompose çš„ observer å°±æ˜¯ä»–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val unregisterApplyObserver = Snapshot.registerApplyObserver { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            changed, _ -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                synchronized(stateLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (_state.value &gt;= State.Idle) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        snapshotInvalidations += changed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        deriveStateLocked()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }?.resume(Unit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>é€šè¿‡å‡½æ•°è¿”å›å€¼å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªå¯å–æ¶ˆçš„Continuationå®ä¾‹ <code>workContinuation</code>ï¼Œ</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun deriveStateLocked(): CancellableContinuation&lt;Unit&gt;? {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return if (newState == State.PendingWork) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        workContinuation.also {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                workContinuation = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>é‚£è¿™ä¸ªworkContinuationæ˜¯åœ¨å“ªé‡Œèµ‹å€¼çš„å‘¢ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±æ‰¾åˆ°äº†å…¶å”¯ä¸€è¢«èµ‹å€¼çš„åœ°æ–¹ã€‚æ­¤æ—¶ workContinuation å°±æ˜¯ coï¼Œæ­¤æ—¶resumeä¹Ÿå°±æ˜¯æ¢å¤æ‰§è¡Œ <code>awaitWorkAvailable</code> è°ƒç”¨æŒ‚èµ·ç‚¹ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private suspend fun awaitWorkAvailable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!hasSchedulingWork) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        suspendCancellableCoroutine&lt;Unit&gt; { co -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            synchronized(stateLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (hasSchedulingWork) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    co.resume(Unit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    workContinuation = co</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="runrecomposeandapplychanges-ä¸‰æ­¥éª¤">runRecomposeAndApplyChanges ä¸‰æ­¥éª¤<a class="hash-link" href="#runrecomposeandapplychanges-ä¸‰æ­¥éª¤" title="Direct link to heading">â€‹</a></h4><p>æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°åœ¨ <code>runRecomposeAndApplyChanges</code> ä¸­è°ƒç”¨ <code>awaitWorkAvailable</code> è€Œäº§ç”Ÿäº†æŒ‚èµ·ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šæ¢å¤è°ƒç”¨ <code>runRecomposeAndApplyChanges</code> ï¼Œè¿™é‡Œä¸»è¦æœ‰ä¸‰æ­¥æ“ä½œæ¥ä¸‹æ¥è¿›è¡Œä»‹ç»</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">suspend fun runRecomposeAndApplyChanges() = recompositionRunner { parentFrameClock -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val toRecompose = mutableListOf&lt;ControlledComposition&gt;()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val toApply = mutableListOf&lt;ControlledComposition&gt;()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (shouldKeepRecomposing) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        awaitWorkAvailable()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä»è¿™å¼€å§‹æ¢å¤æ‰§è¡Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            synchronized(stateLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!hasFrameWorkLocked) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ­¥éª¤1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    recordComposerModificationsLocked()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    !hasFrameWorkLocked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç­‰å¾…Vsyncä¿¡å·ï¼Œç±»ä¼¼äºä¼ ç»ŸViewç³»ç»Ÿä¸­scheduleTraversals?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parentFrameClock.withFrameNanos { frameTime -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            trace(&quot;Recomposer:recompose&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                synchronized(stateLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    recordComposerModificationsLocked()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        // æ­¥éª¤2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    compositionInvalidations.fastForEach { toRecompose += it }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    compositionInvalidations.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                val modifiedValues = IdentityArraySet&lt;Any&gt;()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                val alreadyComposed = IdentityArraySet&lt;ControlledComposition&gt;()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                while (toRecompose.isNotEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        toRecompose.fastForEach { composition -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            alreadyComposed.add(composition)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // æ­¥éª¤3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            performRecompose(composition, modifiedValues)?.let {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                toApply += it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        toRecompose.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å¯¹äºè¿™ä¸‰ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹é¦–å…ˆæ˜¯æ­¥éª¤1è°ƒç”¨äº† <code>recordComposerModificationsLocked</code> æ–¹æ³•ï¼Œ è¿˜è®°å¾— <code>snapshotInvalidations</code> å˜›, ä»–è®°å½•ç€æ‰€æœ‰æ›´æ”¹çš„ mutableStateï¼Œæ­¤æ—¶å›è°ƒæ‰€æœ‰å·²çŸ¥compositionçš„<code>recordModificationsOf</code> æ–¹æ³•ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun recordComposerModificationsLocked() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (snapshotInvalidations.isNotEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        snapshotInvalidations.fastForEach { changes -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            knownCompositions.fastForEach { composition -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                composition.recordModificationsOf(changes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        snapshotInvalidations.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (deriveStateLocked() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            error(&quot;called outside of runRecomposeAndApplyChanges&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ç»è¿‡ä¸€ç³»åˆ—è°ƒç”¨ä¼šå°†æ‰€æœ‰ä¾èµ–å½“å‰ mutableState çš„æ‰€æœ‰ Composable Scope å­˜å…¥åˆ° <code>compositionInvalidations</code> è¿™ä¸ª List ä¸­ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal override fun invalidate(composition: ControlledComposition) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized(stateLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (composition !in compositionInvalidations) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            compositionInvalidations += composition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            deriveStateLocked()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }?.resume(Unit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>æ­¥éª¤2å°±å¾ˆç®€å•äº†ï¼Œå°† compositionInvalidations çš„æ‰€æœ‰å…ƒç´ è½¬ç§»åˆ°äº† toRecomposeï¼Œè€Œæ­¥éª¤3åˆ™æ˜¯ recomposeçš„é‡ä¸­ä¹‹é‡ï¼Œé€šè¿‡ <code>performRecompose</code> ä½¿æ‰€æœ‰å—åˆ°å½±å“çš„ Composable Scope é‡æ–°æ‰§è¡Œã€‚</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="performrecompose">performRecompose<a class="hash-link" href="#performrecompose" title="Direct link to heading">â€‹</a></h4><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>performRecompose</code> ä¸­é—´æ¥è°ƒç”¨äº† <code>composing</code> ï¼Œè€Œå…¶ä¸­æœ€å…³é”® <code>recompose</code> ä¹Ÿåœ¨å›è°ƒä¸­å®Œæˆï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å†è¿›å…¥ <code>composing</code> çœ‹çœ‹ä»€ä¹ˆæ—¶å€™ä¼šå›è°ƒã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun performRecompose(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    composition: ControlledComposition,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifiedValues: IdentityArraySet&lt;Any&gt;?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): ControlledComposition? {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (composition.isComposing || composition.isDisposed) return null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return if (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        composing(composition, modifiedValues) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (modifiedValues?.isNotEmpty() == true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                composition.prepareCompose {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    modifiedValues.forEach { composition.recordWriteOf(it) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            composition.recompose() // çœŸæ­£å‘ç”Ÿrecomposeçš„åœ°æ–¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) composition else null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> <code>composing</code> å†…éƒ¨é¦–å…ˆæ‹æ‘„äº†ä¸€æ¬¡å¿«ç…§ï¼Œç„¶åå°†æˆ‘ä»¬çš„recomposeè¿‡ç¨‹åœ¨è¿™æ¬¡å¿«ç…§ä¸­æ‰§è¡Œï¼Œæœ€åè¿›è¡Œäº†applyã€‚åˆå…³äºå¿«ç…§ç³»ç»Ÿçš„è®²è§£è¯¦è§ <a href="https://juejin.cn/post/6972692477505437733" target="_blank" rel="noopener noreferrer">ã€ŠJetpack Compose Â· å¿«ç…§ç³»ç»Ÿã€‹</a>ã€‚ </p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private inline fun &lt;T&gt; composing(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  composition: ControlledComposition,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  modifiedValues: IdentityArraySet&lt;Any&gt;?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  block: () -&gt; T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): T {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val snapshot = Snapshot.takeMutableSnapshot(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readObserverOf(composition), writeObserverOf(composition, modifiedValues)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return snapshot.enter(block)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applyAndCheck(snapshot)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="takemutablesnapshot-è¯»è§‚å¯Ÿè€…ä¸å†™è§‚å¯Ÿè€…">takeMutableSnapshot è¯»è§‚å¯Ÿè€…ä¸å†™è§‚å¯Ÿè€…<a class="hash-link" href="#takemutablesnapshot-è¯»è§‚å¯Ÿè€…ä¸å†™è§‚å¯Ÿè€…" title="Direct link to heading">â€‹</a></h4><img src="/assets/images/demo3-bc90ce4942b1404bfe6707c714d052ca.png"><p>å€¼å¾—æ³¨æ„çš„æ˜¯æ­¤æ—¶è°ƒç”¨çš„ <code>takeMutableSnapshot</code> æ–¹æ³•åŒæ—¶ä¼ å…¥äº†ä¸€ä¸ªè¯»è§‚å¯Ÿè€…å’Œå†™è§‚å¯Ÿè€…ï¼Œè€Œè¿™ä¸¤ä¸ªè§‚å¯Ÿè€…åœ¨ä»€ä¹ˆæ—¶æœºå›è°ƒå‘¢ï¼Ÿå½“æˆ‘ä»¬æ¯æ¬¡ recompose æ—¶éƒ½ä¼šæ‹æ‘„ä¸€æ¬¡å¿«ç…§ï¼Œç„¶åæˆ‘ä»¬çš„é‡æ–°æ‰§è¡Œè¿‡ç¨‹åœ¨è¿™æ¬¡å¿«ç…§ä¸­æ‰§è¡Œï¼Œåœ¨é‡æ–°æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœå‡ºç°äº† mutableState çš„è¯»å–æˆ–å†™å…¥æ“ä½œéƒ½ä¼šç›¸åº”çš„å›è°ƒè¿™é‡Œçš„è¯»è§‚å¯Ÿè€…å’Œå†™è§‚å¯Ÿè€…ã€‚ä¹Ÿå°±è¯´æ˜æ¯æ¬¡recomposeéƒ½ä¼šè¿›è¡Œé‡æ–°ä¸€æ¬¡ç»‘å®šã€‚ è¯»è§‚å¯Ÿè€…å›è°ƒæ—¶æœºæ¯”è¾ƒå¥½ç†è§£ï¼Œå†™è§‚å¯Ÿè€…åœ¨ä»€ä¹ˆæ—¶æœºå›è°ƒå‘¢ï¼Ÿ è¿˜è®°å¾—æˆ‘ä»¬åˆšå¼€å§‹è¯´çš„ <code>GlobalSnapshot</code> å’Œ <code>MutableSnapshot</code> å˜›ï¼Ÿ</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬ä¸€ç›´éƒ½åœ¨åˆ†æ <code>GlobalSnapshot</code> è¿™æ¡æ‰§è¡Œè¿‡ç¨‹ï¼Œé€šè¿‡è°ƒç”¨ <code>takeMutableSnapshot</code> å°†è¿”å›ä¸€ä¸ª <code>MutableSnapshot</code> å®ä¾‹ï¼Œæˆ‘ä»¬çš„recomposeé‡æ–°æ‰§è¡Œè¿‡ç¨‹å‘ç”Ÿåœ¨å½“å‰<code>MutableSnapshot</code> å®ä¾‹çš„<code>enter</code> æ–¹æ³•ä¸­ï¼Œæ­¤æ—¶é‡æ–°æ‰§è¡Œè¿‡ç¨‹ä¸­é€šè¿‡è°ƒç”¨<code>Snapshot.current  </code>å°†è¿”å›å½“å‰<code>MutableSnapshot</code> å®ä¾‹ï¼Œæ‰€ä»¥é‡æ–°æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å†™æ“ä½œå°±ä¼šå›è°ƒ <code>takeMutableSnapshot</code> æ‰€ä¼ å…¥çš„å†™è§‚å¯Ÿè€…ã€‚ä¹Ÿå°±æ˜¯ä»¥ä¸‹è¿™ç§æƒ…å†µï¼Œå½“ Demo å‘ç”Ÿrecomposeæ—¶ displayæ‰€åœ¨ Snapshot å°±æ˜¯æ‹æ‘„çš„<code>MutableSnapshot</code> å¿«ç…§ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">var display by mutableStateOf(&quot;Init&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Preview</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun Demo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Text (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        text = display,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fontSize = 50.sp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display = &quot;change&quot; // recomposeèƒ½å¤Ÿæ‰§è¡Œåˆ°ï¼Œæ­¤æ—¶æ˜¯ MutableSnapShot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="mutablesnapshot-å†™å…¥é€šçŸ¥">MutableSnapshot å†™å…¥é€šçŸ¥<a class="hash-link" href="#mutablesnapshot-å†™å…¥é€šçŸ¥" title="Direct link to heading">â€‹</a></h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>takeMutableSnapshot</code> çš„å†™è§‚å¯Ÿè€…æ˜¯å¦‚ä½•å®ç°çš„ã€‚æ­¤æ—¶ä¼šå°†æ›´æ–°çš„å€¼ä¼ å…¥å½“å‰recompose composition çš„ <code>recordWriteOf</code> æ–¹æ³•ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun writeObserverOf(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    composition: ControlledComposition,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifiedValues: IdentityArraySet&lt;Any&gt;?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): (Any) -&gt; Unit {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return { value -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        composition.recordWriteOf(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modifiedValues?.add(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>é€šè¿‡å¯¹äºæµç¨‹åˆ†æå‘ç°ï¼Œå®é™…ä¸Šåœ¨recomposeè¿‡ç¨‹ä¸­è¿›è¡ŒçŠ¶æ€å†™å…¥æ“ä½œæ—¶ï¼Œå¹¶ä¸ä¼šé€šè¿‡å†™è§‚å¯Ÿè€…ç«‹å³è¿›è¡Œrecompose è¿‡ç¨‹ï¼Œè€Œæ˜¯ç­‰å¾…åˆ°å½“å‰recomposeè¿‡ç¨‹ç»“æŸåè¿›è¡Œ apply æ—¶å†è¿›è¡Œé‡æ–° recomposeã€‚</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="applyandcheck">applyAndCheck<a class="hash-link" href="#applyandcheck" title="Direct link to heading">â€‹</a></h4><p>è®©æˆ‘ä»¬å›åˆ°Recomposerçš„ <code>composing</code> æ–¹æ³•ï¼Œæˆ‘ä»¬é€šè¿‡ <code>applyAndCheck</code> å®Œæˆåç»­ apply æ“ä½œã€‚<code>applyAndCheck</code> å†…éƒ¨ä½¿ç”¨äº† <code>MutableSnapshot.apply</code></p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.Recomposer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private inline fun &lt;T&gt; composing(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    composition: ControlledComposition,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifiedValues: IdentityArraySet&lt;Any&gt;?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    block: () -&gt; T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): T {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val snapshot = Snapshot.takeMutableSnapshot(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        readObserverOf(composition), writeObserverOf(composition, modifiedValues)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return snapshot.enter(block)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        applyAndCheck(snapshot) // åœ¨è¿™é‡Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun applyAndCheck(snapshot: MutableSnapshot) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val applyResult = snapshot.apply()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (applyResult is SnapshotApplyResult.Failure) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Unsupported concurrent change during composition. A state object was &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;modified by composition as well as being modified outside composition.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="applyä¸­ä½¿ç”¨çš„applyobservers">applyä¸­ä½¿ç”¨çš„applyObservers<a class="hash-link" href="#applyä¸­ä½¿ç”¨çš„applyobservers" title="Direct link to heading">â€‹</a></h4><p>æˆ‘ä»¬å†è¿›å…¥<code>MutableSnapshot.apply</code> ä¸€æ¢ç©¶ç«Ÿï¼Œæ­¤æ—¶å°†å½“å‰ modified åœ¨ <code>snapshot.recordModified(state)</code> å·²ç»æ›´æ–°è¿‡äº†ï¼Œå¿˜è®°çš„è¯å¯ä»¥å›å¤´çœ‹çœ‹ï¼Œå‰é¢å·²ç»è®²è¿‡äº†ã€‚æ­¤æ—¶ä»ç„¶ä½¿ç”¨äº† <code>applyObservers</code> è¿›è¡Œéå†é€šçŸ¥ã€‚è¿™ä¸ª<code>applyObservers</code> å…¶å®æ˜¯ä¸ªé™æ€å˜é‡ï¼Œæ‰€ä»¥ä¸åŒçš„ GlobalSnapshot ä¸MutableSnapshot å¯ä»¥å…±äº«ï¼Œæ¥ä¸‹æ¥ä»ç„¶é€šè¿‡é¢„å…ˆè®¢é˜…å¥½çš„ <code>recompositionRunner</code> ç”¨æ¥å¤„ç† recompose è¿‡ç¨‹ï¼Œè¯¦è§ <a href="#applyobserversrecompositionrunne"><strong><em>applyObserversä¹‹recompositionRunner</em></strong></a>ï¼Œæ¥ä¸‹æ¥çš„recomposeæµç¨‹å°±å®Œå…¨ç›¸åŒäº†ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// androidx.compose.runtime.snapshots.Snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">open fun apply(): SnapshotApplyResult {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val modified = modified</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val (observers, globalModified) = sync {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        validateOpen(this)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (modified == null || modified.size == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            applyObservers.toMutableList() to globalModified</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (modified != null &amp;&amp; modified.isNotEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        observers.fastForEach {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            it(modified, this)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SnapshotApplyResult.Success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/milklabdev/jetpack-compose-book/tree/master/docs/principle/recomposeWorkingPrinciple.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/principle/snapshot"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">é€è¿‡ Snapshot çœ‹é‡ç»„</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/principle/gapBuffer"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Compose è¿è¡ŒåŸç†ä¸ GapBuffer</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#æ„ä¹‰" class="table-of-contents__link toc-highlight">æ„ä¹‰</a></li><li><a href="#recompose-æµç¨‹åˆ†æ" class="table-of-contents__link toc-highlight">recompose æµç¨‹åˆ†æ</a><ul><li><a href="#ä»-mutablestate-æ›´æ–°å¼€å§‹" class="table-of-contents__link toc-highlight">ä» MutableState æ›´æ–°å¼€å§‹</a></li><li><a href="#globalsnapshot-å†™å…¥é€šçŸ¥" class="table-of-contents__link toc-highlight">GlobalSnapshot å†™å…¥é€šçŸ¥</a></li><li><a href="#mutablesnapshot-å†™å…¥é€šçŸ¥" class="table-of-contents__link toc-highlight">MutableSnapshot å†™å…¥é€šçŸ¥</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ç¤¾åŒº</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/milklabdev" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Milk Lab, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8d46e49c.js"></script>
<script src="/assets/js/main.4fa214f8.js"></script>
</body>
</html>