<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">é€è¿‡ Snapshot çœ‹é‡ç»„ | ä½ å¥½ Compose</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://jetpackcompose.cn/docs/principle/snapshot"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="é€è¿‡ Snapshot çœ‹é‡ç»„ | ä½ å¥½ Compose"><meta data-react-helmet="true" name="description" content="Jetpack Compose å¼•å…¥äº†ä¸€ç§å¤„ç†å¯è§‚å¯ŸçŠ¶æ€çš„æ–°æ–¹æ³• â€”â€” Snapshotï¼ˆå¿«ç…§ï¼‰ã€‚åœ¨ Compose ä¸­æˆ‘ä»¬é€šè¿‡ state çš„å˜åŒ–æ¥è§¦å‘é‡ç»„ï¼Œé‚£ä¹ˆè¯·æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š"><meta data-react-helmet="true" property="og:description" content="Jetpack Compose å¼•å…¥äº†ä¸€ç§å¤„ç†å¯è§‚å¯ŸçŠ¶æ€çš„æ–°æ–¹æ³• â€”â€” Snapshotï¼ˆå¿«ç…§ï¼‰ã€‚åœ¨ Compose ä¸­æˆ‘ä»¬é€šè¿‡ state çš„å˜åŒ–æ¥è§¦å‘é‡ç»„ï¼Œé‚£ä¹ˆè¯·æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š"><link data-react-helmet="true" rel="icon" href="/img/logo.svg"><link data-react-helmet="true" rel="canonical" href="https://jetpackcompose.cn/docs/principle/snapshot"><link data-react-helmet="true" rel="alternate" href="https://jetpackcompose.cn/docs/principle/snapshot" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://jetpackcompose.cn/docs/principle/snapshot" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.cba56bc1.css">
<link rel="preload" href="/assets/js/runtime~main.b8d28577.js" as="script">
<link rel="preload" href="/assets/js/main.4a02c241.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Jetpack Compose åšç‰©é¦†</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/docs/open-source-project/compose-douban">å¼€æºé¡¹ç›®</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/compose-museum/jetpack-compose-book" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ğŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ğŸŒ</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">å†™åœ¨å¼€å¤´</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/å…¥é—¨">å…¥é—¨</a><button aria-label="Toggle the collapsible sidebar category &#x27;å…¥é—¨&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation">å®‰è£…æˆ–æ›´æ–° Android Studio</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial">åˆè¯† Jetpack Compose</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/elements/alertdialog">åŸºç¡€ç»„ä»¶</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/layout/box">å¸ƒå±€ç»„ä»¶</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/è®¾è®¡">è®¾è®¡</a><button aria-label="Toggle the collapsible sidebar category &#x27;è®¾è®¡&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/åŠ¨ç”»animation">åŠ¨ç”»ï¼ˆAnimationï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;åŠ¨ç”»ï¼ˆAnimationï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/ä¸»é¢˜theming">ä¸»é¢˜ï¼ˆThemingï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;ä¸»é¢˜ï¼ˆThemingï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/æ‰‹åŠ¿gesture">æ‰‹åŠ¿ï¼ˆGestureï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;æ‰‹åŠ¿ï¼ˆGestureï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/åˆ—è¡¨lists">åˆ—è¡¨ï¼ˆListsï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;åˆ—è¡¨ï¼ˆListsï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/category/å›¾å½¢graphics">å›¾å½¢ï¼ˆGraphicsï¼‰</a><button aria-label="Toggle the collapsible sidebar category &#x27;å›¾å½¢ï¼ˆGraphicsï¼‰&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/resources">èµ„æº</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/docs/category/æŠ€æœ¯åŸç†">æŠ€æœ¯åŸç†</a><button aria-label="Toggle the collapsible sidebar category &#x27;æŠ€æœ¯åŸç†&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/recompositionScope">äº†è§£ Compose çš„é‡ç»„ä½œç”¨åŸŸ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/principle/snapshot">é€è¿‡ Snapshot çœ‹é‡ç»„</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/recomposeWorkingPrinciple">é‡ç»„çš„å·¥ä½œæµç¨‹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/gapBuffer">Compose è¿è¡ŒåŸç†ä¸ GapBuffer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/modifierStructure">å›¾è§£ Modifier</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/composeAnnotation">Compose æ³¨è§£åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/principle/composeRemoteImage">å¦‚ä½•ä¸ºCompose Imageæä¾›ç½‘ç»œå›¾ç‰‡åŠ è½½æ”¯æŒ</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>é€è¿‡Snapshotçœ‹é‡ç»„</h1><p>Jetpack Compose å¼•å…¥äº†ä¸€ç§å¤„ç†å¯è§‚å¯ŸçŠ¶æ€çš„æ–°æ–¹æ³• â€”â€” <code>Snapshot</code>ï¼ˆå¿«ç…§ï¼‰ã€‚åœ¨ Compose ä¸­æˆ‘ä»¬é€šè¿‡ <code>state</code> çš„å˜åŒ–æ¥è§¦å‘é‡ç»„ï¼Œé‚£ä¹ˆè¯·æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ä¸ºä»€ä¹ˆ <code>state</code> å˜åŒ–èƒ½è§¦å‘é‡ç»„å‘¢ï¼Ÿ</li><li>å®ƒæ˜¯å¦‚ä½•ç¡®å®šé‡ç»„èŒƒå›´å‘¢ï¼Ÿ</li><li>åªè¦ <code>state</code> å˜åŒ–å°±ä¸€å®šä¼šé‡ç»„å—ï¼Ÿ  </li></ul><p>è®©æˆ‘ä»¬å¸¦ç€é—®é¢˜å»å­¦ä¹ ï¼</p><blockquote><p>æœ¬æ–‡éƒ¨åˆ†ä¾‹å­å’Œå†…å®¹æ¥è‡ªï¼š<a href="https://dev.to/zachklipp/introduction-to-the-compose-snapshot-system-19cn" target="_blank" rel="noopener noreferrer">Introduction to the Compose Snapshot system</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="snapshot-api">Snapshot API<a class="hash-link" href="#snapshot-api" title="Direct link to heading">â€‹</a></h2><blockquote><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¸éœ€è¦äº†è§£å¿«ç…§å¦‚ä½•ä½¿ç”¨ï¼Œè¿™äº›éƒ½æ˜¯æ¡†æ¶åº”è¯¥åšçš„äº‹æƒ…ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ“ä½œå¾ˆå¯èƒ½æå‡ºé—®é¢˜ã€‚æ‰€ä»¥è¿™é‡Œåªæ˜¯æ¼”ç¤ºå¿«ç…§çš„ä½¿ç”¨ï¼ˆä¸æ¶‰åŠåº•å±‚å®ç°ï¼‰ï¼Œè¿™æ ·æœ‰åŠ©äºç†è§£Composeé‡ç»„çš„æœºåˆ¶ã€‚</p></blockquote><p><code>Snapshot</code>(å¿«ç…§)ï¼Œç®€å•æ¯”å–»å°±æ˜¯ç»™æ‰€æœ‰ <code>state</code> æ‹äº†ä¸ªç…§ï¼Œå› æ­¤ä½ èƒ½è·å–åˆ°æ‹æ‘„ä¹‹å‰çš„çŠ¶æ€ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ä»£ç æ¼”ç¤ºæ¥çœ‹çœ‹ <code>Snapshot</code> åˆ°åº•æ˜¯åšä»€ä¹ˆçš„:
é¦–å…ˆå®šä¹‰ä¸€ä¸ª <code>Dog</code> ç±»,åŒ…å«ä¸€ä¸ª <code>state</code>:</p><div class="codeBlockContainer_I0IT language-Kotlin theme-code-block"><div class="codeBlockContent_wNvx Kotlin"><pre tabindex="0" class="prism-code language-Kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class Dog {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var name: MutableState&lt;String&gt; = mutableStateOf(&quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="åˆ›å»ºå¿«ç…§">åˆ›å»ºå¿«ç…§<a class="hash-link" href="#åˆ›å»ºå¿«ç…§" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_I0IT language-Kotlin theme-code-block"><div class="codeBlockContent_wNvx Kotlin"><pre tabindex="0" class="prism-code language-Kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  val dog = Dog()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dog.name.value = â€œSpotâ€</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val snapshot = Snapshot.takeSnapshot()  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dog.name.value = â€œFidoâ€</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  snapshot.enter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Fido</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Fido</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><ul><li><code>takeSnapshot()</code> å°†<code>&quot;æ‹æ‘„&quot;</code>ç¨‹åºä¸­æ‰€æœ‰ <code>State</code> å€¼çš„å¿«ç…§ï¼Œæ— è®ºå®ƒä»¬æ˜¯åœ¨ä½•å¤„åˆ›å»ºçš„</li><li><code>enter</code> å‡½æ•°ä¼šæŠŠå¿«ç…§çŠ¶æ€æ¢å¤å¹¶åº”ç”¨åˆ°å‡½æ•°ä½“ä¸­</li></ul><p>å› æ­¤æˆ‘ä»¬çœ‹åˆ°ä»…åœ¨ <code>enter</code> ä¸­æ˜¯æ—§å€¼ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="å¯å˜å¿«ç…§">å¯å˜å¿«ç…§<a class="hash-link" href="#å¯å˜å¿«ç…§" title="Direct link to heading">â€‹</a></h2><p>æˆ‘ä»¬å°è¯•åœ¨ <code>enter</code> å—ä¸­æ›´æ”¹ç‹—ç‹—çš„åå­—ï¼š</p><div class="codeBlockContainer_I0IT language-Kotlin theme-code-block"><div class="codeBlockContent_wNvx Kotlin"><pre tabindex="0" class="prism-code language-Kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val dog = Dog()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dog.name.value = &quot;Spot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val snapshot = Snapshot.takeSnapshot()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  snapshot.enter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dog.name.value = &quot;Fido&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.IllegalStateException: Cannot modify a state object in a read-only snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ä¼šå‘ç°å½“æˆ‘ä»¬å°è¯•ä¿®æ”¹å€¼æ—¶æŠ¥é”™äº†ï¼Œå› ä¸º <code>takeSnapshot()</code> æ˜¯åªè¯»çš„,å› æ­¤åœ¨ <code>enter</code> å†…éƒ¨æˆ‘ä»¬å¯ä»¥è¯»ä½†ä¸èƒ½å†™ï¼Œå¦‚æœæƒ³è¦åˆ›å»ºä¸€ä¸ªå¯å˜å¿«ç…§åº”ä½¿ç”¨ <code>takeMutableSnapshot()</code> æ–¹æ³•ã€‚</p><div class="codeBlockContainer_I0IT language-Kotlin theme-code-block"><div class="codeBlockContent_wNvx Kotlin"><pre tabindex="0" class="prism-code language-Kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val dog = Dog()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dog.name.value = &quot;Spot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val snapshot = Snapshot.takeMutableSnapshot()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  snapshot.enter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dog.name.value = &quot;Fido&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fido</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å¯ä»¥çœ‹åˆ°ç¨‹åºæ²¡æœ‰å´©æºƒäº†ï¼Œä½†æ˜¯åœ¨ <code>enter</code> é‡Œçš„æ“ä½œå¹¶æ²¡æœ‰åœ¨å…¶èŒƒå›´ä¹‹å¤–ç”Ÿæ•ˆï¼è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„éš”ç¦»æœºåˆ¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åº”ç”¨ <code>enter</code> å†…éƒ¨çš„å˜æ›´éœ€è¦è°ƒç”¨ <code>apply()</code> æ–¹æ³•ï¼š  </p><div class="codeBlockContainer_I0IT language-Kotlin theme-code-block"><div class="codeBlockContent_wNvx Kotlin"><pre tabindex="0" class="prism-code language-Kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> fun main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val dog = Dog()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dog.name.value = &quot;Spot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val snapshot = Snapshot.takeMutableSnapshot()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  snapshot.enter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dog.name.value = &quot;Fido&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  snapshot.apply()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fido</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fido </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨ <code>apply</code> ä¹‹åï¼Œæ–°å€¼åœ¨ <code>enter</code> ä¹‹å¤–ä¹Ÿç”Ÿæ•ˆäº†ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ <code>Snapshot.withMutableSnapshot()</code> æ¥ç®€åŒ–è°ƒç”¨ï¼š</p><div class="codeBlockContainer_I0IT language-Kotlin theme-code-block"><div class="codeBlockContent_wNvx Kotlin"><pre tabindex="0" class="prism-code language-Kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val dog = Dog()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dog.name.value = &quot;Spot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Snapshot.withMutableSnapshot {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dog.name.value = &quot;Fido&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬çŸ¥é“äº†ï¼š</p><ul><li>æ‹æ‘„æˆ‘ä»¬æ‰€æœ‰çŠ¶æ€çš„å¿«ç…§</li><li>â€œæ¢å¤â€çŠ¶æ€åˆ°ç‰¹å®šçš„ä»£ç å—</li><li>æ”¹å˜çŠ¶æ€å€¼</li></ul><p>ä½†æˆ‘ä»¬è¿˜ä¸çŸ¥é“å¦‚ä½•æ„ŸçŸ¥è¯»å†™ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬ææ¸…æ¥šè¿™ä¸ªã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="è§‚å¯Ÿè¯»å–å’Œå†™å…¥">è§‚å¯Ÿè¯»å–å’Œå†™å…¥<a class="hash-link" href="#è§‚å¯Ÿè¯»å–å’Œå†™å…¥" title="Direct link to heading">â€‹</a></h2><p>æ— è®ºæ˜¯ <code>LiveData</code>,<code>Flow</code> è¿˜æ˜¯ <code>State</code> éƒ½æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ï¼Œé‚£ä¹ˆå°±è¦æœ‰è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ã€‚å¯¹äºå¿«ç…§ç³»ç»Ÿï¼Œè¢«è§‚å¯Ÿè€…å°±æ˜¯æˆ‘ä»¬çš„ <code>state</code>ï¼Œè€Œè§‚å¯Ÿè€…æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯è¯»å–è§‚å¯Ÿè€…ï¼Œä¸€ä¸ªæ˜¯å†™å…¥è§‚å¯Ÿè€…ã€‚</p><p>å®é™…ä¸Š <code>takeMutableSnapshot</code>æœ‰ä¸¤ä¸ªå¯é€‰å‚æ•°çš„ï¼Œåˆ†åˆ«åœ¨è¯»å’Œå†™æ—¶å›è°ƒï¼š</p><div class="codeBlockContainer_I0IT language-Kotlin theme-code-block"><div class="codeBlockContent_wNvx Kotlin"><pre tabindex="0" class="prism-code language-Kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> fun takeMutableSnapshot(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            readObserver: ((Any) -&gt; Unit)? = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            writeObserver: ((Any) -&gt; Unit)? = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ): MutableSnapshot =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (currentSnapshot() as? MutableSnapshot)?.takeNestedMutableSnapshot(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                readObserver,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                writeObserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ) ?: error(&quot;Cannot create a mutable snapshot of an read-only snapshot&quot;)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å›è°ƒä¸­æ‰§è¡Œä¸€äº›æ“ä½œ,åœ¨ <code>Compose</code> ä¸­å°±æ˜¯å€¼è¯»å–æ—¶è®°å½• <code>ComposeScope</code>,å†™å…¥æ—¶å¦‚æœæœ‰å˜åŒ–åˆ™å°†å¯¹åº”çš„ <code>Scope</code> æ ‡è®°ä¸º <code>invalid</code>ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="å…¨å±€å¿«ç…§">å…¨å±€å¿«ç…§<a class="hash-link" href="#å…¨å±€å¿«ç…§" title="Direct link to heading">â€‹</a></h2><p>å…¨å±€å¿«ç…§æ˜¯ä½äºå¿«ç…§æ ‘æ ¹éƒ¨çš„å¯å˜å¿«ç…§ã€‚ä¸å¿…é¡» <code>apply</code> æ‰èƒ½ç”Ÿæ•ˆçš„å¸¸è§„å¯å˜å¿«ç…§ç›¸æ¯”ï¼Œå…¨å±€å¿«ç…§æ²¡æœ‰ <code>apply</code> æ“ä½œã€‚æ¯”å¦‚æˆ‘ä»¬ä¼šåœ¨ <code>ViewModel</code> é‡Œå®šä¹‰ <code>state</code>,å¹¶ä¸”åœ¨ <code>repository</code>è¯·æ±‚æ•°æ®å¹¶ç»™ <code>state</code> èµ‹å€¼ã€‚æ­¤æ—¶å°±ä¼šç”± GlobalSnapshot å»å‘é€é€šçŸ¥ï¼š</p><p>å®ƒé€šè¿‡è°ƒç”¨ï¼š</p><ul><li><code>Snapshot.notifyObjectsInitialized</code>ã€‚è¿™ä¼šä¸ºè‡ªä¸Šæ¬¡è°ƒç”¨ä»¥æ¥æ›´æ”¹çš„ä»»ä½•çŠ¶æ€å‘é€é€šçŸ¥ã€‚</li><li><code>Snapshot.sendApplyNotifications()</code>ã€‚è¿™ç±»ä¼¼äº notifyObjectsInitializedï¼Œä½†åªæœ‰åœ¨å®é™…å‘ç”Ÿæ›´æ”¹æ—¶æ‰ä¼šæ¨è¿›å¿«ç…§ã€‚åœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œåªè¦å°†ä»»ä½•å¯å˜å¿«ç…§åº”ç”¨äºå…¨å±€å¿«ç…§ï¼Œå°±ä¼šéšå¼è°ƒç”¨æ­¤å‡½æ•°ã€‚</li></ul><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">internal object GlobalSnapshotManager {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val started = AtomicBoolean(false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun ensureStarted() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (started.compareAndSet(false, true)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val channel = Channel&lt;Unit&gt;(Channel.CONFLATED)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CoroutineScope(AndroidUiDispatcher.Main).launch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.consumeEach {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Snapshot.sendApplyNotifications()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Snapshot.registerGlobalWriteObserver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.offer(Unit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å¯ä»¥çœ‹åˆ°åœ¨ <code>android</code> å¹³å°ä¸Šæ³¨å†Œäº† <code>writeObserver</code>,å®ƒè¿˜æœ‰ <code>ApplyObserver</code> æˆ‘ä»¬åé¢å†è¯´ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹<a class="hash-link" href="#å¤šçº¿ç¨‹" title="Direct link to heading">â€‹</a></h2><p>åœ¨ç»™å®šçº¿ç¨‹çš„å¿«ç…§ä¸­ï¼Œåœ¨åº”ç”¨è¯¥å¿«ç…§ä¹‹å‰ï¼Œä¸ä¼šçœ‹åˆ°å…¶ä»–çº¿ç¨‹å¯¹çŠ¶æ€å€¼æ‰€åšçš„æ›´æ”¹ã€‚å¿«ç…§ä¸å…¶ä»–å¿«ç…§â€œéš”ç¦»â€ã€‚åœ¨åº”ç”¨å¿«ç…§å¹¶è‡ªåŠ¨æ¨è¿›å…¨å±€å¿«ç…§ä¹‹å‰ï¼Œå¯¹å¿«ç…§å†…çš„çŠ¶æ€æ‰€åšçš„ä»»ä½•æ›´æ”¹å¯¹å…¶ä»–çº¿ç¨‹éƒ½å°†ä¸å¯è§ã€‚
çœ‹è¿™ä¸ªç±»åå¤§å®¶å°±æ‡‚äº† <code>SnapshotThreadLocal</code>:</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">internal actual class SnapshotThreadLocal&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val map = AtomicReference&lt;ThreadMap&gt;(emptyThreadMap)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val writeMutex = Any()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Suppress(&quot;UNCHECKED_CAST&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actual fun get(): T? = map.get().get(Thread.currentThread().id) as T?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actual fun set(value: T?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val key = Thread.currentThread().id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized(writeMutex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val current = map.get()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (current.trySet(key, value)) return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.set(current.newWith(key, value))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="å†²çª">å†²çª<a class="hash-link" href="#å†²çª" title="Direct link to heading">â€‹</a></h2><p>å¦‚æœæˆ‘ä»¬&quot;æ‹æ‘„&quot;äº†å¤šä¸ªå¿«ç…§å¹¶ä¸”å‡åº”ç”¨ä¿®æ”¹ä¼šæ€æ ·å‘¢ï¼Ÿ</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val dog = Dog()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dog.name.value = &quot;Spot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val snapshot1 = Snapshot.takeMutableSnapshot()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val snapshot2 = Snapshot.takeMutableSnapshot()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  snapshot1.enter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dog.name.value = &quot;Fido&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println(&quot;in snapshot1: &quot; + dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Donâ€™t apply it yet, letâ€™s try setting a third value first.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  snapshot2.enter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dog.name.value = &quot;Fluffy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println(&quot;in snapshot2: &quot; + dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Ok now we can apply both.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(&quot;before applying: &quot; + dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  snapshot1.apply()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(&quot;after applying 1: &quot; + dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  snapshot2.apply()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println(&quot;after applying 2: &quot; + dog.name.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in snapshot1: Fido</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in snapshot2: Fluffy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">before applying: Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">after applying 1: Fido</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">after applying 2: Fido</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ä¼šå‘ç°ç¬¬äºŒä¸ªå¿«ç…§çš„æ›´æ”¹æ— æ³•åº”ç”¨ï¼Œå› ä¸ºå®ƒä»¬éƒ½è§†å›¾ä»¥ç›¸åŒçš„åˆå§‹å€¼è¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤ç¬¬äºŒä¸ªå¿«ç…§è¦ä¹ˆå†æ‰§è¡Œä¸€æ¬¡ <code>enter</code>ï¼Œè¦ä¹ˆå‘Šè¯‰å¦‚ä½•è§£å†²çªã€‚  </p><p>Compose å®é™…ä¸Šæœ‰ä¸€ä¸ªç”¨äºè§£å†³åˆå¹¶å†²çªçš„ APIï¼<code>mutableStateOf()</code> éœ€è¦ä¸€ä¸ªå¯é€‰çš„ <code>SnapshotMutationPolicy</code>. è¯¥ç­–ç•¥å®šä¹‰äº†å¦‚ä½•æ¯”è¾ƒç‰¹å®šç±»å‹çš„å€¼ (equivalent) ä»¥åŠå¦‚ä½•è§£å†³å†²çª (merge)ã€‚å¹¶ä¸”æä¾›äº†ä¸€äº›å¼€ç®±å³ç”¨çš„ç­–ç•¥ï¼š</p><ul><li><code>structuralEqualityPolicy</code>â€“ ä½¿ç”¨å¯¹è±¡çš„ <code>equals</code> æ–¹æ³• ( ==)æ¯”è¾ƒå¯¹è±¡ï¼Œæ‰€æœ‰å†™å…¥éƒ½è¢«è®¤ä¸ºæ˜¯éå†²çªçš„ã€‚</li><li><code>referentialEqualityPolicy</code>â€“ é€šè¿‡å¼•ç”¨ ( ===)æ¯”è¾ƒå¯¹è±¡ï¼Œæ‰€æœ‰å†™å…¥éƒ½è¢«è®¤ä¸ºæ˜¯éå†²çªçš„ã€‚</li><li><code>neverEqualPolicy</code>â€“ å°†æ‰€æœ‰å¯¹è±¡è§†ä¸ºä¸ç›¸ç­‰ï¼Œæ‰€æœ‰å†™å…¥éƒ½è¢«è®¤ä¸ºæ˜¯éå†²çªçš„ã€‚</li></ul><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥æ„å»ºè‡ªå·±çš„è§„åˆ™ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class Dog {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var name: MutableState&lt;String&gt; =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mutableStateOf(&quot;&quot;, policy = object : SnapshotMutationPolicy&lt;String&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      override fun equivalent(a: String, b: String): Boolean = a == b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      override fun merge(previous: String, current: String, applied: String): String =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;$applied, briefly known as $current, originally known as $previous&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Same as before.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in snapshot1: Fido</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in snapshot2: Fluffy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">before applying: Spot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">after applying 1: Fido</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">after applying 2: Fluffy, briefly known as Fido, originally known as Spot</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="æ€»ç»“">æ€»ç»“<a class="hash-link" href="#æ€»ç»“" title="Direct link to heading">â€‹</a></h2><p>ä»¥ä¸Šå°±æ˜¯ <code>Snapshot</code> (å¿«ç…§)çš„åŸºæœ¬ä½¿ç”¨,å®ƒå°±ç›¸å½“äºé«˜çº§çš„ DiffUtilã€‚å®ƒçš„ç‰¹ç‚¹æ€»ç»“èµ·æ¥å°±æ˜¯ï¼š</p><ul><li>å“åº”å¼ï¼šæœ‰çŠ¶æ€çš„ä»£ç å§‹ç»ˆè‡ªåŠ¨ä¿æŒæœ€æ–°ã€‚æˆ‘ä»¬æ— éœ€æ‹…å¿ƒè®¢é˜…å’Œåè®¢é˜…ã€‚</li><li>éš”ç¦»æ€§ï¼šæœ‰çŠ¶æ€ä»£ç å¯ä»¥å¯¹çŠ¶æ€è¿›è¡Œæ“ä½œï¼Œè€Œä¸å¿…æ‹…å¿ƒåœ¨ä¸åŒçº¿ç¨‹ä¸Šè¿è¡Œçš„ä»£ç ä¼šæ”¹å˜è¯¥çŠ¶æ€ã€‚<code>Compose</code> å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥å®ç°æ—§çš„ <code>View</code> ç³»ç»Ÿæ— æ³•å®ç°çš„æ•ˆæœï¼Œä¾‹å¦‚å°†é‡æ„æ”¾åˆ°å¤šä¸ªåå°çº¿ç¨‹ä¸Šå»æ‰§è¡Œã€‚</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="è§£æƒ‘">è§£æƒ‘<a class="hash-link" href="#è§£æƒ‘" title="Direct link to heading">â€‹</a></h2><ul><li><strong>ä¸ºä»€ä¹ˆ<code>state</code>å˜åŒ–èƒ½è§¦å‘é‡ç»„å‘¢ï¼Ÿ</strong><blockquote><p>Jetpack Composeåœ¨æ‰§è¡Œæ—¶æ³¨å†Œäº† <code>readObserverOf</code> å’Œ<code>writeObserverOf</code> :</p></blockquote></li></ul><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> private inline fun &lt;T&gt; composing(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        composition: ControlledComposition,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modifiedValues: IdentityArraySet&lt;Any&gt;?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        block: () -&gt; T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ): T {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val snapshot = Snapshot.takeMutableSnapshot(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            readObserverOf(composition), writeObserverOf(composition, modifiedValues)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return snapshot.enter(block)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            applyAndCheck(snapshot)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å…¶ä¸­åœ¨è¯»å–çŠ¶æ€çš„åœ°æ–¹ä¼šæ‰§è¡Œï¼š</p><ul><li><code>readObserverOf</code> æ¥è®°å½•å“ªäº› <code>scope ä½¿ç”¨äº†æ­¤ </code>state` :</li></ul><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> override fun recordReadOf(value: Any) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!areChildrenComposing) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            composer.currentRecomposeScope?.let {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                it.used = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                observations.add(value, it)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li><code>writeObserverOf</code>
è€Œå†™å…¥æ—¶ä¼šæ‰¾å‡ºå¯¹åº”ä½¿ç”¨æ­¤ <code>state</code> çš„ <code>scope</code> ä½¿å…¶ <code>invalidate</code> :</li></ul><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> override fun recordWriteOf(value: Any) = synchronized(lock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        invalidateScopeOfLocked(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        derivedStates.forEachScopeOf(value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            invalidateScopeOfLocked(it)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private fun invalidateScopeOfLocked(value: Any) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          observations.forEachScopeOf(value) { scope -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (scope.invalidateForResult(value) == InvalidationResult.IMMINENT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                observationsProcessed.add(value, scope)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>åœ¨ä¸‹æ¬¡å¸§ä¿¡å·åˆ°è¾¾æ—¶å¯¹äºè¿™äº›<code>scope</code>æ‰§è¡Œé‡ç»„ã€‚</p><ul><li><strong>å®ƒæ˜¯å¦‚ä½•ç¡®å®šé‡ç»„èŒƒå›´å‘¢ï¼Ÿ</strong></li></ul><blockquote><p>èƒ½å¤Ÿè¢«æ ‡è®°ä¸º Invalid çš„ä»£ç å¿…é¡»æ˜¯é inline ä¸”æ— è¿”å›å€¼çš„ @Composalbe function/lambdaï¼Œå¿…é¡»éµå¾ª é‡ç»„èŒƒå›´æœ€å°åŒ– åŸåˆ™ã€‚
è¯¦ç»†å‚è§ï¼š<a href="/docs/principle/recompositionScope/">Compose å¦‚ä½•ç¡®å®šé‡ç»„èŒƒå›´</a></p></blockquote><ul><li><strong>åªè¦ <code>state</code> å˜åŒ–å°±ä¸€å®šä¼šé‡ç»„å—ï¼Ÿ</strong><br>ä¸ä¸€å®šï¼Œå…·ä½“æ¡ˆä¾‹è¯·çœ‹ä»¥ä¸‹ä¾‹å­ï¼š</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-ä¾‹å­">1. ä¾‹å­â‘ <a class="hash-link" href="#1-ä¾‹å­" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    val darkMode = mutableStateOf(&quot;hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onCreate(savedInstanceState: Bundle?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.onCreate(savedInstanceState)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setContent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lifecycleScope.launch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                delay(100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                val text= darkMode.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                darkMode.value = &quot;Compose&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ä¸ä¼šé‡ç»„ï¼Œå› ä¸º <code>delay</code> å¯¼è‡´çŠ¶æ€çš„è¯»å–æ˜¯åœ¨ <code>snap.apply</code> æ–¹æ³•ä¹‹å¤–æ‰§è¡Œçš„,
å› æ­¤ä¹Ÿå°±ä¸ä¼šæ³¨å†Œ <code>readObserverOf</code> ,è‡ªç„¶ä¹Ÿå°±ä¸ä¼šä¸ <code>composeScope</code> æŒ‚é’©ï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘é‡ç»„ï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œå¦‚æœæ˜¯åœ¨ <code>delay</code> ä¹‹å‰è¯»å–åˆ™ä¼šé‡ç»„ã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-ä¾‹å­">2. ä¾‹å­â‘¡<a class="hash-link" href="#2-ä¾‹å­" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">   val darkMode = mutableStateOf(&quot;hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onCreate(savedInstanceState: Bundle?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.onCreate(savedInstanceState)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setContent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                val text =  darkMode.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                darkMode.value = &quot;Compose&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>thread</code> ä¸­çš„<code>state</code>åœ¨ä¸åŒçº¿ç¨‹è¯»å–ï¼Œç”±äº<code>SnapshotThreadLocal</code>æœºåˆ¶ï¼Œå¦‚æœæ­¤çº¿ç¨‹æ— å¿«ç…§ï¼Œåˆ™è·å–<code>GlobalSnapshot</code>ï¼š</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">internal fun currentSnapshot(): Snapshot =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadSnapshot.get() ?: currentGlobalSnapshot.get()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ç”±äºæ²¡æœ‰å¯¹åº”çš„<code>readObserver</code>,å› æ­¤æ­¤ä¾‹å­ä¸ä¼šé‡ç»„ã€‚ä½†æ˜¯å¦‚æœåœ¨<code>composable</code>å†…è¯»å–äº†æ­¤<code>state</code>æ˜¯ä¼šé‡ç»„çš„ï¼Œå› ä¸º<code>ReComposer</code>æ³¨å†Œäº†<code>ApplyObserver</code>,åœ¨<code>apply</code>æ—¶ä¹Ÿä¼šå¯¹<code>globalModified</code>è¿›è¡Œè®°å½•ï¼Œåœ¨ä¸‹ä¸€å¸§ä¿¡å·åˆ°è¾¾æ—¶å»æŸ¥æ‰¾å¯¹åº”çš„<code>scope</code>ï¼ˆå¤§å®¶å¯ä»¥æ–­ç‚¹è·Ÿä¸€ä¸‹æµç¨‹ï¼‰ï¼š</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> val unregisterApplyObserver = Snapshot.registerApplyObserver { changed, _ -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                synchronized(stateLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (_state.value &gt;= State.Idle) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        snapshotInvalidations += changed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        deriveStateLocked()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }?.resume(Unit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-ä¾‹å­">3. ä¾‹å­â‘¢<a class="hash-link" href="#3-ä¾‹å­" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">override fun onCreate(savedInstanceState: Bundle?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.onCreate(savedInstanceState)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setContent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val darkMode = mutableStateOf(&quot;hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Text(darkMode.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            darkMode.value = &quot;Compose&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>è¿™ä¸ªä¹Ÿæ²¡è§¦å‘é‡ç»„ï¼Œå¯èƒ½å¤§å®¶ä¼šç–‘æƒ‘ï¼Œè¿™ä¸ªæ²¡å¼‚æ­¥ï¼Œæ–­ç‚¹ä¹Ÿæœ‰ <code>readObserver</code> å’Œ <code>writeObserver</code> ä¸ºå•¥ä¸ä¼šè§¦å‘é‡ç»„å‘¢ï¼Ÿ  ä¸æ˜¯è¯´çŠ¶æ€å˜æ›´ä¼šå°†ä½¿ç”¨å®ƒçš„ <code>scope</code> è®°ä¸º <code>invalid</code> å—ï¼Ÿ</p><p>ç„¶è€Œå®é™…è¿è¡Œä¸­ï¼Œ<code>InvalidationResult</code>ä¸º<code>IGNORE</code></p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> fun invalidate(scope: RecomposeScopeImpl, instance: Any?): InvalidationResult {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (anchor == null || !slotTable.ownsAnchor(anchor) || !anchor.valid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // The scope has not yet entered the composition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return InvalidationResult.IGNORED </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>é¦–å…ˆæˆ‘ä»¬ç¡®å®è®°å½•ä¸‹äº†ä½¿ç”¨ <code>state</code> çš„ <code>scope</code>,ä¸ç„¶ä¹Ÿä¸ä¼šåœ¨ä¿®æ”¹æ—¶è§¦å‘ <code>invalidate</code> è¡Œä¸ºã€‚ä½†æ­¤æ—¶ <code>slotTable</code> é‡Œå¹¶è¿˜æ²¡æœ‰å¯é‡ç»„çš„åŒºåŸŸé”šç‚¹ä¿¡æ¯ï¼Œåªæœ‰åœ¨ç»„åˆå®Œæˆä¹‹åæ‰èƒ½æ‹¿åˆ°æ¯ä¸ªåŒºåŸŸçš„é”šç‚¹<code> anchors</code>ã€‚
ç®€å•æè¿°å°±æ˜¯ <code>Compose</code> ä½¿ç”¨ <code>SlotTable</code> æ¥è®°å½•æ•°æ®ä¿¡æ¯ï¼Œæ­¤æ—¶ç¬¬ä¸€æ¬¡å®Œæ•´çš„ç»„åˆéƒ½æ²¡å®Œæˆï¼Œä¸çŸ¥é“è¯¥ä»å“ªä¸‹æ‰‹ã€‚  </p><blockquote><p>æœ‰å…³ <code>SlotTable</code> çš„æ›´å¤šä¿¡æ¯è¯·å‚é˜…ï¼š<a href="https://juejin.cn/post/6889797083667267598" target="_blank" rel="noopener noreferrer">æ·±å…¥è¯¦è§£JetpackCompose|å®ç°åŸç†</a></p></blockquote><p>å…¶æ¬¡å°±æ˜¯ç”±äº <code>state</code> çš„åˆ›å»ºæ˜¯åœ¨ <code>enter</code> ä»£ç å—ä¸­ï¼Œæ­¤æ—¶ <code>state.snapshotId</code>==<code>Snapshot.id</code> ,å¹¶ä¸ä¼šè®°å½• <code>state</code> çš„å˜åŒ–ã€‚æ¯•ç«Ÿå¿«ç…§çš„ <code>diff</code> æ˜¯ä½œç”¨åœ¨ä¸¤ä¸ªå¿«ç…§ä¹‹é—´ã€‚</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">internal fun &lt;T : StateRecord&gt; T.overwritableRecord(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state: StateObject,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snapshot: Snapshot,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    candidate: T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): T {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val id = snapshot.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ­¤æ—¶ç›´æ¥è¿”å›ï¼Œå¹¶æ²¡æœ‰è®°å½•stateå˜åŒ–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (candidate.snapshotId == id) return candidate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ä½†æ˜¯å¦‚æœä½ æŠŠ <code>state</code> çš„åˆ›å»ºæ”¾åˆ° <code>setContent</code> ä¹‹å¤–å‘¢ï¼Ÿ</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-ä¾‹å­">4. ä¾‹å­â‘£<a class="hash-link" href="#4-ä¾‹å­" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  val darkMode = mutableStateOf(&quot;hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onCreate(savedInstanceState: Bundle?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.onCreate(savedInstanceState)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setContent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Text(darkMode.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            darkMode.value = &quot;Compose&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>ç­”æ¡ˆæ˜¯ä¼šé‡ç»„</strong>  </p><p>å› ä¸ºè¿™ä¸ªçŠ¶æ€æ˜¯åœ¨æ‹æ‘„ä¹‹å‰åˆ›å»ºçš„ï¼Œæ­¤æ—¶ <code>state.snapshotId</code>!=<code>Snapshot.id</code>,æ­¤æœŸé—´å¯¹ <code>state</code> çš„ä¿®æ”¹è™½ç„¶ä¸ä¼šç«‹å³æ ‡è®°ä¸º <code>invalid</code> ,ä½†æ˜¯ä¼šè®¡å…¥  <code>modified</code> , <code>apply</code> ä¹‹åï¼Œç”±å…¨å±€å¿«ç…§è¿›è¡Œé€šçŸ¥:</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">internal fun &lt;T : StateRecord&gt; T.overwritableRecord(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state: StateObject,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snapshot: Snapshot,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    candidate: T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): T {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val id = snapshot.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (candidate.snapshotId == id) return candidate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val newData = newOverwritableRecord(state, snapshot)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newData.snapshotId = id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   //è®°å½•å˜åŒ–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snapshot.recordModified(state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return newData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ä¼šåœ¨ <code>apply</code> æ—¶é€šçŸ¥åˆ°è§‚å¯Ÿè€… <code>ApplyObserver</code>ï¼ˆåˆšæ‰è¿˜æåˆ° writerObserver ï¼‰ï¼Œè®°å½•ä¸‹ <code>changed</code>:</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">val unregisterApplyObserver = Snapshot.registerApplyObserver { changed, _ -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                synchronized(stateLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (_state.value &gt;= State.Idle) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        snapshotInvalidations += changed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        deriveStateLocked()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }?.resume(Unit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>composation</code> åˆ™ä¼šæ‰¾å‡ºè§‚å¯Ÿäº†å¯¹åº”å˜åŒ–çŠ¶æ€çš„ <code>scope</code> æ ‡è®°ä¸º <code>invalid</code> ç­‰å¾…é‡ç»„ï¼š  </p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> private fun addPendingInvalidationsLocked(values: Set&lt;Any&gt;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var invalidated: HashSet&lt;RecomposeScopeImpl&gt;? = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fun invalidate(value: Any) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            observations.forEachScopeOf(value) { scope -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    !observationsProcessed.remove(value, scope) &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    scope.invalidateForResult(value) != InvalidationResult.IGNORED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    val set = invalidated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ?: HashSet&lt;RecomposeScopeImpl&gt;().also {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            invalidated = it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    set.add(scope)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (value in values) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (value is RecomposeScopeImpl) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                value.invalidateForResult(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                invalidate(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                derivedStates.forEachScopeOf(value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    invalidate(it)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        invalidated?.let {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            observations.removeValueIf { scope -&gt; scope in it }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="5-ä¾‹å­">5. ä¾‹å­â‘¤<a class="hash-link" href="#5-ä¾‹å­" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">var onlyDisplay = mutableStateOf(&quot;onlyDisplay&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MainActivity : ComponentActivity() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onCreate(savedInstanceState: Bundle?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.onCreate(savedInstanceState)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setContent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Text(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                text = onlyDisplay.value,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fontSize = 50.sp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            onlyDisplay.value = &quot;Display&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å¦‚æœæŠŠ <code>state</code> å£°æ˜æ”¾åˆ° <code>kt</code> æ–‡ä»¶æœ€å¤–å±‚ï¼Œæ˜¯å¦ä¼šé‡ç»„ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸ºåœ¨ <code>kotlin</code> ä¸­å¦‚æœæŠŠå˜é‡ä¸æ”¾åˆ°ç±»é‡Œï¼Œç›´æ¥æ”¾åˆ°æ–‡ä»¶é¡¶å±‚ã€‚ç¼–è¯‘ä¹‹åå…¶å®ä¼šç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œè¿™ä¸ªå±æ€§åˆ™å˜æˆ <code>static</code> çš„ã€‚</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">public final class MainActivityKt {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       static MutableState&lt;String&gt; onlyDisplay = SnapshotStateKt.mutableStateOf$default(&quot;onlyDisplay&quot;, null, 2, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å› æ­¤è¿™ä¸ªä¾‹å­å°±æ¶‰åŠäº†ç±»çš„åˆå§‹åŒ–é—®é¢˜ï¼š</p><blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="åªæœ‰ä¸»åŠ¨è¯·æ±‚ä¸€ä¸ªç±»è¿™ä¸ªç±»æ‰ä¼šåˆå§‹åŒ–ä»…åŒ…å«é™æ€å˜é‡å‡½æ•°ç­‰é™æ€çš„ä¸œè¥¿">åªæœ‰ä¸»åŠ¨è¯·æ±‚ä¸€ä¸ªç±»,è¿™ä¸ªç±»æ‰ä¼šåˆå§‹åŒ–,ä»…åŒ…å«é™æ€å˜é‡,å‡½æ•°,ç­‰é™æ€çš„ä¸œè¥¿.<a class="hash-link" href="#åªæœ‰ä¸»åŠ¨è¯·æ±‚ä¸€ä¸ªç±»è¿™ä¸ªç±»æ‰ä¼šåˆå§‹åŒ–ä»…åŒ…å«é™æ€å˜é‡å‡½æ•°ç­‰é™æ€çš„ä¸œè¥¿" title="Direct link to heading">â€‹</a></h2><p>ä¹Ÿå°±æ˜¯è¯´åœ¨è¿™ä¸ªä¾‹å­é‡Œåªæœ‰åœ¨è°ƒç”¨ <code>onlyDisplay</code> æ—¶ï¼Œæ‰æ‰§è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥å…¶ <code>state.snapshotId==snapshot.Id</code> ,æ­¤æ—¶é¦–æ¬¡ç»„åˆå°šæœªæ‰§è¡Œå®Œæ¯•ï¼Œæœ¬æ¬¡çš„ <code>invalidateResult==IGNORE</code>ï¼Œä¹Ÿä¸ä¼šè®°ä¸º <code>modified</code>ï¼Œå°±å’Œä¾‹å­â‘¢ ä¸€æ ·çš„é—®é¢˜äº†ã€‚</p></blockquote><hr><blockquote><p>ä»¥ä¸Šå°±æ˜¯å¿«ç…§ç³»ç»Ÿçš„ä½¿ç”¨å’Œ<code> Jetpack Compose</code> é‡ç»„çš„æœºåˆ¶ï¼Œæœ‰ä»»ä½•ä¸æ­£ç¡®çš„åœ°æ–¹æ¬¢è¿æŒ‡æ­£ã€‚</p></blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/compose-museum/jetpack-compose-book/tree/master/docs/principle/snapshot.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/principle/recompositionScope"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">äº†è§£ Compose çš„é‡ç»„ä½œç”¨åŸŸ</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/principle/recomposeWorkingPrinciple"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">é‡ç»„çš„å·¥ä½œæµç¨‹</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#snapshot-api" class="table-of-contents__link toc-highlight">Snapshot API</a></li><li><a href="#åˆ›å»ºå¿«ç…§" class="table-of-contents__link toc-highlight">åˆ›å»ºå¿«ç…§</a></li><li><a href="#å¯å˜å¿«ç…§" class="table-of-contents__link toc-highlight">å¯å˜å¿«ç…§</a></li><li><a href="#è§‚å¯Ÿè¯»å–å’Œå†™å…¥" class="table-of-contents__link toc-highlight">è§‚å¯Ÿè¯»å–å’Œå†™å…¥</a></li><li><a href="#å…¨å±€å¿«ç…§" class="table-of-contents__link toc-highlight">å…¨å±€å¿«ç…§</a></li><li><a href="#å¤šçº¿ç¨‹" class="table-of-contents__link toc-highlight">å¤šçº¿ç¨‹</a></li><li><a href="#å†²çª" class="table-of-contents__link toc-highlight">å†²çª</a></li><li><a href="#æ€»ç»“" class="table-of-contents__link toc-highlight">æ€»ç»“</a></li><li><a href="#è§£æƒ‘" class="table-of-contents__link toc-highlight">è§£æƒ‘</a><ul><li><a href="#1-ä¾‹å­" class="table-of-contents__link toc-highlight">1. ä¾‹å­â‘ </a></li><li><a href="#2-ä¾‹å­" class="table-of-contents__link toc-highlight">2. ä¾‹å­â‘¡</a></li><li><a href="#3-ä¾‹å­" class="table-of-contents__link toc-highlight">3. ä¾‹å­â‘¢</a></li><li><a href="#4-ä¾‹å­" class="table-of-contents__link toc-highlight">4. ä¾‹å­â‘£</a></li><li><a href="#5-ä¾‹å­" class="table-of-contents__link toc-highlight">5. ä¾‹å­â‘¤</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ç¤¾åŒº</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/compose-museum" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Jetpack Compose åšç‰©é¦†, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b8d28577.js"></script>
<script src="/assets/js/main.4a02c241.js"></script>
</body>
</html>