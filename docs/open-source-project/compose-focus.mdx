![å®æˆ˜Composeâ€”â€”åšä¸ªç®€æ´å´ä¸ç®€å•çš„æ˜Ÿçƒæ‰“å¡App](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/221a137e94094f78ac108199872a9aa1~tplv-k3u1fbpfcp-zoom-crop-mark:1304:1304:1304:734.awebp?)

# Focus

> Focusæ˜¯ä¸€æ¬¾å¸®åŠ©ä½ é›†ä¸­çš„appâ€”â€”ä¸ºè‡ªå·±çš„ç›®æ ‡å»ºç«‹æ˜Ÿçƒï¼Œå°†æ—¶é—´æŠ•å…¥åœ¨ä¸Šé¢ã€‚èŠ±åœ¨æ˜Ÿçƒä¸Šçš„æ¯ä¸€åˆ†é’Ÿéƒ½ä¼šè¢«è®°å½•ï¼Œæ¯é¢—æ˜Ÿçƒå¯ä»¥å®šåˆ¶é¢œè‰²ä¸å¤–è§‚ã€‚ä¸ºäº†è´¯å½»ç®€å•å¹²å‡€ä¸è®©äººåˆ†å¿ƒçš„è®¾è®¡ç†å¿µï¼Œappé‡‡ç”¨ç™½ç°ä¸ºä¸»è‰²è°ƒã€‚ä¸ºäº†ä¸ä½¿ç•Œé¢æ˜¾å¾—å•è°ƒï¼Œæ‰€ä»¥å¢åŠ äº†ä¸å°‘çš„åŠ¨ç”»ã€‚å¦‚æœæ‚¨è§‰å¾—è¿˜å¯ä»¥ï¼Œå¸Œæœ›ğŸ™æ‚¨èƒ½ç‚¹ä¸ªStar!!!! [ComposeFocus]([github.com/Watermelon0â€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FWatermelon02%2FComposeFocus))

## é¢„è§ˆ

å…ˆçœ‹çœ‹ç›®å‰çš„æ‰€æœ‰åŠŸèƒ½æ€»çš„é¢„è§ˆå§ï¼Œä½¿ç”¨æµç¨‹ä¸»è¦å°±æ˜¯ï¼š

1. `åˆ›å»ºæ˜Ÿçƒç•Œé¢`è®¾ç½®æ˜Ÿçƒåå­—ï¼Œæ‰“å¡æ—¶é—´å’Œè¯¦ç»†æè¿°
2. `æ˜Ÿçƒåˆ—è¡¨ç•Œé¢`é€‰ä¸­è¦æ‰“å¡çš„æ˜Ÿçƒ
3. `ä¸»ç•Œé¢`è®¾ç½®è¦æ‰“å¡çš„æ—¶é—´ï¼Œå¼€å§‹æ‰“å¡

![img](https://picture-1307392056.cos.ap-nanjing.myqcloud.com/1651511878919.gif)

## åŠŸèƒ½

### ä¸»ç•Œé¢

- **å·¦å³æ»‘åŠ¨** è®¾ç½®å€’è®¡æ—¶æ—¶é—´
- **é•¿æŒ‰æ˜Ÿçƒ** å½“å«æ˜Ÿæ¶ˆå¤±å†å‡ºç°å¹¶å¼€å§‹é€†æ—¶é’ˆè½¬åŠ¨çš„æ—¶å€™å¼€å§‹è®¡æ—¶ã€‚æ‰“å¡çš„æ—¶é•¿ä¼šè¢«è®°å½•è¿›å¯¹åº”çš„æ˜Ÿçƒä¸­

![img](https://picture-1307392056.cos.ap-nanjing.myqcloud.com/1651562261764.gif)

### æ˜Ÿçƒåˆ—è¡¨ç•Œé¢

> **åŒå‡»æ˜Ÿçƒ** è¿›å…¥æ˜Ÿçƒåˆ—è¡¨ç•Œé¢

- **ä¸Šæ‹‰æ˜Ÿçƒ** æ˜¾ç¤ºæ˜Ÿçƒé¢œè‰²çš„æ¸å˜èƒŒæ™¯ï¼Œå†ç‚¹å‡»å¯ä»¥åˆ é™¤æ˜Ÿçƒ
- **å·¦å³æ»‘åŠ¨** æŸ¥çœ‹å·²æœ‰æ˜Ÿçƒ
- **ä¸Šæ»‘ç•Œé¢** æŸ¥çœ‹æ˜Ÿçƒè¯¦ç»†ä¿¡æ¯
- **ç‚¹å‡»âœ¨** é€‰ä¸­å½“å‰æ˜Ÿçƒä¸ºè¦æ‰“å¡çš„æ˜Ÿçƒ

![img](https://picture-1307392056.cos.ap-nanjing.myqcloud.com/1651562374424.gif)

### æ–°å»ºæ˜Ÿçƒç•Œé¢

> **ç‚¹å‡»** æ˜Ÿçƒåˆ—è¡¨ç•Œé¢çš„æœ€åä¸€ä¸ªå¸¦åŠ å·çš„æ˜Ÿçƒè¿›å…¥æ–°å»ºæ˜Ÿçƒç•Œé¢

- **é¢œè‰²é€‰æ‹©** é€‰ä¸­æ–°æ˜Ÿçƒçš„é¢œè‰²ï¼Œè¿™äº›é¢œè‰²æŒ‰é’®ä¹Ÿåšäº†æ¸å˜çš„åŠ¨ç”»
- **æ—¶é—´é€‰æ‹©** æ²¡å•¥å¥½è¯´çš„
- **ç‚¹å‡»âœ¨** åˆ›å»ºæ˜Ÿçƒ

![img](https://picture-1307392056.cos.ap-nanjing.myqcloud.com/1651562434323.gif)

## ä¸»è¦å®ç°

### æ¶æ„

- MVI

> MVIç›¸æ¯”MVVMæ›´åŠ å¼ºè°ƒ`æ•°æ®çš„å•å‘æµåŠ¨`å’Œ`å”¯ä¸€æ•°æ®æº`ï¼Œé¡¹ç›®ä¸­å°†ç”¨æˆ·æ‰€æœ‰çš„æ“ä½œåŒ…è£…ä¸ºAction,ä¼ å…¥åˆ°ç•Œé¢å¯¹åº”çš„ViewModelä¸­è¿›è¡Œå¤„ç†ï¼Œåœ¨ViewModelä¸­å¯¹ç•Œé¢çš„çŠ¶æ€è¿›è¡Œç»Ÿä¸€é›†ä¸­ç®¡ç†ã€‚è€ŒUIå±‚åˆ™è®¢é˜…ViewState,å½“ç•Œé¢çŠ¶æ€å˜åŒ–æ—¶ï¼ŒComposeå‡½æ•°ä¼šè‡ªåŠ¨è¿›è¡Œæ›´æ–°

![img](https://picture-1307392056.cos.ap-nanjing.myqcloud.com/84ED106B-EDEA-495F-9652-0BF51BD4CD07.png)

```kotlin
//å°†stateçš„setterè®¾ç½®ä¸ºç§æœ‰ï¼Œä½¿çŠ¶æ€åªèƒ½åœ¨dispatch()ä¸­ä¿®æ”¹ï¼Œä¿è¯æ•°æ®åªèƒ½å•å‘ä¿®æ”¹
var mainPageViewStates by mutableStateOf(MainPageViewState())
    private set
    
//ä¸»ç•Œé¢ViewModelä¸­ç»Ÿä¸€å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†
fun dispatch(action: MainPageAction) {
    when (action) {
        is MainPageAction.DegreeUpdate -> degreeUpdate(action.degree)
        is MainPageAction.SelectStar -> selectStar(action.todoStar)
        is MainPageAction.StarChanged -> mainPageViewStates.starChanged.value = false
        is MainPageAction.NewStarPage -> mainPageViewStates.sheetPage.value =
            BottomSheetPage.NewStarPage
        is MainPageAction.BackToStarList -> mainPageViewStates.sheetPage.value =
            BottomSheetPage.StarListPage
        is MainPageAction.AddStar -> mainPageViewStates.addStar.value = true
        is MainPageAction.RefreshStar -> mainPageViewStates.refreshStarList.value++
        is MainPageAction.CountdownStart->countDownStart()
        is MainPageAction.Countdown -> countDown()
        is MainPageAction.InitSelectedStar -> initSelectedStar()
    }
    
//ç•Œé¢äº‹ä»¶çš„å¯†å°ç±»
sealed class MainPageAction {
    class DegreeUpdate(val degree: Float) : MainPageAction()
    .......
    }

}

å¤åˆ¶ä»£ç 
```

- ä¾èµ–æ³¨å…¥

é€šè¿‡ä½¿ç”¨`Hilt`æ¥å¯¹ViewModelå’ŒRoomæ•°æ®åº“çš„Daoè¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œå¯ä»¥éå¸¸ç®€å•åœ°å®ç°è§£è€¦

```kotlin
//ä¸ºViewModelåŠ ä¸Š@HiltViewModeæ³¨è§£
@HiltViewModel
class NewStarViewModel constructor() : ViewModel() {...}
//ç„¶åç›´æ¥åœ¨Composableå‡½æ•°çš„å‚æ•°ä¸­ä½¿ç”¨hiltViewModel()è¿›è¡Œä¾èµ–æ³¨å…¥
@Composable
fun NewStarPage(
    ...
    viewModel: NewStarViewModel = hiltViewModel()
) {...}


å¤åˆ¶ä»£ç 
```

- æ•°æ®å­˜å‚¨

ç›´æ¥ä½¿ç”¨`Room`æ•°æ®åº“æ¥è¿›è¡Œå­˜å‚¨ï¼ŒåŒæ—¶ï¼ŒRoomæ•°æ®åº“æ”¯æŒç›´æ¥è¿”å›`Flow`ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ä½¿ç”¨åç¨‹é…åˆFlowæ¥è·å–æŸ¥è¯¢ç»“æœ

```kotlin
//åˆ·æ–°æ˜Ÿçƒåˆ—è¡¨æ•°æ®ï¼Œä½¿ç”¨Flowæ¥è·å–è¿”å›ç»“æœ
private fun refreshStarList() {
    viewModelScope.launch {
        starDao.queryAllStar().collect {
            if (it.isNotEmpty()){
                starListPageStates.starList.value = it
            }
        }
    }
}
å¤åˆ¶ä»£ç 
```

### ç•Œé¢

- `å£°æ˜å¼`å’Œ`æ‰‹åŠ¿api`

Composeçš„`å£°æ˜å¼`å†™æ³•å’Œä¸€äº›`æ‰‹åŠ¿api`è®©è®¸å¤šæ§ä»¶å®ç°èµ·æ¥æ›´ä¸ºç®€å•ã€‚ æ¯”å¦‚é¡¹ç›®ä¸»ç•Œé¢ä¸­çš„æ˜Ÿçƒå€’è®¡æ—¶æ—¶é’Ÿï¼Œè¿™ä¸ªæ—¶é’Ÿæ—¢éœ€è¦èƒ½å¤Ÿå¤„ç†ç”¨æˆ·çš„æ‰‹æŒ‡æ»‘åŠ¨æ¥è®¾ç½®å€’è®¡æ—¶æ—¶é—´ï¼Œè¿˜éœ€è¦èƒ½å¤Ÿåœ¨ç”¨æˆ·é•¿æŒ‰ä¹‹åå¼€å§‹å€’è®¡æ—¶ã€‚

åœ¨åŸå…ˆä½¿ç”¨è‡ªå®šä¹‰viewå®ç°çš„æ—¶å€™ï¼Œéœ€è¦é‡å†™å…¶`onTouchEvent()`,æ‰‹åŠ¨è®¡ç®—å‰åä¸¤æ¬¡æ‰‹æŒ‡ç§»åŠ¨è·ç¦»ï¼Œç„¶åæ—‹è½¬viewï¼Œå¹¶å›è°ƒç»™æ—¶é’ŸViewè®¾ç½®çš„æ¥å£æ¥æ›´æ–°å€’è®¡æ—¶çš„æ—¶é—´ï¼Œç„¶åå†å°†æ›´æ–°åçš„æ—¶é—´ä¼ é€’ç»™ä¸Šæ–¹çš„TextViewã€‚é•¿æŒ‰äº‹ä»¶å¤„ç†èµ·æ¥åŒæ ·éœ€è¦ç»è¿‡ç±»ä¼¼çš„æ­¥éª¤ã€‚

è€Œä½¿ç”¨composeåˆ™åªéœ€è¦ä¸€ä¸ªè®°å½•æ»‘åŠ¨åº¦æ•°çš„stateï¼Œç„¶åå°†è¿™ä¸ªstateä¼ å…¥`æ‰‹åŠ¿(Gesture)api`ä¸­ã€‚è¿™æ ·composeå°±ä¼šè‡ªåŠ¨æ›´æ–°stateçš„æ•°å€¼ï¼Œè€Œå…¶å®ƒä½¿ç”¨è¯¥stateä½œä¸ºå‚æ•°çš„composeå‡½æ•°ä¹Ÿèƒ½è‡ªåŠ¨é‡ç»„ã€‚

- `LazyRow&LazyPage`

`LazyRow`å’Œ`LazyPage`ç±»ä¼¼äºRecyclerView,ä½†æ˜¯ä¸éœ€è¦å†å»å†™adapterï¼ŒlayoutManagerç­‰ï¼Œè€Œä¸”å¯ä»¥æ–¹ä¾¿çš„å°†ä¸åŒç±»å‹çš„itemæ‹¼æ¥åœ¨ä¸€èµ·ï¼Œä¸éœ€è¦å®ç°RecyclerViewConcatAdapteræˆ–æ˜¯è®¾ç½®ViewHolderä¸­ä¸åŒçš„viewTypeã€‚(ä½†æ˜¯å¥½åƒç›®å‰æ€§èƒ½ä¸å¦‚RV

```kotlin
LazyRow(modifier = Modifier
    .fillMaxHeight(0.35f)
    .fillMaxWidth(), content = {
    //å·²åˆ›å»ºæ˜Ÿçƒåˆ—è¡¨
    for (star in starList) {item {...}}
    //æ–°å¢æ˜ŸçƒItem,ç‚¹å‡»è¿›å…¥æ–°å¢æ˜Ÿçƒç•Œé¢
    item {
        NewStarItem (...)
    }
})
å¤åˆ¶ä»£ç 
```

- åŠ¨ç”»

composeä¸­è‡ªå¸¦ä¸å°‘å¼ºå¤§çš„ã€å¯æ‰©å±•çš„åŠ¨ç”» APIï¼Œå¯ä»¥è½»æ¾çš„å®ç°ä¸€äº›æ•ˆæœã€‚æ¯”å¦‚â€”â€”â€”â€” `AnimatedVisibility()`é…åˆ`ModalBottomSheetLayout()`å®ç°ä¼¸ç¼©åˆ—è¡¨ï¼š

```kotlin
//starçš„è¯¦ç»†èµ„æ–™,å¼€å§‹éšè—ï¼Œå½“modalBottomSheetå±•å¼€æ—¶å‡ºç°
AnimatedVisibility(visible = sheetState.currentValue == ModalBottomSheetValue.Expanded) {
    Card(
        shape = RoundedCornerShape(20.dp),
        modifier = Modifier
            .fillMaxHeight(0.7f)
            .fillMaxWidth(),
    ) {...}
}
å¤åˆ¶ä»£ç 
```

![img](https://picture-1307392056.cos.ap-nanjing.myqcloud.com/1651573977400.gif)

å†æ¯”å¦‚`InfiniteTransition`å®ç°çš„åŠ¨æ€æ¸å˜Button (åˆ é™¤æ˜ŸçƒæŒ‰é’®ï¼š

```kotlin
@Composable
fun DeleteButton(color: Color, onClick: () -> Unit) {
    val colorAnimation1 by rememberInfiniteTransition().animateColor(
        initialValue = color.copy(alpha = 0.35f),
        targetValue = color.copy(alpha = 0.75f),
        animationSpec = InfiniteRepeatableSpec(
            animation = tween(
                durationMillis = 4750 + 500 * color.alpha.toInt(),
                easing = FastOutLinearInEasing,
                delayMillis = 2730 * color.alpha.toInt()
            ),
            repeatMode = RepeatMode.Reverse
        )
    )
    val colorAnimation2 by rememberInfiniteTransition().animateColor(ç±»ä¼¼ä¸Šé¢çš„å®ç°)
    Card(
        modifier = Modifier
            .padding(start = 10.dp, top = 20.dp, end = 10.dp)
            .height(200.dp)
            .width(175.dp),
        shape = RoundedCornerShape(20.dp)
    ) {
        IconButton(onClick = onClick) {
            Canvas(modifier = Modifier
                .padding(start = 10.dp, top = 40.dp, end = 10.dp)
                .height(170.dp)
                .width(175.dp), onDraw = {
                //æ¸å˜è‰²å—
                drawCircle(
                    brush = Brush.linearGradient(
                        colors = listOf(
                            colorAnimation2,
                            colorAnimation1
                        ),
                        start = Offset(0f,0f),end = Offset(400.dp.value,400.dp.value),
                    ),
                    radius = 300.dp.value,
                    center = Offset(x = size.width / 2, y = size.height / 2)
                )
            })
        }
    }
}
å¤åˆ¶ä»£ç 
```

![img](https://picture-1307392056.cos.ap-nanjing.myqcloud.com/1651573171050.gif)

- è‡ªå®šä¹‰ç»˜åˆ¶

è¿™æ–¹é¢æ„Ÿè§‰å’ŒåŸç”Ÿçš„å†™æ³•å¤§åŒå°å¼‚ï¼Œè€Œè‡ªå®šä¹‰å¸ƒå±€è¿˜æ²¡æ¥å¾—åŠäº†è§£ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†

## æ€»ç»“

é¦–æ¬¡ä¸Šæ‰‹Composeå’ŒMVI,é¡¹ç›®ä¸­çš„å®ç°å¯èƒ½æœ‰ä¸å°çš„é—®é¢˜ã€‚Composeåœ¨å®ç°è®¸å¤šç•Œé¢å…ƒç´ çš„æ—¶å€™æ„Ÿè§‰æ¯”Viewè¦æ›´åŠ ç®€å•é«˜æ•ˆï¼Œä½†æ˜¯ç”¨åˆ°çš„è®¸å¤šapiéƒ½å¸¦æœ‰å®éªŒæ€§æ³¨è§£ã€‚è€Œä¸”ç›®å‰composeçš„æ•™ç¨‹ä¸æ˜¯å¾ˆå¤šï¼Œåœ¨é‡åˆ°é—®é¢˜çš„æ—¶å€™ä¸å¤ªå¥½è§£å†³ã€‚

å› ä¸ºæ—¶é—´é™åˆ¶æ‰€ä»¥è¿˜æœ‰å¾ˆå¤šæƒ³è¦å®ç°çš„åŠŸèƒ½æ²¡æ¥å¾—åŠåšï¼Œä¸å‡ºæ„å¤–çš„è¯ä¹‹åä¼šç»§ç»­ä¿®æ”¹bugå’Œå¢åŠ åŠŸèƒ½ã€‚æœ€åå†æ¬¡å¸Œæœ›æ‚¨èƒ½å¤Ÿç»™ä¸ªç‚¹ä¸ªStar!!!! [ComposeFocus]([github.com/Watermelon0â€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FWatermelon02%2FComposeFocus))