---
id: compose-moon-animation
title: Compose å®ç°æœˆäº®é˜´æ™´åœ†ç¼ºåŠ¨ç”»
---
import image1 from '@site/static/img/open-source-project/compose-moon-animation/image_1.webp';
import image2 from '@site/static/img/open-source-project/compose-moon-animation/image_2.webp';
import image3 from '@site/static/img/open-source-project/compose-moon-animation/image_3.webp';

## æ•ˆæœå›¾
<img src={image1} width="80%" align="center" alt=""/>       

> äººæœ‰æ‚²æ¬¢ç¦»åˆï¼Œæœˆæœ‰é˜´æ™´åœ†ç¼ºï¼Œæ­¤äº‹å¤éš¾å…¨ã€‚              
> ä½†æ„¿äººé•¿ä¹…ï¼Œåƒé‡Œå…±å©µå¨Ÿã€‚             
> æ°é€¢ä¸­ç§‹ä½³èŠ‚ï¼Œæˆ‘ä»¬ä»Šå¤©å°±ä½¿ç”¨ `Compose` æ¥å®ç°ä¸€ä¸‹æœˆç›¸å˜åŒ–åŠ¨ç”»å§~          
> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹ä¸ª`Star` : [Compose å®ç°æœˆäº®é˜´æ™´åœ†ç¼ºåŠ¨ç”»](https://github.com/shenzhen2017/ComposeMoon)     

## ä¸»è¦æ€è·¯
### æ»¡å¤©ç¹æ˜Ÿ
ä¸ºäº†å®ç°æœˆç›¸åŠ¨ç”»ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ä¸ªèƒŒæ™¯ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¥½çœ‹çš„æ˜Ÿç©ºï¼Œæœ€å¥½è¿˜æœ‰é—ªçƒçš„æ•ˆæœ       
ä¸ºä¸ºå®ç°æ˜Ÿç©ºèƒŒæ™¯ï¼Œæˆ‘ä»¬éœ€è¦åšä»¥ä¸‹å‡ ä»¶äº‹       
1. ç»˜åˆ¶èƒŒæ™¯       
2. ç”Ÿæˆå‡ åä¸ªæ˜Ÿæ˜Ÿï¼Œåœ¨èƒŒæ™¯ä¸Šéšæœºåˆ†å¸ƒ   
3. é€šè¿‡ `scale` ä¸ `alpha` åŠ¨ç”»ï¼Œå®ç°æ¯ä¸ªæ˜Ÿæ˜Ÿçš„é—ªçƒæ•ˆæœ    

æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹ä»£ç    
```kotlin
@Composable
fun Stars(starNum: Int) {
    BoxWithConstraints(modifier = Modifier.fillMaxSize()) {
        val list = remember { mutableStateListOf<Star>() }
        LaunchedEffect(true) {
            for (i in 0..starNum) {
                delay(100L)
                //æ·»åŠ æ˜Ÿæ˜Ÿï¼Œå®ƒä»¬çš„ä½ç½®åœ¨å±å¹•ä¸Šéšæœº
                list.add(Star(maxWidth.value * density, maxHeight.value * density))
            }
        }
        list.forEach {
            Star(it)
        }
    }
}

@Composable
fun Star(star: Star) {
    var progress: Float by remember { mutableStateOf(0f) }
    val infiniteTransition = rememberInfiniteTransition()
    .... 
    star.updateStar(progress) // é€šè¿‡åŠ¨ç”»æ›´æ–° progress,ä»è€Œæ›´æ–° star çš„å±æ€§å€¼
    Canvas(modifier = Modifier.wrapContentSize()) {
        scale(star.scale, Offset(star.x, star.y)) { // ç¼©æ”¾åŠ¨ç”»
            drawCircle(
                star.starColor,
                star.radius,
                center = Offset(star.x, star.y),
                alpha = star.alpha // alpha åŠ¨ç”»
            )
        }
    }
}
```

### æœˆç›¸å˜åŒ–
æœˆç›¸ï¼Œå¤©æ–‡å­¦æœ¯è¯­ã€‚ï¼ˆ`phase of the moon`ï¼‰æ˜¯å¤©æ–‡å­¦ä¸­å¯¹äºåœ°çƒä¸Šçœ‹åˆ°çš„æœˆçƒè¢«å¤ªé˜³ç…§æ˜éƒ¨åˆ†çš„ç§°å‘¼ã€‚éšç€æœˆäº®æ¯å¤©åœ¨æ˜Ÿç©ºä¸­è‡ªä¸œå‘è¥¿ç§»åŠ¨ä¸€å¤§æ®µè·ç¦»ï¼Œå®ƒçš„å½¢çŠ¶ä¹Ÿåœ¨ä¸æ–­åœ°å˜åŒ–ç€ï¼Œè¿™å°±æ˜¯æœˆäº®ä½ç›¸å˜åŒ–ï¼Œå«åšæœˆç›¸ã€‚       
å®ƒçš„å˜åŒ–è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º    
![](https://raw.githubusercontents.com/shenzhen2017/resource/main/2021/september/p5.jpeg)     
æ¯ä¸ªé˜¶æ®µéƒ½æœ‰å„è‡ªçš„åå­—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![](https://raw.githubusercontents.com/shenzhen2017/resource/main/2021/september/p6.jpeg)     

å¯ä»¥çœ‹å‡ºï¼Œæœˆç›¸å˜åŒ–è¿‡ç¨‹è¿˜æ˜¯æœ‰äº›å¤æ‚çš„ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆå®ç°è¿™ä¸ªæ•ˆæœå‘¢ï¼Ÿ       

#### æ€è·¯åˆ†æ
ä¸ºäº†å®ç°æœˆç›¸å˜åŒ–,é¦–å…ˆæˆ‘ä»¬éœ€è¦ç”»ä¸€ä¸ªåœ†ï¼Œä»£è¡¨æœˆäº®ï¼Œæœ€ç»ˆçš„æ»¡æœˆå…¶å®å°±æ˜¯è¿™æ ·ï¼Œæ¯”è¾ƒç®€å•      
æœ‰äº†æ»¡æœˆï¼Œå¦‚ä½•åœ¨å®ƒçš„åŸºç¡€ä¸Šï¼Œç”»å‡ºå…¶å®ƒçš„æœˆç›¸å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡å›¾åƒæ··åˆæ¨¡å¼æ¥å®ç°       

å›¾åƒæ··åˆæ¨¡å¼å®šä¹‰çš„æ˜¯ï¼Œå½“ä¸¤ä¸ªå›¾åƒåˆæˆæ—¶ï¼Œå›¾åƒæœ€ç»ˆçš„å±•ç¤ºæ–¹å¼ã€‚åœ¨ `Androd` ä¸­ï¼Œæœ‰ç›¸åº”çš„ `API` æ¥å£æ¥æ”¯æŒå›¾åƒæ··åˆæ¨¡å¼ï¼Œå³ `Xfermode`.          
å›¾åƒæ··åˆæ¨¡å¼ä¸»è¦æœ‰ä»¥ä¸‹16ç§,ä»¥ä¸‹è¿™å¼ å›¾ç‰‡ä»ä¸€å®šç¨‹åº¦ä¸Šå½¢è±¡åœ°è¯´æ˜äº†å›¾åƒæ··åˆçš„ä½œç”¨ï¼Œä¸¤ä¸ªå›¾å½¢ä¸€åœ†ä¸€æ–¹é€šè¿‡ä¸€å®šçš„è®¡ç®—äº§ç”Ÿä¸åŒçš„ç»„åˆæ•ˆæœï¼Œå…·ä½“å¦‚ä¸‹         
<img src={image2} width="80%" align="center" alt=""/>      

æˆ‘ä»¬ä¸ºäº†å®ç°æœˆç›¸åŠ¨ç”»ï¼Œä¸»è¦éœ€è¦ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§æ··åˆæ¨¡å¼    
- `DST_OUT`:åªåœ¨æºå›¾åƒå’Œç›®æ ‡å›¾åƒä¸ç›¸äº¤çš„åœ°æ–¹ç»˜åˆ¶ã€ç›®æ ‡å›¾åƒã€‘ï¼Œåœ¨ç›¸äº¤çš„åœ°æ–¹æ ¹æ®æºå›¾åƒçš„ `alpha` è¿›è¡Œè¿‡æ»¤ï¼Œæºå›¾åƒå®Œå…¨ä¸é€æ˜åˆ™å®Œå…¨è¿‡æ»¤ï¼Œå®Œå…¨é€æ˜åˆ™ä¸è¿‡æ»¤    
- `DST_OVER`:å°†ç›®æ ‡å›¾åƒæ”¾åœ¨æºå›¾åƒä¸Šæ–¹

æˆ‘ä»¬å·²ç»äº†è§£äº†å›¾å½¢æ··åˆæ¨¡å¼ï¼Œé‚£ä¹ˆéœ€è¦åœ¨æ»¡æœˆä¸Šç”»ä»€ä¹ˆæ‰èƒ½å®ç°å…¶å®ƒæ•ˆæœå‘¢?      
æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨æ»¡æœˆä¸Šæ”¾ä¸€ä¸ªåŠåœ†`+`ä¸€ä¸ªæ¤­åœ†æ¥å®ç°     
<img src={image3} width="80%" align="center" alt=""/>      
1. å¦‚ä¸Šæ‰€ç¤ºï¼Œæ¤­åœ†ä¸Šæ°´å¹³çš„çº¿å«é•¿è½´ï¼Œç«–ç›´çš„çº¿å«çŸ­è½´      
2. çŸ­è½´ä¸å˜ï¼Œé•¿è½´åŠå¾„ä»0åˆ°æ»¡æœˆåŠå¾„å‘ç”Ÿå˜åŒ–ï¼Œå†åŠ ä¸Šä¸€ä¸ªåŠåœ†ï¼Œå°±å¯ä»¥å®ç°ä¸åŒçš„æœˆç›¸     
3. æ¯”å¦‚ä¸ºäº†ç”»ä¸Šè›¾çœ‰æœˆï¼Œå¯ä»¥é€šè¿‡å·¦åŠè¾¹ç”»åŠåœ†ï¼Œå†åŠ ä¸Šä¸€ä¸ªæ¤­åœ†ï¼Œä¸¤éƒ½éƒ½ä½¿ç”¨ `DST_OVER` æ··åˆæ¨¡å¼æ¥å®ç°ï¼Œå°±å®ç°äº†å®ƒä»¬ä¸¤çš„å¹¶é›†ï¼Œç„¶åè¦†ç›–åœ¨ä¸‹å±‚æ»¡æœˆä¸Šï¼Œå°±å®ç°äº†ä¸Šè›¾çœ‰æœˆ               
4. ä¸ºäº†ç”»æ¸ç›ˆå‡¸æœˆ,åˆ™åŒæ ·å°±å·¦åŠè¾¹ä»¥ `DST_OVER` ç”»åŠåœ†,å†ä»¥ `DST_OUT` ç”»æ¤­åœ†ï¼Œå°±åªå‰©ä¸‹åŠåœ†ä¸æ¤­åœ†ä¸ç›¸äº¤çš„éƒ¨åˆ†ï¼Œå†ä¸ä¸‹å±‚çš„æ»¡æœˆæ··åˆï¼Œå°±å®ç°äº†æ¸ç›ˆå‡¸æœˆ        

è¿™æ ·è¯´å¯èƒ½è¿˜æ˜¯æ¯”è¾ƒæŠ½è±¡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä¸‹è½½æºç è¯¦ç»†äº†è§£ä¸‹   

#### æºç å®ç°
```kotlin
//æœˆäº®åŠ¨ç”»æ§ä»¶
@Composable
fun Moon(modifier: Modifier) {
    var progress: Float by remember { mutableStateOf(0f) }
    BoxWithConstraints(modifier = modifier) {
        Canvas(
            modifier = Modifier
                .size(canvasSize)
                .align(Alignment.TopCenter)
        ) {
            drawMoonCircle(this, progress)
            drawIntoCanvas {
                it.withSaveLayer(Rect(0f, 0f, size.width, size.height), paint = Paint()) {
                    if (progress != 1f) {
                    	//å¿…é¡»å…ˆç”»åŠåœ†ï¼Œå†ç”»æ¤­åœ†
                        drawMoonArc(this, it, paint, progress)
                        drawMoonOval(this, it, paint, progress)
                    }
                }
            }
        }
    }
}

// 1.é¦–å…ˆç”»ä¸€ä¸ªæ»¡æœˆ
private fun drawMoonCircle(scope: DrawScope, progress: Float) {
	//....
    drawCircle(Color(0xfff9dc60))
}

// 3. ç”»åŠåœ†
private fun drawMoonArc(scope: DrawScope, canvas: Canvas, paint: Paint, progress: Float) {
    val sweepAngle = when { //ä»æ–°æœˆåˆ°æ»¡æœˆåœ¨ä¸€è¾¹ç”»åŠåœ†ï¼Œä»æ»¡æœˆå›åˆ°æ–°æœˆåˆ™åœ¨å¦ä¸€è¾¹ç”»åŠåœ†
        progress <= 0.5f -> 180f
        progress <= 1f -> 180f
        progress <= 1.5f -> -180f
        else -> -180f
    }
    paint.blendMode = BlendMode.DstOver //åŠåœ†çš„æ··åˆæ¨¡å¼å§‹ç»ˆæ˜¯DstOver
    scope.run {
        canvas.drawArc(Rect(0f, 0f, size.width, size.height), 90f, sweepAngle, false, paint)
    }
}

// 2. ç”»æ¤­åœ†
private fun drawMoonOval(scope: DrawScope, canvas: Canvas, paint: Paint, progress: Float) {
    val blendMode = when { //æ¤­åœ†çš„æ··åˆæ¨¡å¼ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸‹
        progress <= 0.5f -> BlendMode.DstOver
        progress <= 1f -> BlendMode.DstOut
        progress <= 1.5f -> BlendMode.DstOut
        else -> BlendMode.DstOver
    }
    paint.blendMode = blendMode
    scope.run {
        canvas.drawOval(
            Rect(offset = topLeft, size = Size(horizontalAxis, verticalAxis)), //æ¤­åœ†çš„é•¿è½´ä¼šéšç€åŠ¨ç”»å˜åŒ–
            paint = paint
        )
    }
}
```
å¦‚ä¸Šæ‰€ç¤º:   
1. ä¸»è¦å°±æ˜¯3ä¸ªæ­¥éª¤ï¼Œç”»æ»¡æœˆï¼Œå†ç”»åŠåœ†ï¼Œå†ç”»æ¤­åœ†    
2. åŠåœ†çš„æ··åˆæ¨¡å¼å§‹ç»ˆæ˜¯ `DstOver`,è€Œæ¤­åœ†çš„æ··åˆæ¨¡å¼ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå®ƒä»¬çš„é¢œè‰²éƒ½æ˜¯é»‘è‰²ã€‚     
3. å¯ä»¥çœ‹åˆ°åŠåœ†ä¸æ¤­åœ†æ–°å»ºäº†ä¸€ä¸ª `Layer`ï¼Œæ··åˆæ¨¡å¼çš„å˜åŒ–ï¼Œè¡¨ç¤ºçš„å°±æ˜¯æœ€åå‰©ä¸‹çš„æ˜¯å®ƒä»¬çš„å¹¶é›†ï¼Œè¿˜æ˜¯ `Dst` ä¸ç›¸äº¤çš„éƒ¨åˆ†ï¼Œæœ€åè¦†ç›–åˆ°æ»¡æœˆä¸Šï¼Œæ‰€ä»¥å¿…é¡»å…ˆç”»åŠåœ†     
4. éšç€åŠ¨ç”»çš„å˜åŒ–ï¼Œæ¤­åœ†çš„é•¿è½´ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°ä¸åŒçš„æœˆç›¸    

### è¯—æ­Œæ‰“å­—æœºæ•ˆæœ
ä¸Šé¢å…¶å®å·²ç»åšå¾—å·®ä¸å¤šäº†ï¼Œæˆ‘ä»¬æœ€åå†æ·»åŠ ä¸€äº›è¯—æ­Œï¼Œå¹¶ä¸ºå®ƒä»¬æ·»åŠ æ‰“å­—æœºæ•ˆæœ      
```kotlin
@Composable
fun PoetryColumn(
    list: List<Char>,
    offsetX: Float = 0f,
    offsetY: Float = 0f
) {
    val targetList = remember { mutableStateListOf<Char>() }
    LaunchedEffect(list) {
        targetList.clear()
        list.forEach {
            delay(500) //é€šè¿‡åœ¨LaunchedEffectä¸­delayå®ç°åŠ¨ç”»æ•ˆæœ
            targetList.add(it)
        }
    }
    //å°† Jetpack Compose ç¯å¢ƒçš„ Paint å¯¹è±¡è½¬æ¢ä¸ºåŸç”Ÿçš„ Paint å¯¹è±¡
    val textPaint = Paint().asFrameworkPaint().apply {
        //...
    }
    Canvas(modifier = Modifier.wrapContentSize()) {
        drawIntoCanvas {
            for (i in targetList.indices) {
                it.nativeCanvas.drawText(list[i].toString(), x, y, textPaint)
                y += delta // æ›´æ–°æ–‡å­—yè½´ä½ç½®
            }
        }
    }
}
```
å¦‚ä¸Šæ‰€ç¤ºï¼Œä»£ç æ¯”è¾ƒç®€å•   
1. é€šè¿‡åœ¨ `LaunchedEffect` ä¸­è°ƒç”¨æŒ‚èµ·å‡½æ•°ï¼Œæ¥å®ç°åŠ¨ç”»æ•ˆæœ    
2. ä¸ºäº†å®ç°ç«–ç›´æ–¹å‘çš„æ–‡å­—ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ `Paint` æ¥ç»˜åˆ¶ `Text`ï¼Œè€Œä¸èƒ½ä½¿ç”¨ `Text` ç»„ä»¶   
3. `Compose` ç›®å‰è¿˜ä¸æ”¯æŒç›´æ¥ç»˜åˆ¶ `Text`ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒç”¨ `asFrameworkPaint` å°†å…¶è½¬åŒ–ä¸ºåŸç”Ÿçš„ `Paint`

## æ€»ç»“
é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬å°±é€šè¿‡ `Compose` å®ç°äº†æœˆç›¸é˜´æ™´åœ†ç¼º+æ˜Ÿç©ºé—ªè€€+è¯—æ­Œæ‰“å­—æœºçš„åŠ¨ç”»æ•ˆæœ     
å¼€å‘èµ·æ¥è·Ÿ `Android` è‡ªå®šä¹‰ç»˜åˆ¶å…¶å®å¹¶æ²¡æœ‰å¤šå¤§å·®åˆ«ï¼Œä»£ç é‡å› ä¸º `Compose` å¼ºå¤§çš„ `API` ä¸å£°æ˜å¼ç‰¹ç‚¹å¯èƒ½è¿˜æœ‰æ‰€å‡å°‘       
åœ¨æˆ‘çœ‹æ¥ï¼Œ`Compose` å·²ç»ç›¸å½“æˆç†Ÿäº†ï¼Œè€Œä¸”å°†æ˜¯ `Android UI` çš„æœªæ¥~     

å¼€æºä¸æ˜“ï¼Œå¦‚æœé¡¹ç›®å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµ,`Star`,æ”¶è—~        
### å‚è€ƒèµ„æ–™
[è¹­ä¸­ç§‹çƒ­åº¦æ¥äº†~Android è‡ªå®šä¹‰Viewâ€”â€”æœˆæœ‰é˜´æ™´åœ†ç¼º](https://juejin.cn/post/7006142194230755341)       
[ã€Œå¯’è‰çš„ä¸­ç§‹çŒ®ç¤¼ğŸ¥®ï¼Œå®ç°30så‰ç«¯åˆ›æ„åŠ¨ç”»ã€é™ªä½ çœ‹æ—¥è½å’Œæœˆå‡ï½œä¸ä½ èµæ˜Ÿç©ºå’Œè¯—æ­Œ](https://juejin.cn/post/7005355142413287438)    

### é¡¹ç›®åœ°å€
[Compose å®ç°æœˆäº®é˜´æ™´åœ†ç¼ºåŠ¨ç”»](https://github.com/shenzhen2017/ComposeMoon)
